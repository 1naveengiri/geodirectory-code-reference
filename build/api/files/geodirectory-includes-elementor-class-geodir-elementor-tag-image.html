<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Geodirectory Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1652336158">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1652336158">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.png" alt="WPGeodirectory" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">Geodirectory Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/elementorpro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/elementorpro-modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Geodirectory.html"><abbr title="\Geodirectory">Geodirectory</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectory.html"><abbr title="\GeoDirectory">GeoDirectory</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/GeoDirectory-Templates.html"><abbr title="\GeoDirectory\Templates">Templates</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAbstracts.html"><abbr title="\GeoDirectoryAbstracts">GeoDirectoryAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAPI.html"><abbr title="\GeoDirectoryAPI">GeoDirectoryAPI</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClasses.html"><abbr title="\GeoDirectoryClasses">GeoDirectoryClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminFunctions.html"><abbr title="\GeoDirectoryAdminFunctions">GeoDirectoryAdminFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoruAdmin.html"><abbr title="\GeoDirectoruAdmin">GeoDirectoruAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdmin.html"><abbr title="\GeoDirectoryAdmin">GeoDirectoryAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirAdmin.html"><abbr title="\GeoDirAdmin">GeoDirAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectroyAdmin.html"><abbr title="\GeoDirectroyAdmin">GeoDirectroyAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminSystemStatus.html"><abbr title="\GeoDirectoryAdminSystemStatus">GeoDirectoryAdminSystemStatus</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminTools.html"><abbr title="\GeoDirectoryAdminTools">GeoDirectoryAdminTools</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminWidgets.html"><abbr title="\GeoDirectoryAdminWidgets">GeoDirectoryAdminWidgets</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesEmails.html"><abbr title="\GeoDirectoryClassesEmails">GeoDirectoryClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesData.html"><abbr title="\GeoDirectoryClassesData">GeoDirectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDIrectoryClassesData.html"><abbr title="\GeoDIrectoryClassesData">GeoDIrectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/ElementorPro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/ElementorPro-Modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryFunctions.html"><abbr title="\GeoDirectoryFunctions">GeoDirectoryFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryparamarraytermsAnarrayoftermobjects.html"><abbr title="\GeoDirectoryparamarraytermsAnarrayoftermobjects">GeoDirectoryparamarraytermsAnarrayoftermobjects</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WP.html"><abbr title="\WP">WP</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WP-Background.html"><abbr title="\WP\Background">Background</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryTemplates.html"><abbr title="\GeoDirectoryTemplates">GeoDirectoryTemplates</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-geodir-elementor-tag-image.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit;
}

/**
 * Add text field options to the dynamic tags.
 *
 * @since 2.0.0.81
 * Class GeoDir_Elementor_Tag_Image
 */
Class GeoDir_Elementor_Tag_Image extends Elementor\Core\DynamicTags\Data_Tag {

	/**
	 * Get the type name.
	 *
	 * @return string
	 */
	public function get_name() {
		return &#039;gd-image&#039;;
	}

	/**
	 * Get the title for the tag type.
	 *
	 * @return string
	 */
	public function get_title() {
		return &#039;GD &#039; . __( &#039;Image Field&#039;, &#039;geodirectory&#039; );
	}

	/**
	 * What group should this be added to.
	 *
	 * @return string
	 */
	public function get_group() {
		return &#039;geodirectory&#039;;
	}

	/**
	 * What categories should this be added to.
	 *
	 * @return array
	 */
	public function get_categories() {
		return [
			\Elementor\Modules\DynamicTags\Module::IMAGE_CATEGORY,
		];

	}

	/**
	 * Render the tag output.
	 */
//	public function render() {
//
//		global $gd_post;
//echo &#039;####&#039;;exit;
//		$value = &#039;&#039;;
//		$key = $this-&gt;get_settings( &#039;key&#039; );
//		$fallback = $this-&gt;get_settings( &#039;fallback_url&#039; );
//		if ( !empty( $key ) ) {
//			if(isset($gd_post-&gt;{$key})){
//				$cf = geodir_get_field_infoby(&#039;htmlvar_name&#039;, $key, $gd_post-&gt;post_type);
//				$field_type = !empty($cf[&#039;field_type&#039;]) ? esc_attr($cf[&#039;field_type&#039;]) : &#039;&#039;;
//
//				// maybe add special url types
//				if($field_type == &#039;phone&#039;){
//					$value .= &quot;tel:&quot;;
//				}elseif($field_type == &#039;email&#039;){
//					$value .= &quot;mailto:&quot;;
//				}
//
//				$value = esc_url_raw($value . $gd_post-&gt;{$key});
//			}else{
//				$value = esc_url_raw($fallback);
//			}
//
//			echo  $value ;
//		}
//	}

	public function get_value( array $options = [] ) {
		global $gd_post;
		
		$key = $this-&gt;get_settings( &#039;key&#039; );

		$image_data = [
			&#039;id&#039; =&gt; null,
			&#039;url&#039; =&gt; &#039;&#039;,
		];

		if(substr( $key, 0, 9 ) === &quot;category_&quot;){
			$image_data = $this-&gt;get_category_meta($key);
		}elseif ( ! empty( $key ) &amp;&amp; !empty($gd_post-&gt;ID)) {
			$cf = geodir_get_field_infoby(&#039;htmlvar_name&#039;, $key, $gd_post-&gt;post_type);
			$field_type = !empty($cf[&#039;field_type&#039;]) ? esc_attr($cf[&#039;field_type&#039;]) : &#039;&#039;;

			if ( $field_type == &#039;url&#039; ) {
				$field_value = $gd_post-&gt;{$key};

				if ( ! empty( $field_value ) ) {
					$image_data = [
						&#039;id&#039; =&gt; null,
						&#039;gd-url&#039;=&gt; $field_value,
						&#039;url&#039; =&gt; geodir_get_screenshot( $field_value, array( &#039;w&#039; =&gt; 1024, &#039;h&#039; =&gt; 1024, &#039;image&#039; =&gt; true ) ),
					];
				}
			} else {
				$post_images = GeoDir_Media::get_attachments_by_type( $gd_post-&gt;ID, $key, 1 );

				if(!empty($post_images)){
					$image = $post_images[0];
					$size = &#039;&#039;;
					$img_src = geodir_get_image_src($image, $size);
					$image_data = [
						&#039;id&#039; =&gt; null,
						&#039;gd-id&#039; =&gt; $image-&gt;ID,
						&#039;gd-key&#039; =&gt; $key,
						&#039;url&#039; =&gt; $img_src,
					];
				}
			}

		}


		// fallback image
		if ( empty( $image_data[&#039;url&#039;] ) &amp;&amp; $this-&gt;get_settings( &#039;fallback_image&#039; ) ) {
			$value = $this-&gt;get_settings( &#039;fallback_image&#039; );
		}
		if ( ! empty( $value ) &amp;&amp; is_array( $value ) ) {
			$image_data[&#039;id&#039;] = $value[&#039;id&#039;];
			$image_data[&#039;url&#039;] = $value[&#039;url&#039;];
		}

		return $image_data;
	}

	/**
	 * Get the category meta.
	 *
	 * @param $key
	 * @param $show
	 *
	 * @return mixed|string|void
	 */
	public function get_category_meta($key){
		global $gd_post;
		$image_data = [
			&#039;id&#039; =&gt; null,
			&#039;url&#039; =&gt; &#039;&#039;,
		];

		$term_id = &#039;&#039;;
		if( geodir_is_page(&#039;archive&#039;) ){
			$current_category = get_queried_object();
			$term_id = isset($current_category-&gt;term_id) ?  absint($current_category-&gt;term_id) : &#039;&#039;;
		}elseif(geodir_is_page(&#039;single&#039;)){
			$term_id = isset($gd_post-&gt;default_category) ? absint($gd_post-&gt;default_category) : &#039;&#039;;
		}

		if($term_id) {

			if($key == &#039;category_map_icon&#039;){
//				$value = esc_url_raw( geodir_get_term_icon( $term_id ) );

				$cat_img = get_term_meta( $term_id, &#039;ct_cat_icon&#039;, true );
				if(!empty($cat_img)){
					$value = esc_url_raw( geodir_get_cat_icon( $term_id, true ) );
					$image_data = [
						&#039;id&#039; =&gt; $cat_img[&#039;id&#039;],
						&#039;url&#039; =&gt; $value,
					];
				}

			}elseif($key == &#039;category_image&#039;){
				$cat_img = get_term_meta( $term_id, &#039;ct_cat_default_img&#039;, true );
				if(!empty($cat_img)){
					$value = esc_url_raw( geodir_get_cat_image( $term_id, true ) );
					$image_data = [
						&#039;id&#039; =&gt; $cat_img[&#039;id&#039;],
						&#039;url&#039; =&gt; $value,
					];
				}
			}
		}



		return $image_data;
	}

	/**
	 * Set the settings key key.
	 * @return string
	 */
	public function get_panel_template_setting_key() {
		return &#039;key&#039;;
	}

	/**
	 * Register controls for the tag.
	 */
	protected function register_controls() {

		$this-&gt;add_control(
			&#039;key&#039;,
			[
				&#039;label&#039; =&gt; __( &#039;Key&#039;, &#039;elementor-pro&#039; ),
				&#039;type&#039; =&gt; \Elementor\Controls_Manager::SELECT,
				&#039;groups&#039; =&gt; $this-&gt;get_custom_field_group_options(),
			]
		);

		$this-&gt;add_control(
			&#039;fallback_image&#039;,
			[
				&#039;label&#039; =&gt; __( &#039;Fallback&#039;, &#039;geodirectory&#039; ),
				&#039;type&#039; =&gt; \Elementor\Controls_Manager::MEDIA,
			]
		);
	}

	/**
	 * Get and group the key options.
	 *
	 * @return array
	 */
	public function get_custom_field_group_options(){
		$groups = array();

		$fields = geodir_post_custom_fields(&#039;&#039;, &#039;all&#039;, &#039;all&#039; ,&#039;none&#039;);

		$supported_fields = $this-&gt;get_supported_fields();
		// remove unneeded types
		foreach($fields as $key =&gt; $field){
			if(!empty($field[&#039;type&#039;]) &amp;&amp; !in_array($field[&#039;type&#039;],$supported_fields)){
				unset($fields[$key]);
			}
		}
		$keys = array();
//		$keys[] = __(&#039;Select Key&#039;,&#039;geodirectory&#039;);
		if(!empty($fields)){
			foreach($fields as $field){
				$keys[$field[&#039;htmlvar_name&#039;]] = $field[&#039;htmlvar_name&#039;];
			}
		}

		$groups[] = array(
			&#039;label&#039; =&gt; __(&quot;Custom Fields&quot;,&quot;geodirectory&quot;),
			&#039;options&#039;   =&gt; $keys
		);

		// category keys
		$cat_keys = array();
		$cat_keys[&#039;category_map_icon&#039;] = &#039;category_map_icon&#039;;
		$cat_keys[&#039;category_image&#039;] = &#039;category_image&#039;;
		$groups[] = array(
			&#039;label&#039; =&gt; __(&quot;Category meta&quot;,&quot;geodirectory&quot;),
			&#039;options&#039;   =&gt; $cat_keys
		);

		return $groups;
	}


	/**
	 * Get what fields are supported for this tag type.
	 *
	 * @return array
	 */
	protected function get_supported_fields() {
		return [
			&#039;image&#039;,
			&#039;images&#039;,
			&#039;file&#039;,
			&#039;url&#039;,
		];
	}
}</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Geodirectory Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on May 12th, 2022 at 06:15 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1652336158"></script>
    <script src="../js/search.js?updated=1652336158"></script>
</body>
</html>
