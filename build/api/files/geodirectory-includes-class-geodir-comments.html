<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Geodirectory Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1652336158">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1652336158">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.png" alt="WPGeodirectory" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">Geodirectory Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/elementorpro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/elementorpro-modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Geodirectory.html"><abbr title="\Geodirectory">Geodirectory</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectory.html"><abbr title="\GeoDirectory">GeoDirectory</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/GeoDirectory-Templates.html"><abbr title="\GeoDirectory\Templates">Templates</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAbstracts.html"><abbr title="\GeoDirectoryAbstracts">GeoDirectoryAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAPI.html"><abbr title="\GeoDirectoryAPI">GeoDirectoryAPI</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClasses.html"><abbr title="\GeoDirectoryClasses">GeoDirectoryClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminFunctions.html"><abbr title="\GeoDirectoryAdminFunctions">GeoDirectoryAdminFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoruAdmin.html"><abbr title="\GeoDirectoruAdmin">GeoDirectoruAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdmin.html"><abbr title="\GeoDirectoryAdmin">GeoDirectoryAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirAdmin.html"><abbr title="\GeoDirAdmin">GeoDirAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectroyAdmin.html"><abbr title="\GeoDirectroyAdmin">GeoDirectroyAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminSystemStatus.html"><abbr title="\GeoDirectoryAdminSystemStatus">GeoDirectoryAdminSystemStatus</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminTools.html"><abbr title="\GeoDirectoryAdminTools">GeoDirectoryAdminTools</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminWidgets.html"><abbr title="\GeoDirectoryAdminWidgets">GeoDirectoryAdminWidgets</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesEmails.html"><abbr title="\GeoDirectoryClassesEmails">GeoDirectoryClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesData.html"><abbr title="\GeoDirectoryClassesData">GeoDirectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDIrectoryClassesData.html"><abbr title="\GeoDIrectoryClassesData">GeoDIrectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/ElementorPro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/ElementorPro-Modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryFunctions.html"><abbr title="\GeoDirectoryFunctions">GeoDirectoryFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryparamarraytermsAnarrayoftermobjects.html"><abbr title="\GeoDirectoryparamarraytermsAnarrayoftermobjects">GeoDirectoryparamarraytermsAnarrayoftermobjects</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WP.html"><abbr title="\WP">WP</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WP-Background.html"><abbr title="\WP\Background">Background</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryTemplates.html"><abbr title="\GeoDirectoryTemplates">GeoDirectoryTemplates</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-geodir-comments.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit; // Exit if accessed directly
}


class GeoDir_Comments {

	/**
	 * Initiate the comments class.
     *
     * @since 2.0.0
	 */
	public static function init() {
		// AUI comment inputs
		add_filter( &#039;comment_form_defaults&#039;, array( __CLASS__, &#039;aui_comment_form_defaults&#039; ), 11, 1 );

		add_action( &#039;comment_form_logged_in_after&#039;, array( __CLASS__, &#039;rating_input&#039; ) );
		add_action( &#039;comment_form_before_fields&#039;, array( __CLASS__, &#039;rating_input&#039; ) );

		// add ratings to comment text
		add_filter( &#039;comment_text&#039;, array(__CLASS__, &#039;wrap_comment_text&#039;), 40, 2 );

		// replace comments template
		add_filter( &quot;comments_template&quot;, array(__CLASS__, &quot;comments_template&quot;) ); // @todo, maybe we want to use the themes own template?

		// remove replies from comments count so only to show reviews
		add_filter( &#039;get_comments_number&#039;, array(__CLASS__, &#039;review_count_exclude_replies&#039;), 10, 2 );

		// set if listing has comments open
		add_filter( &#039;comments_open&#039;, array(__CLASS__,&#039;comments_open&#039;), 20, 2 ); // @todo we maybe don&#039;t need this with the new preview system?

		// comment actions
		add_action( &#039;comment_post&#039;, array(__CLASS__,&#039;save_rating&#039;) );
		add_action( &#039;wp_set_comment_status&#039;, array(__CLASS__, &#039;status_change&#039;), 10, 2 );
		add_action( &#039;edit_comment&#039;, array(__CLASS__, &#039;edit_comment&#039;) );
		add_action( &#039;delete_comment&#039;, array(__CLASS__, &#039;delete_comment&#039;) );

		// change the comment hash to review hash
		add_filter(&#039;get_comments_link&#039;, array(__CLASS__,&#039;get_comments_link&#039;), 15, 2);
	}

	/**
	 * Bootstrap the default comment form inputs with AUI.
	 *
	 * @param $defaults
	 *
	 * @return mixed
	 */
	public static function aui_comment_form_defaults( $defaults ) {
		$design_style = geodir_design_style();

		if ( $design_style &amp;&amp; geodir_is_page( &#039;single&#039; ) ) {
			// comment field
			$defaults[&#039;comment_field&#039;] = aui()-&gt;textarea(array(
				&#039;name&#039;       =&gt; &#039;comment&#039;,
				&#039;class&#039;      =&gt; &#039;&#039;,
				&#039;id&#039;         =&gt; &#039;comment&#039;,
				&#039;placeholder&#039;=&gt; esc_html__( &quot;Enter your review comments here (required)...&quot;, &#039;geodirectory&#039;),
				&#039;required&#039;   =&gt; true,
				&#039;label&#039;      =&gt; esc_html__( &quot;Review text&quot;, &#039;geodirectory&#039;),
				&#039;rows&#039;      =&gt; 8,
			));

			// author name
			$defaults[&#039;fields&#039;][&#039;author&#039;] = aui()-&gt;input(
				array(
					&#039;id&#039;                =&gt; &#039;author&#039;,
					&#039;name&#039;              =&gt; &#039;author&#039;,
					&#039;required&#039;          =&gt; true,
					&#039;label&#039;              =&gt; esc_html__( &quot;Name&quot;, &#039;geodirectory&#039;),
					&#039;type&#039;              =&gt; &#039;text&#039;,
					&#039;placeholder&#039;       =&gt; esc_html__( &quot;Name (required)&quot; , &#039;geodirectory&#039;),
					&#039;extra_attributes&#039;  =&gt; array(
						&#039;maxlength&#039; =&gt; &quot;245&quot;
					)
				)
			);

			// author email
			$defaults[&#039;fields&#039;][&#039;email&#039;] = aui()-&gt;input(
				array(
					&#039;id&#039;                =&gt; &#039;email&#039;,
					&#039;name&#039;              =&gt; &#039;email&#039;,
					&#039;required&#039;          =&gt; true,
					&#039;label&#039;              =&gt; esc_html__( &quot;Email&quot;, &#039;geodirectory&#039;),
					&#039;type&#039;              =&gt; &#039;email&#039;,
					&#039;placeholder&#039;       =&gt; esc_html__( &quot;Email (required)&quot; , &#039;geodirectory&#039;),
					&#039;extra_attributes&#039;  =&gt; array(
						&#039;maxlength&#039; =&gt; &quot;100&quot;
					)
				)
			);

			// website url
			$defaults[&#039;fields&#039;][&#039;url&#039;] = aui()-&gt;input(
				array(
					&#039;id&#039;                =&gt; &#039;url&#039;,
					&#039;name&#039;              =&gt; &#039;url&#039;,
					&#039;required&#039;          =&gt; true,
					&#039;label&#039;              =&gt; esc_html__( &quot;Website&quot;, &#039;geodirectory&#039;),
					&#039;type&#039;              =&gt; &#039;url&#039;,
					&#039;placeholder&#039;       =&gt; esc_html__( &quot;Website (required)&quot; , &#039;geodirectory&#039;),
					&#039;extra_attributes&#039;  =&gt; array(
						&#039;maxlength&#039; =&gt; &quot;200&quot;
					)
				)
			);

			// website url
			$defaults[&#039;fields&#039;][&#039;cookies&#039;] = aui()-&gt;input(
				array(
					&#039;id&#039;                =&gt; &#039;wp-comment-cookies-consent&#039;,
					&#039;name&#039;              =&gt; &#039;wp-comment-cookies-consent&#039;,
					&#039;required&#039;          =&gt; true,
					&#039;value&#039;             =&gt; &#039;yes&#039;,
					&#039;label&#039;              =&gt; esc_html__( &quot;Save my name, email, and website in this browser for the next time I comment.&quot;, &#039;geodirectory&#039;),
					&#039;type&#039;              =&gt; &#039;checkbox&#039;,
				)
			);

			// logged in as
			$defaults[&#039;logged_in_as&#039;] = str_replace(&quot;logged-in-as&quot;,&quot;logged-in-as mb-3&quot;,$defaults[&#039;logged_in_as&#039;] );

			// logged out notes
			$defaults[&#039;comment_notes_before&#039;] = aui()-&gt;alert(array(
					&#039;type&#039;=&gt; &#039;info&#039;,
					&#039;content&#039;=&gt; __(&quot;Your email address will not be published.&quot;,&quot;geodirectory&quot;)
				)
			);

			$reply_text = __( &quot;Leave a Review&quot;, &quot;geodirectory&quot; );

			$defaults[&#039;class_submit&#039;] .= &quot; btn btn-primary form-control text-white&quot;;
			$defaults[&#039;submit_field&#039;] = &#039;&lt;div class=&quot;form-submit form-group&quot;&gt;%1$s %2$s&lt;/div&gt;&#039;;
			$defaults[&#039;label_submit&#039;] = esc_html__( &quot;Post Review&quot; , &#039;geodirectory&#039;);
			$defaults[&#039;title_reply&#039;] = &#039;&lt;span class=&quot;gd-comment-review-title h4&quot; data-review-text=&quot;&#039; . esc_attr( $reply_text ) . &#039;&quot; data-reply-text=&quot;&#039; . esc_attr( $defaults[&#039;title_reply&#039;] ) . &#039;&quot;&gt;&#039; . $reply_text . &#039;&lt;/span&gt;&#039;;
		}

		return $defaults;
	}

	/**
	 * Channge the comments url hash to review types.
	 *
	 * @param $comments_link
	 * @param $post_id
	 *
	 * @return mixed
	 */
	public static function get_comments_link($comments_link, $post_id) {
		$post_type = get_post_type($post_id);

		$all_postypes = geodir_get_posttypes();
		if (in_array($post_type, $all_postypes)) {
			$comments_link = str_replace(&#039;#comments&#039;, &#039;#reviews&#039;, $comments_link);
			$comments_link = str_replace(&#039;#respond&#039;, &#039;#reviews&#039;, $comments_link);
		}

		return $comments_link;
	}
	
	/**
	 * Update post overall rating and rating count.
	 *
     * @since 2.0.0
     *
	 * @global object $wpdb WordPress Database object.
	 * @global string $plugin_prefix Geodirectory plugin table prefix.
	 *
	 * @param int $post_id The post ID.
	 * @param string $post_type The post type.
	 * @param bool $delete Depreciated since ver 1.3.6.
	 */
	public static function update_post_rating( $post_id = 0, $post_type = &#039;&#039;, $delete = false ) {
		global $wpdb, $plugin_prefix, $comment;
		if ( ! $post_type ) {
			$post_type = get_post_type( $post_id );
		}

		if ( ! geodir_is_gd_post_type( $post_type ) ) {
			return;
		}
		$detail_table         = $plugin_prefix . $post_type . &#039;_detail&#039;;
		$post_newrating       = geodir_get_post_rating( $post_id, 1 );
		$post_newrating_count = (int) geodir_get_review_count_total( $post_id, 1 );

		$wpdb-&gt;update( $detail_table, array( &#039;overall_rating&#039; =&gt; $post_newrating, &#039;rating_count&#039; =&gt; $post_newrating_count ), array( &#039;post_id&#039; =&gt; $post_id ), array( &#039;%f&#039;, &#039;%d&#039; ), array( &#039;%d&#039; ) );

		// delete post rating cache
		wp_cache_delete( &quot;gd_post_review_count_total_&quot;.$post_id);

		// Clear the post cache
		wp_cache_delete( &quot;gd_post_&quot; . $post_id, &#039;gd_post&#039; );

		/**
		 * Called after Updating post overall rating and rating count.
		 *
		 * @since 1.0.0
		 * @since 1.4.3 Added `$post_id` param.
		 * @package GeoDirectory
		 *
		 * @param int $post_id The post ID.
		 */
		do_action( &#039;geodir_update_post_rating&#039;, $post_id );

	}

	/**
	 * Get review details using comment ID.
	 *
	 * Returns review details using comment ID. If no reviews returns false.
     *
     * @since 2.0.0
	 *
	 * @param int $comment_id Optional. The comment ID. Default 0.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @return bool|mixed
	 */
	public static function get_review( $comment_id = 0 ) {
		global $wpdb;

		$reatings = $wpdb-&gt;get_row(
			$wpdb-&gt;prepare(
				&quot;SELECT * FROM &quot; . GEODIR_REVIEW_TABLE . &quot; WHERE comment_id = %d&quot;,
				array( $comment_id )
			)
		);

		if ( ! empty( $reatings ) ) {
			return $reatings;
		} else {
			return false;
		}
	}

	/**
	 * Delete review details when deleting comment.
     *
     * @since 2.0.0
	 *
	 * @param int $comment_id The comment ID.
	 *
	 * @global object $wpdb WordPress Database object.
	 */
	public static function delete_comment( $comment_id ) {
		global $wpdb;

		$review_info = self::get_review( $comment_id );
		if ( $review_info ) {
			self::update_post_rating( $review_info-&gt;post_id );
		}

		$wpdb-&gt;query(
			$wpdb-&gt;prepare(
				&quot;DELETE FROM &quot; . GEODIR_REVIEW_TABLE . &quot; WHERE comment_id=%d&quot;,
				array( $comment_id )
			)
		);

		// clear cache
		wp_cache_delete( &quot;gd_comment_rating_&quot;.$comment_id );
	}

	/**
	 * Update comment rating.
     *
     * @since 2.0.0
	 *
	 * @param int $comment_id Optional. The comment ID. Default 0.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @global string $plugin_prefix Geodirectory plugin table prefix.
     *
	 * @global int $user_ID The current user ID.
	 */
	public static function edit_comment( $comment_id = 0 ) {
		global $wpdb;

		if ( ! isset( $_REQUEST[&#039;geodir_overallrating&#039;] ) ) {
			return;
		}

		$comment_info = get_comment( $comment_id );
		if ( empty( $comment_info ) ) {
			return;
		}

		$post_id    = $comment_info-&gt;comment_post_ID;
		$old_rating = geodir_get_comment_rating( $comment_info-&gt;comment_ID );
		$post_type  = get_post_type( $post_id );
		$rating 	= absint($_REQUEST[&#039;geodir_overallrating&#039;]);

		if ( isset( $comment_info-&gt;comment_parent ) &amp;&amp; (int) $comment_info-&gt;comment_parent == 0 ) {
			if ( !empty( $old_rating ) ) {
				$sqlqry = $wpdb-&gt;prepare( &quot;UPDATE &quot; . GEODIR_REVIEW_TABLE . &quot; SET
					rating = %f 
					WHERE comment_id = %d &quot;, 
					array(
						$rating,
						$comment_id
					) 
				);

				// clear cache
				wp_cache_delete( &quot;gd_comment_rating_&quot;.$comment_id );

				$wpdb-&gt;query( $sqlqry );

				// update rating
				self::update_post_rating( $post_id, $post_type );
			}elseif(!empty($_REQUEST[&#039;geodir_overallrating&#039;])){
				// create new rating if not exists
				self::save_rating($comment_id);
			}
		}
	}

	/**
	 * Update comment status when changing the rating.
	 *
     * @since 2.0.0
     *
	 * @param int $comment_id The comment ID.
	 * @param int|string $status The comment status.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @global string $plugin_prefix Geodirectory plugin table prefix.
	 * @global int $user_ID The current user ID.
	 */
	public static function status_change( $comment_id, $status ) {
		global $wpdb;

		if ( $status == &#039;delete&#039; ) {
			return;
		}

		$comment_info = get_comment( $comment_id );
		if ( empty( $comment_info ) ) {
			return;
		}

		$post_id 		 = isset( $comment_info-&gt;comment_post_ID ) ? $comment_info-&gt;comment_post_ID : &#039;&#039;;
		$comment_info_ID = isset( $comment_info-&gt;comment_ID ) ? $comment_info-&gt;comment_ID : &#039;&#039;;
		$old_rating      = geodir_get_comment_rating( $comment_info_ID );
		$post_type 		 = get_post_type( $post_id );

		if ( $comment_id ) {
			$rating = $old_rating;

			if ( isset( $old_rating ) ) {
				$sqlqry = $wpdb-&gt;prepare( &quot;UPDATE &quot; . GEODIR_REVIEW_TABLE . &quot; SET
					rating = %f 
					WHERE comment_id = %d &quot;, 
					array(
						$rating,
						$comment_id
					) 
				);

				// clear cache
				wp_cache_delete( &quot;gd_comment_rating_&quot;.$comment_id );

				$wpdb-&gt;query( $sqlqry );

				// update rating
				self::update_post_rating( $post_id, $post_type );
			}
		}
	}

	/**
	 * Save rating details for a comment.
	 *
     * @since 2.0.0
     *
	 * @param int $comment The comment ID.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @global int $user_ID The current user ID.
	 */
	public static function save_rating( $comment = 0 ) {
		global $wpdb, $user_ID;
		
		if ( ! isset( $_REQUEST[&#039;geodir_overallrating&#039;] ) ) {
			return;
		}

		$comment_info = get_comment( $comment );
		if ( empty( $comment_info ) ) {
			return;
		}

		$post_id = $comment_info-&gt;comment_post_ID;

		$gd_post = geodir_get_post_info( $post_id );
		if ( empty( $gd_post ) ) {
			return;
		}

		$rating = absint($_REQUEST[&#039;geodir_overallrating&#039;]);

		if ( isset( $comment_info-&gt;comment_parent ) &amp;&amp; (int) $comment_info-&gt;comment_parent == 0 ) {
			$sqlqry = $wpdb-&gt;prepare( &quot;INSERT INTO &quot; . GEODIR_REVIEW_TABLE . &quot; SET
				post_id		= %d,
				post_type 	= %s,
				user_id		= %d,
				comment_id	= %d,
				rating 		= %f,
				city		= %s, 
				region		= %s, 
				country		= %s,
				longitude	= %s,
				latitude	= %s
				&quot;,
				array(
					$post_id,
					$gd_post-&gt;post_type,
					$user_ID,
					$comment_info-&gt;comment_ID,
					$rating,
					( isset( $gd_post-&gt;city ) ? $gd_post-&gt;city : &#039;&#039; ),
					( isset( $gd_post-&gt;region ) ? $gd_post-&gt;region : &#039;&#039; ),
					( isset( $gd_post-&gt;country ) ? $gd_post-&gt;country : &#039;&#039; ),
					( isset( $gd_post-&gt;latitude ) ? $gd_post-&gt;latitude : &#039;&#039; ),
					( isset( $gd_post-&gt;longitude ) ? $gd_post-&gt;longitude : &#039;&#039; ),
				)
			);

			$wpdb-&gt;query( $sqlqry );

			/**
			 * Called after saving the comment.
			 *
			 * @since 1.0.0
			 * @package GeoDirectory
			 *
			 * @param array $_REQUEST {
			 *    Attributes of the $_REQUEST variable.
			 *
			 * @type string $geodir_overallrating Overall rating.
			 * @type string $comment Comment text.
			 * @type string $submit Submit button text.
			 * @type string $comment_post_ID Comment post ID.
			 * @type string $comment_parent Comment Parent ID.
			 * @type string $_wp_unfiltered_html_comment Unfiltered html comment string.
			 *
			 * }
			 */
			do_action( &#039;geodir_after_save_comment&#039;, $_REQUEST, &#039;Comment Your Post&#039; );

			self::update_post_rating( $post_id,$gd_post-&gt;post_type );
		}
	}

	/**
	 * Check whether the current post is open for reviews.
     *
     * @since 2.0.0
	 *
	 * @param bool $open Whether the current post is open for reviews.
	 * @param int $post_id The post ID.
	 *
	 * @return bool True if allowed otherwise False.
	 */
	public static function comments_open( $open, $post_id ) {
		if ( empty( $post_id ) ) {
			return $open;
		}

		if ( $open &amp;&amp; geodir_is_page( &#039;detail&#039; ) ) {
			if ( in_array( get_post_status( $post_id ), array( &#039;draft&#039;, &#039;pending&#039;, &#039;auto-draft&#039;, &#039;trash&#039; ) ) ) {
				$open = false;
			}
		}

		$post_type = get_post_type( $post_id );

		if ( ! geodir_is_gd_post_type( $post_type ) ) {
			return $open;
		}

		// Check &amp; disable comments for post type.
		if ( $open &amp;&amp; ! GeoDir_Post_types::supports( $post_type, &#039;comments&#039; ) ) {
			$open = false;
		}

		// Check single review.
		if ( $open &amp;&amp; ! self::can_submit_post_review( $post_id ) ) {
			$open = false;
		}

		return $open;
	}

	/**
	 * Fix comment count by not listing replies as reviews.
	 *
	 * @since 1.0.0
	 * @package GeoDirectory
	 * @global object $post The current post object.
	 *
	 * @param int $count The comment count.
	 * @param int $post_id The post ID.
	 *
	 * @return bool|null|string The comment count.
	 */
	public static function review_count_exclude_replies( $count, $post_id ) {
		if ( ! is_admin() || strpos( $_SERVER[&#039;REQUEST_URI&#039;], &#039;admin-ajax.php&#039; ) ) {
			$post_types = geodir_get_posttypes();
			$post_type = get_post_type( $post_id );
			if ( in_array( $post_type , $post_types ) &amp;&amp; ! geodir_cpt_has_rating_disabled( $post_type) ) {
				$review_count = self::get_post_review_count_total( $post_id );

				return $review_count;
			} else {
				return $count;
			}
		} else {
			return $count;
		}
	}

	/**
	 * Sets the comment template.
	 *
	 * Sets the comment template using filter {@see &#039;comments_template&#039;}.
     *
     * @since 2.0.0
	 *
	 * @global object $post The current post object.
	 * @param string $comment_template Old comment template.
	 * @return string New comment template.
	 */
	public static function comments_template( $comment_template ) {
		global $post,$gd_is_comment_template_set;

		$post_types = geodir_get_posttypes();

		if ( ! ( is_singular() &amp;&amp; ( have_comments() || ( isset( $post-&gt;comment_status ) &amp;&amp; &#039;open&#039; == $post-&gt;comment_status ) ) ) ) {

			// if we already loaded the template don&#039;t load it again
			if($gd_is_comment_template_set){
				return geodir_plugin_path() . &#039;/index.php&#039;; // a blank template to remove default if called more than once.
			}

			return $comment_template;
		}
		if ( in_array( get_post_type( $post-&gt;ID ), $post_types ) ) { // assuming there is a post type called business

			// if we already loaded the template don&#039;t load it again
			if($gd_is_comment_template_set){
				return geodir_plugin_path() . &#039;/index.php&#039;; // a blank template to remove default if called more than once.
			}

			if ( geodir_cpt_has_rating_disabled( get_post_type( $post-&gt;ID ) ) ) {
				$gd_is_comment_template_set = true;
				return $comment_template;
			}

			$design_style = geodir_design_style();

			$template_path = $design_style ? &#039;geodirectory/&#039; . $design_style . &#039;/reviews.php&#039; : &#039;geodirectory/reviews.php&#039;;
			$template = locate_template( array( $template_path ) ); // Use theme template if available
			if ( ! $template ) {
				$template = untrailingslashit( geodir_get_templates_dir() ) . &#039;/&#039; . ( $design_style ? $design_style . &#039;/reviews.php&#039; : &#039;reviews.php&#039; );
			}
			$gd_is_comment_template_set = true;

			return $template;
		}

		return $comment_template;
	}

	/**
	 * Add rating information in comment text.
     *
     * @since 2.0.0
	 *
	 * @param string $content The comment content.
	 * @param object|string $comment The comment object.
	 *
	 * @return string The comment content.
	 */
	public static function wrap_comment_text( $content, $comment = &#039;&#039; ) {
		if ( ! empty( $comment-&gt;comment_post_ID ) &amp;&amp; geodir_cpt_has_rating_disabled( (int) $comment-&gt;comment_post_ID ) ) {
			if ( ! is_admin() ) {
				return &#039;&lt;div class=&quot;description&quot;&gt;&#039; . $content . &#039;&lt;/div&gt;&#039;;
			} else {
				return $content;
			}
		} else {
			$rating = 0;
			if ( ! empty( $comment ) ) {
				$rating = self::get_comment_rating( $comment-&gt;comment_ID );
			}
			if ( $rating != 0 &amp;&amp; ! is_admin() ) {
				return &#039;&lt;div class=&quot;description&quot;&gt;&#039; . $content . &#039;&lt;/div&gt;&#039;;
			} else {
				return $content;
			}
		}
	}

	/**
	 * Comment HTML markup.
     *
     * @since 2.0.0
	 *
	 * @global object $post The current post object.
	 *
	 * @param object $comment The comment object.
	 * @param string|array $args {
	 *     Optional. Formatting options.
	 *
	 * @type object $walker Instance of a Walker class to list comments. Default null.
	 * @type int $max_depth The maximum comments depth. Default empty.
	 * @type string $style The style of list ordering. Default &#039;ul&#039;. Accepts &#039;ul&#039;, &#039;ol&#039;.
	 * @type string $callback Callback function to use. Default null.
	 * @type string $end -callback      Callback function to use at the end. Default null.
	 * @type string $type Type of comments to list.
	 *                                     Default &#039;all&#039;. Accepts &#039;all&#039;, &#039;comment&#039;, &#039;pingback&#039;, &#039;trackback&#039;, &#039;pings&#039;.
	 * @type int $page Page ID to list comments for. Default empty.
	 * @type int $per_page Number of comments to list per page. Default empty.
	 * @type int $avatar_size Height and width dimensions of the avatar size. Default 32.
	 * @type string $reverse_top_level Ordering of the listed comments. Default null. Accepts &#039;desc&#039;, &#039;asc&#039;.
	 * @type bool $reverse_children Whether to reverse child comments in the list. Default null.
	 * @type string $format How to format the comments list.
	 *                                     Default &#039;html5&#039; if the theme supports it. Accepts &#039;html5&#039;, &#039;xhtml&#039;.
	 * @type bool $short_ping Whether to output short pings. Default false.
	 * @type bool $echo Whether to echo the output or return it. Default true.
	 * }
	 *
	 * @param int $depth Depth of comment.
	 */
	public static function list_comments_callback( $comment, $args, $depth ) {
		$GLOBALS[&#039;comment&#039;] = $comment;
		switch ( $comment-&gt;comment_type ) :
			case &#039;pingback&#039; :
			case &#039;trackback&#039; :
				// Display trackbacks differently than normal comments.
				?&gt;
				&lt;li &lt;?php comment_class( &#039;geodir-comment&#039; ); ?&gt; id=&quot;comment-&lt;?php comment_ID(); ?&gt;&quot;&gt;
				&lt;p&gt;&lt;?php _e( &#039;Pingback:&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;?php comment_author_link(); ?&gt;&lt;?php edit_comment_link( __( &#039;(Edit)&#039;, &#039;geodirectory&#039; ), &#039;&lt;span class=&quot;edit-link&quot;&gt;&#039;, &#039;&lt;/span&gt;&#039; ); ?&gt;&lt;/p&gt;
				&lt;?php
				break;
			default :
				// Proceed with normal comments.
				global $post;

				$design_style = geodir_design_style();

				$template = $design_style ? $design_style.&quot;/reviews/item.php&quot; : &quot;legacy/reviews/item.php&quot;;

				$vars = array(
					&#039;comment&#039;   =&gt; $comment,
					&#039;args&#039; =&gt; $args,
					&#039;depth&#039; =&gt; $depth,
					&#039;rating&#039; =&gt; self::get_comment_rating( $comment-&gt;comment_ID )
				);
				echo geodir_get_template_html( $template, $vars );
				
				break;
		endswitch; // end comment_type check
	}

	/**
	 * Add rating fields in comment form.
	 *
	 * Adds a rating input field in comment form.
	 *
	 * @since 1.0.0
	 * @since 1.6.16 Changes for disable review stars for certain post type.
	 * @package GeoDirectory
	 * @global object $post The post object.
	 */
	public static function rating_input( $comment = array() ) {
		global $post;


		if ( isset( $comment-&gt;comment_post_ID ) &amp;&amp; $comment-&gt;comment_post_ID ) {
			$post_type = get_post_type( $comment-&gt;comment_post_ID );
		} else {
			$post_type = $post-&gt;post_type;
		}
		$post_types = geodir_get_posttypes();

		if ( ! empty( $post_type )
		     &amp;&amp; in_array( $post_type , $post_types )
		     &amp;&amp; ! ( ! empty( $post-&gt;post_type ) &amp;&amp; geodir_cpt_has_rating_disabled( $post_type ) )
		) {
			$rating = 0;
			if ( isset( $comment-&gt;comment_post_ID ) &amp;&amp; $comment-&gt;comment_post_ID ) {
				$rating = self::get_comment_rating( $comment-&gt;comment_ID );
			}

			$design_style = geodir_design_style();

			if($design_style){
				echo &#039;&lt;div class=&quot;form-group form-control h-auto rounded px-3 pt-3 pb-3  gd-rating-input-group &quot;&gt;&#039;;
			}

			echo self::rating_input_html( $rating );

			if($design_style){
				echo &#039;&lt;/div&gt;&#039;;
			}
		}
	}

    /**
     * The rating input html.
     *
     * @since 2.0.0
     *
     * @param string $rating Rating value.
     * @return string
     */
	public static function rating_input_html( $rating ) {
		return self::rating_html( $rating, &#039;input&#039; );
	}

	/**
	 * Get the default rating count.
     *
     * @since 2.0.0
	 *
	 * @return int
	 */
	public static function rating_input_count() {
		return 5;
	}

	/**
	 * Get the rating input html.
     *
     * @since 2.0.0
	 *
	 * @param string $rating Rating.
	 * @param string $type Optional. Type. Default output.
	 *
	 * @return string
	 */
	public static function rating_html( $rating, $type = &#039;output&#039;, $overrides = array() ) {

        $defaults = array(
	        &#039;rating_icon&#039; =&gt; esc_attr( geodir_get_option( &#039;rating_icon&#039;, &#039;fas fa-star&#039; ) ),
	        &#039;rating_icon_fw&#039; =&gt; esc_attr( geodir_get_option( &#039;rating_icon_fw&#039; ) ),
            &#039;rating_color&#039; =&gt; esc_attr( geodir_get_option( &#039;rating_color&#039; ) ),
            &#039;rating_color_off&#039; =&gt; esc_attr( geodir_get_option( &#039;rating_color_off&#039; ) ),
            &#039;rating_label&#039; =&gt; &#039;&#039;,
            &#039;rating_texts&#039; =&gt; self::rating_texts(),
            &#039;rating_image&#039; =&gt; geodir_get_option( &#039;rating_image&#039; ),
            &#039;rating_type&#039; =&gt; esc_attr( geodir_get_option( &#039;rating_type&#039; ) ),
            &#039;rating_input_count&#039; =&gt; self::rating_input_count(),
            &#039;id&#039; =&gt; &#039;geodir_overallrating&#039;,
            &#039;type&#039; =&gt; $type,
        );

        $args = wp_parse_args( $overrides, $defaults );

		// rating label
		$rating_label = $args[&#039;rating_label&#039;];

		if(!$rating_label &amp;&amp; $type == &#039;input&#039; ){
			/**
			 * Filter the label for main rating.
			 *
			 * This is not shown everywhere but is used by reviews manager.
			 */
			$rating_label = apply_filters(&#039;geodir_overall_rating_label&#039;,&#039;&#039;);
		}

        $type = $args[&#039;type&#039;];
        $rating_icon  = $args[&#039;rating_icon&#039;];

		if($args[&#039;rating_icon_fw&#039;]){
			$rating_icon .= &quot; fa-fw&quot;;
		}

		$rating_color = $args[&#039;rating_color&#039;];
		if ( $rating_color == &#039;#ff9900&#039; ) {
			$rating_color = &#039;#ff9900&#039;;
		}
		$rating_color_off = $args[&#039;rating_color_off&#039;];
		if ( $rating_color_off == &#039;#afafaf&#039; ) {
			$rating_color_off = &quot;style=&#039;color:#afafaf;&#039;&quot;;
		} else {
			$rating_color_off = &quot;style=&#039;color:$rating_color_off;&#039;&quot;;
		}
		$rating_texts      = $args[&#039;rating_texts&#039;];
		$rating_wrap_title = &#039;&#039;;
		if ( $type == &#039;output&#039; ) {
			if ( $rating &gt; 0 ) {
				/*$int_rating = (int) $rating &gt; 1 ? (int) $rating : 1;
				if ( ! empty( $args ) &amp;&amp; ! empty( $args[&#039;rating_texts&#039;] ) &amp;&amp; ! empty( $args[&#039;rating_texts&#039;][ $int_rating ] ) ) {
					$rating_wrap_title = __( $args[&#039;rating_texts&#039;][ $int_rating ], &#039;geodirectory&#039; );
				} else {*/
					$rating_wrap_title = wp_sprintf( __( &#039;%d star rating&#039;, &#039;geodirectory&#039; ), $rating );
				//}
			} else {
				 $rating_wrap_title = __( &#039;No rating yet!&#039;, &#039;geodirectory&#039; );
			}
			$rating_wrap_title = apply_filters( &#039;geodir_output_rating_title&#039;, $rating_wrap_title, $rating, $args );
		}
		$rating_html        = &#039;&#039;;
		$rating_input_count = $args[&#039;rating_input_count&#039;];
		$i                  = 1;
		$rating_type        = $args[&#039;rating_type&#039;];
		if ( $rating_type == &#039;image&#039; &amp;&amp; $rating_image_id = $args[&#039;rating_image&#039;] ) {
			$rating_image = wp_get_attachment_url( $rating_image_id );
			while ( $i &lt;= $rating_input_count ) {
				$rating_title = $type == &#039;input&#039; ? &quot;title=&#039;$rating_texts[$i]&#039;&quot; : &#039;&#039;;
				$rating_html .= &#039;&lt;img alt=&quot;rating icon&quot; src=&quot;&#039; . $rating_image . &#039;&quot; &#039; . $rating_title . &#039; /&gt;&#039;;
				$i ++;
			}
			if ( $rating_color == &#039;#ff9900&#039; ) {
				$rating_color = &#039;background:#ff9900&#039;;
			} else {
				$rating_color = &quot;background:$rating_color;&quot;;
			}
		} else {

			if($rating_color){
				$rating_color = &quot; color:$rating_color; &quot;;
			}

			while ( $i &lt;= $rating_input_count ) {
				$rating_title = $type == &#039;input&#039; ? &quot;title=&#039;$rating_texts[$i]&#039;&quot; : &#039;&#039;;
				$rating_html .= &#039;&lt;i class=&quot;&#039; . $rating_icon . &#039;&quot; aria-hidden=&quot;true&quot; &#039; . $rating_title . &#039;&gt;&lt;/i&gt;&#039;;
				$i ++;
			}
		}


		$rating_percent   = $type == &#039;output&#039; ? &#039;width:&#039; . $rating / $rating_input_count * 100 . &#039;%;&#039; : &#039;&#039;;
		if($type==&#039;input&#039; &amp;&amp; !$rating){
			$rating_percent = &#039;width:50%;&#039;;
		}
		$foreground_style = $rating_percent || $rating_color ? &quot;style=&#039;$rating_percent $rating_color&#039;&quot; : &#039;&#039;;
		$rating_wrap_title = $rating_wrap_title ? &#039;title=&quot;&#039; . esc_attr( $rating_wrap_title ) . &#039;&quot;&#039; : &#039;&#039;;
		ob_start();

		$design_style = geodir_design_style();

		if($design_style){
			echo &#039;&lt;div class=&quot;gd-rating-outer-wrap gd-rating-&#039;.esc_attr( $type ).&#039;-wrap d-flex d-flex justify-content-between flex-nowrap w-100&quot;&gt;&#039;;

			$wrap_class = $type==&#039;input&#039; ? &#039;c-pointer&#039; : &#039;&#039;;
			?&gt;
			&lt;div class=&quot;gd-rating gd-rating-&lt;?php echo esc_attr( $type ); ?&gt; gd-rating-type-&lt;?php echo $rating_type; ?&gt;&quot;&gt;
			&lt;span class=&quot;gd-rating-wrap d-inline-flex position-relative &lt;?php echo $wrap_class;?&gt;&quot; &lt;?php echo $rating_wrap_title; ?&gt;&gt;
				&lt;span class=&quot;gd-rating-foreground position-absolute text-nowrap overflow-hidden&quot; &lt;?php echo $foreground_style; ?&gt;&gt;
				&lt;?php echo $rating_html; ?&gt;
				&lt;/span&gt;
				&lt;span class=&quot;gd-rating-background&quot; &lt;?php echo $rating_color_off; ?&gt;&gt;
				&lt;?php echo $rating_html; ?&gt;
				&lt;/span&gt;
			&lt;/span&gt;
				&lt;?php if ( $type == &#039;input&#039; ) { ?&gt;
					&lt;span class=&quot;gd-rating-text badge badge-light border&quot;
					      data-title=&quot;&lt;?php _e( &#039;Select a rating&#039;, &#039;geodirectory&#039; ); ?&gt;&quot;&gt;&lt;?php _e( &#039;Select a rating&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/span&gt;
					&lt;input type=&quot;hidden&quot; id=&quot;&lt;?php echo $args[&#039;id&#039;]; ?&gt;&quot; name=&quot;&lt;?php echo $args[&#039;id&#039;]; ?&gt;&quot;
					       value=&quot;&lt;?php echo esc_attr( $rating ); ?&gt;&quot;/&gt;
				&lt;?php } ?&gt;
			&lt;/div&gt;
			&lt;?php

			if($rating_label){
				?&gt;
				&lt;span class=&quot;gd-rating-label font-weight-bold p-0 m-0&quot;&gt;&lt;?php echo esc_attr($rating_label);?&gt;&lt;/span&gt;
				&lt;?php
			}

			echo &quot;&lt;/div&gt;&quot;;
		}else{
			echo &#039;&lt;div class=&quot;gd-rating-outer-wrap gd-rating-&#039;.esc_attr( $type ).&#039;-wrap&quot;&gt;&#039;;
			if($rating_label){
				?&gt;
				&lt;span class=&quot;gd-rating-label&quot;&gt;&lt;?php echo esc_attr($rating_label);?&gt;: &lt;/span&gt;
				&lt;?php
			}
			?&gt;
			&lt;div class=&quot;gd-rating gd-rating-&lt;?php echo esc_attr( $type ); ?&gt; gd-rating-type-&lt;?php echo $rating_type; ?&gt;&quot;&gt;
			&lt;span class=&quot;gd-rating-wrap&quot; &lt;?php echo $rating_wrap_title; ?&gt;&gt;
				&lt;span class=&quot;gd-rating-foreground&quot; &lt;?php echo $foreground_style; ?&gt;&gt;
				&lt;?php echo $rating_html; ?&gt;
				&lt;/span&gt;
				&lt;span class=&quot;gd-rating-background&quot; &lt;?php echo $rating_color_off; ?&gt;&gt;
				&lt;?php echo $rating_html; ?&gt;
				&lt;/span&gt;
			&lt;/span&gt;
				&lt;?php if ( $type == &#039;input&#039; ) { ?&gt;
					&lt;span class=&quot;gd-rating-text&quot;
					      data-title=&quot;&lt;?php _e( &#039;Select a rating&#039;, &#039;geodirectory&#039; ); ?&gt;&quot;&gt;&lt;?php _e( &#039;Select a rating&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/span&gt;
					&lt;input type=&quot;hidden&quot; id=&quot;&lt;?php echo $args[&#039;id&#039;]; ?&gt;&quot; name=&quot;&lt;?php echo $args[&#039;id&#039;]; ?&gt;&quot;
					       value=&quot;&lt;?php echo esc_attr( $rating ); ?&gt;&quot;/&gt;
				&lt;?php } ?&gt;
			&lt;/div&gt;
			&lt;?php
			echo &quot;&lt;/div&gt;&quot;;
		}



		return ob_get_clean();
	}

	/**
	 * Get the rating output html.
     *
     * @since 2.0.0
	 *
	 * @param string $rating Rating.
	 *
	 * @return string
	 */
	public static function rating_output( $rating, $overrides ) {
		return self::rating_html( $rating , &#039;output&#039;,$overrides );
	}

	/**
	 * The default rating texts.
     *
     * @since 2.0.0
	 *
	 * @return mixed|void
	 */
	public static function rating_texts_default() {
		$texts = array(
			1 =&gt; __( &#039;Terrible&#039;, &#039;geodirectory&#039; ),
			2 =&gt; __( &#039;Poor&#039;, &#039;geodirectory&#039; ),
			3 =&gt; __( &#039;Average&#039;, &#039;geodirectory&#039; ),
			4 =&gt; __( &#039;Very Good&#039;, &#039;geodirectory&#039; ),
			5 =&gt; __( &#039;Excellent&#039;, &#039;geodirectory&#039; ),
		);

		return apply_filters( &#039;geodir_rating_texts_default&#039;, $texts );
	}

	/**
	 * The rating texts used on the site.
     *
     * @since 2.0.0
	 *
	 * @return mixed|void
	 */
	public static function rating_texts() {
		$defaults = self::rating_texts_default();

		$texts = array(
			1 =&gt; geodir_get_option( &#039;rating_text_1&#039; ) ? __( geodir_get_option( &#039;rating_text_1&#039; ), &#039;geodirectory&#039; ) : $defaults[1],
			2 =&gt; geodir_get_option( &#039;rating_text_2&#039; ) ? __( geodir_get_option( &#039;rating_text_2&#039; ), &#039;geodirectory&#039; ) : $defaults[2],
			3 =&gt; geodir_get_option( &#039;rating_text_3&#039; ) ? __( geodir_get_option( &#039;rating_text_3&#039; ), &#039;geodirectory&#039; ) : $defaults[3],
			4 =&gt; geodir_get_option( &#039;rating_text_4&#039; ) ? __( geodir_get_option( &#039;rating_text_4&#039; ), &#039;geodirectory&#039; ) : $defaults[4],
			5 =&gt; geodir_get_option( &#039;rating_text_5&#039; ) ? __( geodir_get_option( &#039;rating_text_5&#039; ), &#039;geodirectory&#039; ) : $defaults[5],
		);
		
		return apply_filters( &#039;geodir_rating_texts&#039;, $texts );
	}

	/**
	 * Get average overall rating of a Post.
	 *
	 * Returns average overall rating of a Post. If no results, returns false.
     *
     * @since 2.0.0
	 *
	 * @param int $post_id The post ID.
	 * @param int $force_query Optional. Do you want force run the query? Default: 0.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @global object $post The current post object.
	 * @return array|bool|int|mixed|null|string
	 */
	public static function get_post_rating( $post_id = 0, $force_query = 0 ) {
		global $wpdb;

		$gd_post = geodir_get_post_info( $post_id );

		if ( isset( $gd_post-&gt;ID ) &amp;&amp; $gd_post-&gt;ID == $post_id &amp;&amp; ! $force_query ) {
			if ( isset( $gd_post-&gt;rating_count ) &amp;&amp; $gd_post-&gt;rating_count &gt; 0 &amp;&amp; isset( $gd_post-&gt;overall_rating ) &amp;&amp; $gd_post-&gt;overall_rating &gt; 0 ) {
				return $gd_post-&gt;overall_rating;
			} else {
				return 0;
			}
		}

		$results = $wpdb-&gt;get_var(
			$wpdb-&gt;prepare(
				&quot;SELECT  COALESCE(avg(r.rating),0) FROM &quot; . GEODIR_REVIEW_TABLE . &quot; AS r JOIN {$wpdb-&gt;comments} AS cmt ON cmt.comment_ID = r.comment_id WHERE r.post_id = %d AND cmt.comment_approved = &#039;1&#039; AND r.rating &gt; 0&quot;,
				array( $post_id )
			)
		);

		if ( ! empty( $results ) ) {
			return $results;
		} else {
			return false;
		}
	}

	/**
	 * Get review count of a Post.
	 *
	 * Returns review count of a Post. If no results, returns false.
     *
     * @since 2.0.0
	 *
	 * @param int $post_id The post ID.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @return bool|null|string
	 */
	public static function get_post_review_count_total( $post_id = 0, $force_query = 0  ) {
		global $wpdb,$gd_post;

		if(isset($gd_post-&gt;ID) &amp;&amp; $gd_post-&gt;ID==$post_id &amp;&amp; isset($gd_post-&gt;rating_count) &amp;&amp; !$force_query){
			return $gd_post-&gt;rating_count;
		}

		// check for cache
		$cache = wp_cache_get( &quot;gd_post_review_count_total_&quot;.$post_id, &#039;gd_post_review_count_total&#039; );
		if($cache !== false &amp;&amp; !$force_query){
			return $cache;
		}

		$results = $wpdb-&gt;get_var(
			$wpdb-&gt;prepare(
				&quot;SELECT COUNT(r.rating) FROM &quot; . GEODIR_REVIEW_TABLE . &quot; AS r JOIN {$wpdb-&gt;comments} AS cmt ON cmt.comment_ID = r.comment_id WHERE r.post_id = %d AND cmt.comment_approved = &#039;1&#039; AND r.rating &gt; 0&quot;,
				array( $post_id )
			)
		);

		if ( ! empty( $results ) ) {
			// set cache
			wp_cache_set( &quot;gd_post_review_count_total_&quot;.$post_id, $results, &#039;gd_post_review_count_total&#039; );
			return $results;
		} else {
			return false;
		}
	}

	/**
	 * Get overall rating of a comment.
	 *
	 * Returns overall rating of a comment. If no results, returns false.
     *
     * @since 2.0.0
	 *
	 * @param int $comment_id The comment ID.
	 *
	 * @global object $wpdb WordPress Database object.
	 * @return bool|null|string
	 */
	public static function get_comment_rating( $comment_id = 0 ) {
		global $wpdb;

		// check for cache
		$cache = wp_cache_get( &quot;gd_comment_rating_&quot;.$comment_id, &#039;gd_comment_rating&#039; );
		if($cache){
			return $cache;
		}

		$ratings = $wpdb-&gt;get_var(
			$wpdb-&gt;prepare(
				&quot;SELECT rating FROM &quot; . GEODIR_REVIEW_TABLE . &quot; WHERE comment_id = %d&quot;,
				array( $comment_id )
			)
		);

		if ( $ratings ) {
			// set cache
			wp_cache_set( &quot;gd_comment_rating_&quot;.$comment_id, $ratings, &#039;gd_comment_rating&#039; );

			return $ratings;
		} else {
			return false;
		}
	}

	/**
	 * Check whether user allowed to submit review or not.
	 *
	 * @since 2.0.0.91
	 *
	 * @param int $post_id The post ID.
	 * @param int $user_id The user ID. Default 0.
	 * @param string|null $author_email The author email. Default null.
	 * @return bool True if allowed or false.
	 */
	public static function can_submit_post_review( $post_id, $user_id = 0, $author_email = &#039;&#039; ) {
		$can_review = true;

		if ( ! current_user_can( &#039;manage_options&#039; ) &amp;&amp; GeoDir_Post_types::supports( get_post_type( $post_id ), &#039;single_review&#039; ) ) {
			$count_reviews = self::count_user_post_reviews( $post_id, $user_id, $author_email );

			if ( $count_reviews &gt; 0 ) {
				$can_review = false;
			}
		}

		return apply_filters( &#039;geodir_can_submit_post_review&#039;, $can_review, $post_id, $user_id, $author_email );
	}

	/**
	 * Count reviews per post submitted by the user.
	 *
	 * @since 2.0.0.91
	 *
	 * @global $wpdb WordPress database object.
	 *
	 * @param int $post_id The post ID.
	 * @param int $user_id The user ID. Default 0.
	 * @param string|null $author_email The author email. Default null.
	 * @return int Reviews count.
	 */
	public static function count_user_post_reviews( $post_id, $user_id = 0, $author_email = &#039;&#039; ) {
		global $wpdb;

		$count = 0;

		if ( empty( $post_id ) ) {
			return $count;
		}

		if ( empty( $user_id ) ) {
			if ( empty( $author_email ) ) {
				$user_id = (int) get_current_user_id(); 

				if ( empty( $user_id ) ) {
					$commenter = wp_get_current_commenter();
					if ( ! empty( $commenter ) &amp;&amp; is_array( $commenter ) &amp;&amp; ! empty( $commenter[&#039;comment_author_email&#039;] ) ) {
						$author_email = $commenter[&#039;comment_author_email&#039;];
					} else{
						$author_email = ( !empty( $_POST[&#039;email&#039;] )) ? sanitize_email( $_POST[&#039;email&#039;] ) : &#039;&#039;;
					}
				}
			}
		}

		if ( empty( $user_id ) &amp;&amp; empty( $author_email ) ) {
			return $count = 0;
		}

		$where = &quot;AND cmt.comment_approved = &#039;1&#039;&quot;;

		if ( ! geodir_cpt_has_rating_disabled( get_post_type( $post_id ) ) ) {
			$where .= &quot; AND r.rating &gt; 0&quot;;
		}

		if ( ! empty( $user_id ) ) {
			$where .= &quot; AND cmt.user_id = &quot; . (int) $user_id;
		}

		if ( ! empty( $author_email ) ) {
			$where .= &quot; AND cmt.comment_author_email = &#039;&quot; . $author_email . &quot;&#039;&quot;;
		}

		$sql = $wpdb-&gt;prepare( &quot;SELECT COUNT(*) FROM &quot; . GEODIR_REVIEW_TABLE . &quot; AS r JOIN {$wpdb-&gt;comments} AS cmt ON cmt.comment_ID = r.comment_id WHERE r.post_id = %d {$where}&quot;, array( $post_id ) );

		$sql = apply_filters( &#039;geodir_count_user_post_reviews_sql&#039;, $sql, $post_id, $user_id, $author_email );

		$count = (int) $wpdb-&gt;get_var( $sql );

		return apply_filters( &#039;geodir_count_user_post_reviews&#039;, $count, $post_id, $user_id, $author_email );
	}
}</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Geodirectory Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on May 12th, 2022 at 06:15 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1652336158"></script>
    <script src="../js/search.js?updated=1652336158"></script>
</body>
</html>
