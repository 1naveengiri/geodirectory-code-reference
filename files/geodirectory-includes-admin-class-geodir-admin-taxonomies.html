<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Geodirectory Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1652341136">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1652341136">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.png" alt="WPGeodirectory" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.wpgeodirectory.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://ayecode.io/careers/" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">Geodirectory Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/elementorpro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/elementorpro-modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Geodirectory.html"><abbr title="\Geodirectory">Geodirectory</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectory.html"><abbr title="\GeoDirectory">GeoDirectory</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/GeoDirectory-Templates.html"><abbr title="\GeoDirectory\Templates">Templates</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAbstracts.html"><abbr title="\GeoDirectoryAbstracts">GeoDirectoryAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAPI.html"><abbr title="\GeoDirectoryAPI">GeoDirectoryAPI</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClasses.html"><abbr title="\GeoDirectoryClasses">GeoDirectoryClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminFunctions.html"><abbr title="\GeoDirectoryAdminFunctions">GeoDirectoryAdminFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoruAdmin.html"><abbr title="\GeoDirectoruAdmin">GeoDirectoruAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdmin.html"><abbr title="\GeoDirectoryAdmin">GeoDirectoryAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirAdmin.html"><abbr title="\GeoDirAdmin">GeoDirAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectroyAdmin.html"><abbr title="\GeoDirectroyAdmin">GeoDirectroyAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminSystemStatus.html"><abbr title="\GeoDirectoryAdminSystemStatus">GeoDirectoryAdminSystemStatus</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminTools.html"><abbr title="\GeoDirectoryAdminTools">GeoDirectoryAdminTools</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminWidgets.html"><abbr title="\GeoDirectoryAdminWidgets">GeoDirectoryAdminWidgets</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesEmails.html"><abbr title="\GeoDirectoryClassesEmails">GeoDirectoryClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesData.html"><abbr title="\GeoDirectoryClassesData">GeoDirectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDIrectoryClassesData.html"><abbr title="\GeoDIrectoryClassesData">GeoDIrectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/ElementorPro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/ElementorPro-Modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryFunctions.html"><abbr title="\GeoDirectoryFunctions">GeoDirectoryFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryparamarraytermsAnarrayoftermobjects.html"><abbr title="\GeoDirectoryparamarraytermsAnarrayoftermobjects">GeoDirectoryparamarraytermsAnarrayoftermobjects</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WP.html"><abbr title="\WP">WP</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WP-Background.html"><abbr title="\WP\Background">Background</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryTemplates.html"><abbr title="\GeoDirectoryTemplates">GeoDirectoryTemplates</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-geodir-admin-taxonomies.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Handles taxonomies in admin
 *
 * @class    GeoDir_Admin_Taxonomies
 * @version  2.0.0
 */

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit; // Exit if accessed directly
}

/**
 * GeoDir_Admin_Taxonomies class.
 */
class GeoDir_Admin_Taxonomies {
    /**
     * Taxonomy.
     *
     * @var string
     * @access private
     * @since 2.0.0
     */
    private $taxonomy = &#039;&#039;;
    
    /**
     * Taxonomy type.
     *
     * @var string
     * @access private
     * @since 2.0.0
     */
    private $type = &#039;&#039;;

    /**
     * Constructor.
     */
    public function __construct() {


        // update term slug in details table when changed
        add_action(&#039;edited_term&#039;, array( $this, &#039;update_term_slug&#039;), 1, 3);
        add_action(&#039;create_term&#039;, array( $this, &#039;update_term_slug&#039;), 1, 3);

		// Update post data when term deleted
		add_action( &#039;delete_term&#039;, array( $this, &#039;on_delete_term&#039; ), 0, 5 );

        // filter function to check if term slug exists
        add_filter( &#039;geodir_term_slug_is_exists&#039;, array( $this,&#039;term_slug_is_exists&#039;), 0, 3);
        add_filter( &#039;geodir_term_slug_is_exists&#039;, array( $this,&#039;check_term_to_post_slug&#039;), 10, 3 );

        // make sure post slug is unique
        add_filter( &#039;wp_unique_post_slug&#039;, array( $this,&#039;check_post_to_term_slug&#039;), 101, 6 );

        if ( empty( $_REQUEST[&#039;taxonomy&#039;] ) ) {
            return;
        }
        
        $this-&gt;taxonomy = $_REQUEST[&#039;taxonomy&#039;];

        if ( !geodir_is_gd_taxonomy( $this-&gt;taxonomy ) ) {
            return;
        }
        
        $this-&gt;type = geodir_taxonomy_type( $this-&gt;taxonomy );

        if ( $this-&gt;type == &#039;category&#039; ) {
            // Add fields
            add_action( $this-&gt;taxonomy . &#039;_add_form_fields&#039;, array( $this, &#039;add_category_fields&#039; ), 10, 1 );
            add_action( $this-&gt;taxonomy . &#039;_edit_form_fields&#039;, array( $this, &#039;edit_category_fields&#039; ), 10, 2 );
            
            // Save fields
            add_action( &#039;create_term&#039;, array( $this, &#039;save_category_fields&#039; ), 10, 3 );
            add_action( &#039;edit_term&#039;, array( $this, &#039;save_category_fields&#039; ), 10, 3 );
            
            // Add columns
            add_filter( &#039;manage_edit-&#039; . $this-&gt;taxonomy . &#039;_columns&#039;, array( $this, &#039;get_columns&#039; ) );
            add_filter( &#039;manage_edit-&#039; . $this-&gt;taxonomy . &#039;_sortable_columns&#039;, array( $this, &#039;get_sortable_columns&#039; ), 10, 1 );
            add_filter( &#039;manage_&#039; . $this-&gt;taxonomy . &#039;_custom_column&#039;, array( $this, &#039;get_column&#039; ), 10, 3 );

            // update term icons on cat update/create
            add_action( &#039;created_term&#039;, array( $this, &#039;update_term_icons&#039;), 10, 3 );
            add_action( &#039;edited_term&#039;, array( $this, &#039;update_term_icons&#039;), 10, 3 );
        }
    }

    /**
     * Filters the unique post slug.
     *
     * @since 1.6.20
     *
     * @global object $wpdb WordPress Database object.
     *
     * @param string $slug          The post slug.
     * @param int    $post_ID       Post ID.
     * @param string $post_status   The post status.
     * @param string $post_type     Post type.
     * @param int    $post_parent   Post parent ID
     * @param string $original_slug The original post slug.
     */
    public function check_post_to_term_slug( $slug, $post_ID, $post_status, $post_type, $post_parent, $original_slug ) {
        global $wpdb;

        if ( $post_type &amp;&amp; strpos( $post_type, &#039;gd_&#039; ) === 0 ) {
            $posts_join = apply_filters( &#039;geodir_unique_post_slug_posts_join&#039;, &quot;&quot;, $post_ID, $post_type );
            $posts_where = apply_filters( &#039;geodir_unique_post_slug_posts_where&#039;, &quot;&quot;, $post_ID, $post_type );
            $terms_join = apply_filters( &#039;geodir_unique_post_slug_terms_join&#039;, &quot;&quot;, $post_ID, $post_type );
            $terms_where = apply_filters( &#039;geodir_unique_post_slug_terms_where&#039;, &quot;&quot;, $post_ID, $post_type );

            $term_slug_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT t.slug FROM $wpdb-&gt;terms AS t LEFT JOIN $wpdb-&gt;term_taxonomy AS tt ON tt.term_id = t.term_id {$terms_join} WHERE t.slug = &#039;%s&#039; AND ( tt.taxonomy = &#039;&quot; . $post_type . &quot;category&#039; OR tt.taxonomy = &#039;&quot; . $post_type . &quot;_tags&#039; ) {$terms_where} LIMIT 1&quot;, $slug ) );

            if ( $term_slug_check ) {
                $suffix = 1;

                do {
                    $alt_slug = _truncate_post_slug( $original_slug, 200 - ( strlen( $suffix ) + 1 ) ) . &quot;-$suffix&quot;;

                    $term_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT t.slug FROM $wpdb-&gt;terms AS t LEFT JOIN $wpdb-&gt;term_taxonomy AS tt ON tt.term_id = t.term_id {$terms_join} WHERE t.slug = &#039;%s&#039; AND ( tt.taxonomy = &#039;&quot; . $post_type . &quot;category&#039; OR tt.taxonomy = &#039;&quot; . $post_type . &quot;_tags&#039; ) {$terms_where} LIMIT 1&quot;, $alt_slug ) );

                    $post_check = !$term_check &amp;&amp; $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT p.post_name FROM $wpdb-&gt;posts p {$posts_join} WHERE p.post_name = %s AND p.post_type = %s AND p.ID != %d {$posts_where} LIMIT 1&quot;, $alt_slug, $post_type, $post_ID ) );

                    $term_slug_check = $term_check || $post_check;

                    $suffix++;
                } while ( $term_slug_check );

                $slug = $alt_slug;
            }
        }

        return $slug;
    }

    /**
     * Check whether a post name with slug exists or not.
     *
     * @since 1.6.20
     *
     * @global object $wpdb WordPress Database object.
     * @global array $gd_term_post_type Cached array for term post type.
     * @global array $gd_term_taxonomy Cached array for term taxonomy.
     *
     * @param bool $slug_exists Default: false.
     * @param string $slug Term slug.
     * @param int $term_id The term ID.
     * @return bool true when exists. false when not exists.
     */
    public function check_term_to_post_slug( $slug_exists, $slug, $term_id ) {
        global $wpdb, $gd_term_post_type, $gd_term_taxonomy;

        if ( $slug_exists ) {
            return $slug_exists;
        }

        if ( !empty( $gd_term_taxonomy ) &amp;&amp; isset($gd_term_taxonomy[$term_id]) ) {
            $taxonomy = $gd_term_taxonomy[$term_id];
        } else {
            $taxonomy = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT taxonomy FROM $wpdb-&gt;term_taxonomy WHERE term_id = %d LIMIT 1&quot;, $term_id ) );
            $gd_term_taxonomy[$term_id] = $taxonomy;
        }

        if ( empty($taxonomy) ) {
            return $slug_exists;
        }

        if ( !empty( $gd_term_post_type ) &amp;&amp; $gd_term_post_type[$term_id] ) {
            $post_type = $gd_term_post_type[$term_id];
        } else {
            $taxonomy_obj = get_taxonomy( $taxonomy );
            $post_type = !empty( $taxonomy_obj-&gt;object_type ) ? $taxonomy_obj-&gt;object_type[0] : NULL;
        }

        $posts_join = apply_filters( &#039;geodir_unique_term_slug_posts_join&#039;, &quot;&quot;, $term_id, $taxonomy, $post_type );
        $posts_where = apply_filters( &#039;geodir_unique_term_slug_posts_where&#039;, &quot;&quot;, $term_id, $taxonomy, $post_type );

        if ( $post_type &amp;&amp; $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT p.post_name FROM $wpdb-&gt;posts p {$posts_join} WHERE p.post_name = %s AND p.post_type = %s {$posts_where} LIMIT 1&quot;, $slug, $post_type ) ) ) {
            $slug_exists = true;
        }

        return $slug_exists;
    }


    /**
     * Check whether a term slug exists or not.
     *
     * @since 1.0.0
     * @package GeoDirectory
     * @global object $wpdb WordPress Database object.
     * @global string $table_prefix WordPress Database Table prefix.
     * @param bool $slug_exists Default: false.
     * @param string $slug Term slug.
     * @param int $term_id The term ID.
     * @return bool true when exists. false when not exists.
     */
    public function term_slug_is_exists( $slug_exists, $slug, $term_id ) {
        global $wpdb, $table_prefix, $geodirectory;

        if ( $slug_exists ) {
            return $slug_exists;
        }

        $default_location = $geodirectory-&gt;location-&gt;get_default_location();

        $country_slug = $default_location-&gt;country_slug;
        $region_slug = $default_location-&gt;region_slug;
        $city_slug = $default_location-&gt;city_slug;

        if ( $country_slug == $slug || $region_slug == $slug || $city_slug == $slug ) {
            return true;
        }

        // No longer required as we have category &amp; tags slug now.
        //if ($wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT slug FROM &quot; . $table_prefix . &quot;terms WHERE slug=%s AND term_id != %d&quot;, array($slug, $term_id))))
            //return $slug_exists = true;

        return $slug_exists;
    }

    /**
     * Update term slug.
     *
     * @since 1.0.0
     * @since 1.5.3 Modified to update tag in detail table when tag updated.
     * @package GeoDirectory
     * @global object $wpdb WordPress Database object.
     * @global string $plugin_prefix Geodirectory plugin table prefix.
     * @global string $table_prefix WordPress Database Table prefix.
     * @param int|string $term_id The term ID.
     * @param int $tt_id term Taxonomy ID.
     * @param string $taxonomy Taxonomy slug.
     */
    public function update_term_slug( $term_id, $tt_id, $taxonomy ) {
        global $wpdb, $plugin_prefix, $table_prefix;

        if ( ! geodir_is_gd_taxonomy( $taxonomy ) ) {
            return;
        }

        $tern_data = get_term_by( &#039;id&#039;, $term_id, $taxonomy );
        $slug = $tern_data-&gt;slug;

        /**
         * Filter if a term slug exists.
         *
         * @since 1.0.0
         * @package GeoDirectory
         * @param bool $bool Default: false.
         * @param string $slug The term slug.
         * @param int $term_id The term ID.
         */
        $slug_exists = apply_filters( &#039;geodir_term_slug_is_exists&#039;, false, $slug, $term_id );

        if ( $slug_exists ) {
            $suffix = 1;

            do {
                $new_slug = _truncate_post_slug( $slug, 200 - ( strlen( $suffix ) + 1 ) ) . &quot;-$suffix&quot;;

                /** This action is documented in geodirectory_hooks_actions.php */
                $term_slug_check = apply_filters( &#039;geodir_term_slug_is_exists&#039;, false, $new_slug, $term_id );

                $suffix++;
            } while ( $term_slug_check &amp;&amp; $suffix &lt; 100 );

            $slug = $new_slug;

            $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE &quot; . $wpdb-&gt;terms . &quot; SET slug = %s WHERE term_id = %d&quot;, array( $slug, $term_id ) ) );
        }

        // Update tag in detail table.
        if ( geodir_taxonomy_type( $taxonomy ) == &#039;tag&#039; &amp;&amp; geodir_is_gd_taxonomy( $taxonomy ) ) {
            $posts = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT object_id FROM &quot; . $wpdb-&gt;term_relationships . &quot; WHERE term_taxonomy_id = %d&quot;, array( $tt_id ) ) );

            if ( ! empty( $posts ) ) {
                $post_type = substr( $taxonomy, 0, strlen( $taxonomy ) - 5 );

                foreach ( $posts as $_post ) {
                    $post_id = $_post-&gt;object_id;

                    $object_terms = wp_get_object_terms( $post_id, $taxonomy, array( &#039;fields&#039; =&gt; &#039;names&#039; ) );
                    $post_tags = ! empty( $object_terms ) ? implode( &#039;,&#039;, $object_terms ) : &#039;&#039;;

                    $table = geodir_db_cpt_table( $post_type );
                    $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE `{$table}` SET post_tags = %s WHERE post_id = %d&quot;, array( $post_tags, $post_id ) ) );
                }
            }
        }
    }

    /**
     * Add fields to add category form.
     *
     * @since 2.0.0
     *
     * @param string $taxonomy Current taxonomy slug.
     */
    public function add_category_fields( $taxonomy ) {
        ?&gt;
        &lt;?php do_action( &#039;geodir_add_category_top&#039;, $taxonomy ); ?&gt;
        &lt;div class=&quot;form-field term-ct_cat_top_desc-wrap gd-term-form-field&quot;&gt;
            &lt;label for=&quot;ct_cat_top_desc&quot;&gt;&lt;?php _e( &#039;Category Top Description&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;
            &lt;?php echo $this-&gt;render_cat_top_desc(); ?&gt;
        &lt;/div&gt;
        &lt;?php do_action( &#039;geodir_add_category_after_cat_top_desc&#039;, $taxonomy ); ?&gt;
        &lt;div class=&quot;form-field term-ct_cat_default_img-wrap gd-term-form-field&quot;&gt;
            &lt;label for=&quot;ct_cat_default_img&quot;&gt;&lt;?php _e( &#039;Default Listing Image&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;
            &lt;?php echo $this-&gt;render_cat_default_img(); ?&gt;
        &lt;/div&gt;
        &lt;?php do_action( &#039;geodir_add_category_after_cat_default_img&#039;, $taxonomy ); ?&gt;
        &lt;div class=&quot;form-field term-ct_cat_icon-wrap gd-term-form-field&quot;&gt;
            &lt;label for=&quot;ct_cat_icon&quot;&gt;&lt;?php _e( &#039;Map Icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;
            &lt;?php echo $this-&gt;render_cat_icon(); ?&gt;
        &lt;/div&gt;
        &lt;?php do_action( &#039;geodir_add_category_after_cat_icon&#039;, $taxonomy ); ?&gt;
        
        &lt;div class=&quot;form-field term-ct_cat_font_icon-wrap gd-term-form-field&quot;&gt;
            &lt;label for=&quot;ct_cat_font_icon&quot;&gt;&lt;?php _e( &#039;Category Icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;
            &lt;?php echo $this-&gt;render_cat_font_icon(); ?&gt;
        &lt;/div&gt;
        &lt;?php do_action( &#039;geodir_add_category_after_cat_font_icon&#039;, $taxonomy ); ?&gt;

        &lt;div class=&quot;form-field term-ct_cat_color-wrap gd-term-form-field&quot;&gt;
            &lt;label for=&quot;ct_cat_color&quot;&gt;&lt;?php _e( &#039;Category Color&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;
            &lt;?php echo $this-&gt;render_cat_color(); ?&gt;
        &lt;/div&gt;
        &lt;?php do_action( &#039;geodir_add_category_after_cat_color&#039;, $taxonomy ); ?&gt;
        
        &lt;div class=&quot;form-field term-ct_cat_schema-wrap gd-term-form-field &quot;&gt;
            &lt;label for=&quot;ct_cat_schema&quot;&gt;&lt;?php _e( &#039;Schema Type&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;
            &lt;?php echo $this-&gt;render_cat_schema(); ?&gt;
        &lt;/div&gt;
        &lt;?php do_action( &#039;geodir_add_category_bottom&#039;, $taxonomy ); ?&gt;
        &lt;?php
    }

    /**
     * Add fields to edit category form.
     *
     * @since 2.0.0
     *
     * @param object $term     Current taxonomy term object.
     * @param string $taxonomy Current taxonomy slug.
     */
    public function edit_category_fields( $term, $taxonomy ) {
        //print_r(get_term_meta( $term-&gt;term_id));
        $cat_top_desc = get_term_meta( $term-&gt;term_id, &#039;ct_cat_top_desc&#039;, true );
        $cat_default_img = get_term_meta( $term-&gt;term_id, &#039;ct_cat_default_img&#039;, true );
        $cat_icon = get_term_meta( $term-&gt;term_id, &#039;ct_cat_icon&#039;, true );
        $cat_font_icon = get_term_meta( $term-&gt;term_id, &#039;ct_cat_font_icon&#039;, true );
        $cat_color = get_term_meta( $term-&gt;term_id, &#039;ct_cat_color&#039;, true );
        $cat_schema = get_term_meta( $term-&gt;term_id, &#039;ct_cat_schema&#039;, true );
        if ( !empty( $cat_default_img[&#039;id&#039;] ) ) {
            $cat_default_img[&#039;full&#039;] = geodir_get_cat_image( $term-&gt;term_id, true );
        }
        if ( !empty( $cat_icon[&#039;id&#039;] ) ) {
            $cat_icon[&#039;full&#039;] = geodir_get_cat_icon( $term-&gt;term_id, true );
        }
        ?&gt;
        &lt;?php do_action( &#039;geodir_edit_category_top&#039;, $term, $taxonomy ); ?&gt;
        &lt;tr class=&quot;form-field term-ct_cat_top_desc-wrap gd-term-form-field&quot;&gt;
            &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;ct_cat_top_desc&quot;&gt;&lt;?php _e( &#039;Category Top Description&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;&lt;?php echo $this-&gt;render_cat_top_desc( $cat_top_desc ); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php do_action( &#039;geodir_edit_category_after_cat_top_desc&#039;, $term, $taxonomy ); ?&gt;
        &lt;tr class=&quot;form-field term-ct_cat_default_img-wrap gd-term-form-field&quot;&gt;
            &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;ct_cat_default_img&quot;&gt;&lt;?php _e( &#039;Default Listing Image&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;&lt;?php echo $this-&gt;render_cat_default_img( $cat_default_img ); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php do_action( &#039;geodir_edit_category_after_cat_default_img&#039;, $term, $taxonomy ); ?&gt;
        &lt;tr class=&quot;form-field term-ct_cat_icon-wrap gd-term-form-field&quot;&gt;
            &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;ct_cat_icon&quot;&gt;&lt;?php _e( &#039;Map Icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;&lt;?php echo $this-&gt;render_cat_icon( $cat_icon ); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php do_action( &#039;geodir_edit_category_after_cat_icon&#039;, $term, $taxonomy ); ?&gt;

        &lt;tr class=&quot;form-field term-ct_cat_font_icon-wrap gd-term-form-field&quot;&gt;
            &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;ct_cat_font_icon&quot;&gt;&lt;?php _e( &#039;Category Icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;&lt;?php echo $this-&gt;render_cat_font_icon( $cat_font_icon ); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php do_action( &#039;geodir_edit_category_after_cat_font_icon&#039;, $term, $taxonomy ); ?&gt;

        &lt;tr class=&quot;form-field term-ct_cat_color-wrap gd-term-form-field&quot;&gt;
            &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;ct_cat_color&quot;&gt;&lt;?php _e( &#039;Category Color&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;&lt;?php echo $this-&gt;render_cat_color( $cat_color ); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php do_action( &#039;geodir_edit_category_after_cat_color&#039;, $term, $taxonomy ); ?&gt;


        &lt;tr class=&quot;form-field term-ct_cat_schema-wrap gd-term-form-field &quot;&gt;
            &lt;th scope=&quot;row&quot;&gt;&lt;label for=&quot;ct_cat_schema&quot;&gt;&lt;?php _e( &#039;Schema Type&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;&lt;?php echo $this-&gt;render_cat_schema( stripslashes( $cat_schema ) ); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php do_action( &#039;geodir_edit_category_bottom&#039;, $term, $taxonomy ); ?&gt;
        &lt;?php
    }

    /**
     * Render cat top description.
     *
     * @since 2.0.0
     *
     * @param string $content Optional. Render cat content. Default null.
     * @param string $id Optional. Cat ID. Default ct_cat_top_desc.
     * @param string $name Optional. Cat name. Default null.
     * @return string Description.
     */
    public function render_cat_top_desc( $content = &#039;&#039;, $id = &#039;ct_cat_top_desc&#039;, $name = &#039;&#039; ) {
        if ( empty( $name ) ) {
            $name = $id;
        }
        
        $settings = apply_filters( &#039;geodir_cat_top_desc_editor_settings&#039;, array( &#039;editor_height&#039; =&gt; 150, &#039;textarea_rows&#039; =&gt; 5, &#039;textarea_name&#039; =&gt; $name ), $content, $id, $name );
        
        ob_start();
        wp_editor( $content, $id, $settings );
        ?&gt;&lt;p class=&quot;description&quot;&gt;&lt;?php _e( &#039;This will appear at the top of the category listing.&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/p&gt;&lt;?php
        return ob_get_clean();
    }

    /**
     * Get Render category default image html.
     *
     * @since 2.0.0
     *
     * @param array $default_img Optional. Render cat image. Default array().
     * @param string $id Optional. Cat ID. Default ct_cat_default_img.
     * @param string $name Optional. Cat name. Default null.
     * @return string Render default image html.
     */
    public function render_cat_default_img( $default_img = array(), $id = &#039;ct_cat_default_img&#039;, $name = &#039;&#039; ) {
        if ( empty( $name ) ) {
            $name = $id;
        }
        
        $img_id = !empty( $default_img[&#039;id&#039;] ) ? $default_img[&#039;id&#039;] : &#039;&#039;;
        $img_src = !empty( $default_img[&#039;src&#039;] ) ? $default_img[&#039;src&#039;] : &#039;&#039;;
        $show_img = !empty( $default_img[&#039;full&#039;] ) ? $default_img[&#039;full&#039;] : admin_url( &#039;images/media-button-image.gif&#039; );
         
        ob_start();
        ?&gt;
        &lt;div class=&quot;gd-upload-img&quot; data-field=&quot;&lt;?php echo $name; ?&gt;&quot;&gt;
            &lt;div class=&quot;gd-upload-display thumbnail&quot;&gt;&lt;div class=&quot;centered&quot;&gt;&lt;img src=&quot;&lt;?php echo $show_img; ?&gt;&quot; /&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;div class=&quot;gd-upload-fields&quot;&gt;
                &lt;input type=&quot;hidden&quot; id=&quot;&lt;?php echo $id; ?&gt;[id]&quot; name=&quot;&lt;?php echo $name; ?&gt;[id]&quot; value=&quot;&lt;?php echo $img_id; ?&gt;&quot; /&gt;
                &lt;input type=&quot;hidden&quot; id=&quot;&lt;?php echo $id; ?&gt;[src]&quot; name=&quot;&lt;?php echo $name; ?&gt;[src]&quot; value=&quot;&lt;?php echo $img_src; ?&gt;&quot; /&gt;
                &lt;button type=&quot;button&quot; class=&quot;gd_upload_image_button button&quot;&gt;&lt;?php _e( &#039;Select Image&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/button&gt;
                &lt;button type=&quot;button&quot; class=&quot;gd_remove_image_button button&quot;&gt;&lt;?php _e( &#039;Remove Image&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;p class=&quot;description clear&quot;&gt;&lt;?php _e( &#039;Select a default image for the listing within this category.&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/p&gt;
        &lt;?php
        return ob_get_clean();
    }

    /**
     * Get render category icon html.
     *
     * @since 2.0.0
     *
     * @param array $cat_icon Optional. Default array.
     * @param string $id Optional. Cat ID. Default ct_cat_icon.
     * @param string $name Optional. Cat name. Default null.
     * @return string Category icon html
     */
    public function render_cat_icon( $cat_icon = array(), $id = &#039;ct_cat_icon&#039;, $name = &#039;&#039; ) {
        if ( empty( $name ) ) {
            $name = $id;
        }
        
        $img_id = !empty( $cat_icon[&#039;id&#039;] ) ? $cat_icon[&#039;id&#039;] : &#039;&#039;;
        $img_src = !empty( $cat_icon[&#039;src&#039;] ) ? $cat_icon[&#039;src&#039;] : &#039;&#039;;
        $show_img = !empty( $cat_icon[&#039;full&#039;] ) ? $cat_icon[&#039;full&#039;] : admin_url( &#039;images/media-button-image.gif&#039; );
         
        ob_start();
        ?&gt;
        &lt;div class=&quot;gd-upload-img&quot; data-field=&quot;&lt;?php echo $name; ?&gt;&quot;&gt;
            &lt;div class=&quot;gd-upload-display thumbnail&quot;&gt;&lt;div class=&quot;centered&quot;&gt;&lt;img src=&quot;&lt;?php echo $show_img; ?&gt;&quot; /&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;div class=&quot;gd-upload-fields&quot;&gt;
                &lt;input type=&quot;hidden&quot; id=&quot;&lt;?php echo $id; ?&gt;[id]&quot; name=&quot;&lt;?php echo $name; ?&gt;[id]&quot; value=&quot;&lt;?php echo $img_id; ?&gt;&quot; /&gt;
                &lt;input type=&quot;text&quot; id=&quot;&lt;?php echo $id; ?&gt;[src]&quot; name=&quot;&lt;?php echo $name; ?&gt;[src]&quot; value=&quot;&lt;?php echo $img_src; ?&gt;&quot; style=&quot;position:absolute;left:-500px;width:50px;&quot; /&gt;
                &lt;button type=&quot;button&quot; class=&quot;gd_upload_image_button button&quot;&gt;&lt;?php _e( &#039;Select Icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/button&gt;
                &lt;button type=&quot;button&quot; class=&quot;gd_remove_image_button button&quot;&gt;&lt;?php _e( &#039;Remove Icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;p class=&quot;description clear&quot;&gt;&lt;?php _e( &#039;Select a map icon, or pick a FontAwesome icon and color below to have one auto-generated. (if this field is empty)&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/p&gt;
        &lt;?php
        return ob_get_clean();
    }

    /**
     * Get render cat font icon html.
     *
     * @since 2.0.0
     *
     * @param string $cat_icon Optional. Font cat icon. Default null.
     * @param string $id Optional. Category id. Default ct_cat_font_icon.
     * @param string $name Optional. Category name. Default null.
     * @return string Font icon html.
     */
    public function render_cat_font_icon( $cat_icon = &#039;&#039;, $id = &#039;ct_cat_font_icon&#039;, $name = &#039;&#039; ) {
        if ( empty( $name ) ) {
            $name = $id;
        }
        ob_start();
        ?&gt;
        &lt;select
            name=&quot;&lt;?php echo esc_attr( $name ); ?&gt;&quot; id=&quot;&lt;?php echo esc_attr( $id ); ?&gt;&quot;
            class=&quot;regular-text geodir-select postform&quot;
            data-fa-icons=&quot;1&quot;  tabindex=&quot;-1&quot; aria-hidden=&quot;true&quot;
        &gt;
            &lt;?php
            include_once( dirname( __FILE__ ) . &#039;/settings/data_fontawesome.php&#039; );
            echo &quot;&lt;option value=&#039;&#039;&gt;&quot;.__(&#039;None&#039;,&#039;geodirectory&#039;).&quot;&lt;/option&gt;&quot;;
            foreach ( geodir_font_awesome_array() as $key =&gt; $val ) {
                ?&gt;
                &lt;option value=&quot;&lt;?php echo esc_attr( $key ); ?&gt;&quot; data-fa-icon=&quot;&lt;?php echo esc_attr( $key ); ?&gt;&quot; &lt;?php
                selected( $cat_icon, $key );
                ?&gt;&gt;&lt;?php echo $key ?&gt;&lt;/option&gt;
                &lt;?php
            }
            ?&gt;
        &lt;/select&gt;
        &lt;p class=&quot;description clear&quot;&gt;&lt;?php _e( &#039;Select a category icon&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/p&gt;
        &lt;?php
        return ob_get_clean();
    }

    /**
     * Get render cat color html.
     *
     * @since 2.0.0
     *
     * @param string $cat_color Optional. Category color. Default null.
     * @param string $id Optional. Category id. Default ct_cat_color.
     * @param string $name Optional. Category name. Default null.
     * @return string cat color html.
     */
    public function render_cat_color( $cat_color = &#039;&#039;, $id = &#039;ct_cat_color&#039;, $name = &#039;&#039;  ) {
        if ( empty( $name ) ) {
            $name = $id;
        }

        ob_start();
        ?&gt;
        &lt;input
            name=&quot;&lt;?php echo esc_attr( $name ); ?&gt;&quot; id=&quot;&lt;?php echo esc_attr( $id ); ?&gt;&quot;
            type=&quot;text&quot;
            dir=&quot;ltr&quot;
            value=&quot;&lt;?php echo esc_attr( $cat_color ); ?&gt;&quot;
            class=&quot;gd-color-picker&quot;
            placeholder=&quot;&lt;?php  ?&gt;&quot;
            data-default-color=&quot;&quot;/&gt;
        &lt;p class=&quot;description&quot;&gt;&lt;?php _e( &#039;Select the color to use for this category&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/p&gt;
        &lt;?php
        return ob_get_clean();
    }

    /**
     * Get render schema html.
     *
     * @since 2.0.0
     *
     * @param string $cat_schema Optional. Cat schema value. Default null.
     * @param string $id Optional. Cat id. Default ct_cat_schema.
     * @param string $name Optional. Cat name. Default null.
     * @return string Category schema html.
     */
    public function render_cat_schema( $cat_schema = &#039;&#039;, $id = &#039;ct_cat_schema&#039;, $name = &#039;&#039;  ) {
        $schemas = self::get_schemas();
        
        if ( empty( $name ) ) {
            $name = $id;
        }
        
        ob_start();
        ?&gt;
        &lt;select name=&quot;&lt;?php echo esc_attr( $name ); ?&gt;&quot; id=&quot;&lt;?php echo esc_attr( $id ); ?&gt;&quot; class=&quot;postform geodir-select&quot;&gt;
            &lt;?php foreach ( $schemas as $value =&gt; $label ) { ?&gt;
            &lt;option value=&quot;&lt;?php echo esc_attr( $value ); ?&gt;&quot; &lt;?php selected( $cat_schema == $value, true ); ?&gt;&gt;&lt;?php echo $label; ?&gt;&lt;/option&gt;
            &lt;?php } ?&gt;
        &lt;/select&gt;
        &lt;p class=&quot;description&quot;&gt;&lt;?php _e( &#039;Select the schema to use for this category&#039;, &#039;geodirectory&#039; ); ?&gt;&lt;/p&gt;
        &lt;?php
        return ob_get_clean();
    }

    /**
     * Save the category fields.
     *
     * @since 2.0.0
     *
     * @param int    $term_id  Term ID.
     * @param int    $tt_id    Term taxonomy ID.
     * @param string $taxonomy Taxonomy slug.
     */
    public function save_category_fields( $term_id, $tt_id = &#039;&#039;, $taxonomy = &#039;&#039; ) {
        // Category top description.
        if ( isset( $_POST[&#039;ct_cat_top_desc&#039;] ) ) {
            update_term_meta( $term_id, &#039;ct_cat_top_desc&#039;, $_POST[&#039;ct_cat_top_desc&#039;] );
        }
        
        // Category listing default image.
        if ( isset( $_POST[&#039;ct_cat_default_img&#039;] ) ) {
            $cat_default_img = $_POST[&#039;ct_cat_default_img&#039;];
            
            if ( !empty( $cat_default_img[&#039;src&#039;] ) ) {
                $cat_default_img[&#039;src&#039;] = geodir_file_relative_url( $cat_default_img[&#039;src&#039;] );
            } else {
                $cat_default_img = array();
            }
            
            update_term_meta( $term_id, &#039;ct_cat_default_img&#039;, $cat_default_img );
        }
        
        // Category icon.
        if ( isset( $_POST[&#039;ct_cat_icon&#039;] ) ) {
            $cat_icon = $_POST[&#039;ct_cat_icon&#039;];
            
            if ( !empty( $cat_icon[&#039;src&#039;] ) ) {
                $cat_icon[&#039;src&#039;] = geodir_file_relative_url( $cat_icon[&#039;src&#039;] );
            } elseif(!empty($_POST[&#039;ct_cat_font_icon&#039;])) {
                $cat_icon = $this-&gt;generate_cat_icon($_POST[&#039;ct_cat_font_icon&#039;],$_POST[&#039;ct_cat_color&#039;]);
            } else {
                $cat_icon = array();
            }

            update_term_meta( $term_id, &#039;ct_cat_icon&#039;, $cat_icon );
        }

        // Category font icon.
        if ( isset( $_POST[&#039;ct_cat_font_icon&#039;] ) ) {
            update_term_meta( $term_id, &#039;ct_cat_font_icon&#039;, sanitize_text_field( $_POST[&#039;ct_cat_font_icon&#039;] ) );
        }

        // Category color.
        if ( isset( $_POST[&#039;ct_cat_color&#039;] ) ) {
            update_term_meta( $term_id, &#039;ct_cat_color&#039;, sanitize_hex_color( $_POST[&#039;ct_cat_color&#039;] ) );
        }
        
        // Category schema.
        if ( isset( $_POST[&#039;ct_cat_schema&#039;] ) ) {
            update_term_meta( $term_id, &#039;ct_cat_schema&#039;, sanitize_text_field( $_POST[&#039;ct_cat_schema&#039;] ) );
        }
        
        do_action( &#039;geodir_term_save_category_fields&#039;, $term_id, $tt_id, $taxonomy );
    }

    /**
     * @param $term_id
     *
     * @return bool
     */
    public function regenerate_term_icon( $term_id ){
        $icon = get_term_meta($term_id,&#039;ct_cat_font_icon&#039;, true);
        $color = get_term_meta($term_id,&#039;ct_cat_color&#039;, true);

        if ( $icon &amp;&amp; $color ) {
            $this-&gt;generate_cat_icon($icon,$color);
            return true;
        }
        
        return false;
    }

    /**
     * @param $icon
     * @param $color
     *
     * @return array
     */
    public function generate_cat_icon($icon,$color){
        $cat_icon = array();

        if($icon &amp;&amp; $color){
            $background = !empty($color) ? ltrim (sanitize_hex_color($color),&#039;#&#039;) : &#039;ef5646&#039;;
            $fa_icon_parts = explode(&quot; &quot;,$icon);
            $fa_icon = !empty($fa_icon_parts[1]) ? sanitize_html_class($fa_icon_parts[0]).&quot; &quot;.sanitize_html_class($fa_icon_parts[1]) : &#039;fas fa-star&#039;;
            $icon_url = &quot;https://cdn.mapmarker.io/api/v1/font-awesome/v5/icon-stack?&quot;;
            $icon_url .= &quot;icon=&quot;.$fa_icon;
            $icon_url .= &quot;&amp;size=50&quot;;
            $icon_url .= &quot;&amp;color=fff&quot;;
            $icon_url .= &quot;&amp;on=fas fa-map-marker&quot;;
            $icon_url .= &quot;&amp;hoffset=0&quot;;
            $icon_url .= &quot;&amp;voffset=-4&quot;;
            // $icon_url .= &quot;&amp;iconSize=20&quot;; //goes off center if you set a size
            $icon_url .= &quot;&amp;oncolor=&quot;.$background;

            $image = (array) GeoDir_Media::get_external_media( $icon_url, $fa_icon,array(&#039;image/jpg&#039;, &#039;image/jpeg&#039;, &#039;image/gif&#039;, &#039;image/png&#039;, &#039;image/webp&#039;),array(&#039;ext&#039;=&gt;&#039;png&#039;,&#039;type&#039;=&gt;&#039;image/png&#039;) );

            if(!empty($image[&#039;url&#039;])){
                $attachment_id = GeoDir_Media::set_uploaded_image_as_attachment($image);
                if( $attachment_id ){
                    $cat_icon[&#039;id&#039;] = $attachment_id;
                    $cat_icon[&#039;src&#039;] = geodir_file_relative_url( $image[&#039;url&#039;] );

                }
            }
        }

        
        return $cat_icon;
    }

    public function get_fixed_icon_slug($slug){
        $fixed_slugs = array(

        );

        return $slug;
    }

    /**
     * Custom columns added to category admin.
     *
     * @param mixed $columns
     * @return array
     */
    public function get_columns( $columns ) {
        if ( isset( $columns[&#039;description&#039;] ) ) {
            unset( $columns[&#039;description&#039;] );
        }

        $columns[&#039;cat_icon&#039;] = &#039;Icon&#039;;
        $columns[&#039;cat_default_img&#039;] = __(&#039;Default Image&#039;, &#039;geodirectory&#039;);
        $columns[&#039;cat_ID_num&#039;] = __(&#039;Cat ID&#039;, &#039;geodirectory&#039;);

        return $columns;
    }
    
    /**
     * Get sortable columns.
     *
     * @param mixed $columns
     * @return array
     */
    public function get_sortable_columns( $columns ) {
        $columns[&#039;cat_ID_num&#039;] = &#039;term_id&#039;;
        
        return $columns;
    }

    /**
     * Custom column value added to category admin.
     *
     * @param string $columns
     * @param string $column
     * @param int $id
     * @return array
     */
    public function get_column( $columns, $column, $id ) {
        if ( $column == &#039;cat_ID_num&#039; ) {
            $columns .= $id;
        }
        
        if ( $column == &#039;cat_icon&#039; &amp;&amp; $icon = geodir_get_cat_icon( $id, true, true ) ) {
            $columns .= &#039;&lt;img src=&quot;&#039; . esc_url( $icon ) . &#039;&quot; /&gt;&#039;;
        }

        if ( $column == &#039;cat_default_img&#039; &amp;&amp; $image = geodir_get_cat_image( $id, true ) ) {
            $columns .= &#039;&lt;img src=&quot;&#039; . esc_url( $image ) . &#039;&quot; style=&quot;max-height:60px;max-width:60px;&quot; /&gt;&#039;;
        }

        return $columns;
    }

    /**
     * Taxonomy walker.
     *
     * @since 2.0.0
     * @since 2.0.0.66 Auto check/select option for a single category.
     *
     * @param string $cat_taxonomy Category taxonomy.
     * @param int $cat_parent Optional. Category parent ID. Default 0.
     * @param bool $hide_empty Optional. Taxonomy hide empty. Default false.
     * @param int $padding Optional. Padding value . Default 0.
     * @return string Taxonomy walker html.
     */
    public static function taxonomy_walker( $cat_taxonomy, $cat_parent = 0, $hide_empty = false, $padding = 0 ) {
        global $cat_display, $post_cat, $exclude_cats;

        $search_terms = trim( $post_cat, &quot;,&quot; );
        $search_terms = explode( &quot;,&quot;, $search_terms );

        $cat_terms = get_terms( array( &#039;taxonomy&#039; =&gt; $cat_taxonomy, &#039;parent&#039; =&gt; $cat_parent, &#039;hide_empty&#039; =&gt; $hide_empty, &#039;exclude&#039; =&gt; $exclude_cats ) );

        $display = &#039;&#039;;
        $onchange = &#039;&#039;;
        $term_check = &#039;&#039;;
        $main_list_class = &#039;&#039;;
        $out = &#039;&#039;;

        //If there are terms, start displaying
        if (count($cat_terms) &gt; 0) {
            //Displaying as a list
            $p = $padding * 20;
            $padding++;


            if ((!geodir_is_page(&#039;listing&#039;)) || (is_search() &amp;&amp; $_REQUEST[&#039;search_taxonomy&#039;] == &#039;&#039;)) {
                if ($cat_parent == 0) {
                    $list_class = &#039;main_list gd-parent-cats-list gd-cats-display-&#039; . $cat_display;
                    $main_list_class = &#039;main_list_selecter&#039;;
                } else {
                    //$display = &#039;display:none&#039;;
                    $list_class = &#039;sub_list gd-sub-cats-list&#039;;

                    if ( geodir_design_style() ) {
                        $list_class .= &#039; pl-3&#039;; // Left padding for sub-categories.
                    }
                }
            }

            if ($cat_display == &#039;checkbox&#039; || $cat_display == &#039;radio&#039;) {
                $p = 0;
                $out = &#039;&lt;div class=&quot;&#039; . $list_class . &#039; gd-cat-row-&#039; . $cat_parent . &#039;&quot; style=&quot;margin-left:&#039; . $p . &#039;px;&#039; . $display . &#039;;&quot;&gt;&#039;;

                if ( geodir_design_style() ) {
                    $main_list_class .= &#039; mr-1&#039;;
                }
            }

            if ( $main_list_class ) {
                $main_list_class = &#039;class=&quot;&#039; . $main_list_class . &#039;&quot;&#039;;
            }

            foreach ( $cat_terms as $cat_term ) {
                $checked = &#039;&#039;;
				$sub_out = &#039;&#039;;
				$no_child = false;

				if ( absint( $cat_parent ) == 0 &amp;&amp; count( $cat_terms ) == 1 ) {
					// Call recursion to print sub cats
					$sub_out = self::taxonomy_walker( $cat_taxonomy, $cat_term-&gt;term_id, $hide_empty, $padding );

					if ( trim( $sub_out ) == &#039;&#039; ) {
						$no_child = true; // Set category selected when only one category.
					}
				}

				if ( in_array( $cat_term-&gt;term_id, $search_terms ) || $no_child ) {
                    if ( $cat_display == &#039;select&#039; || $cat_display == &#039;multiselect&#039; )
                        $checked = &#039;selected=&quot;selected&quot;&#039;;
                    else
                        $checked = &#039;checked=&quot;checked&quot;&#039;;
                }

                $child_dash = $p &gt; 0 ? str_repeat( &quot;-&quot;, $p / 20 ) . &#039; &#039; : &#039;&#039;;

                if ($cat_display == &#039;radio&#039;)
                    $out .= &#039;&lt;span style=&quot;display:block&quot; &gt;&lt;input type=&quot;radio&quot; field_type=&quot;radio&quot; name=&quot;tax_input[&#039;.$cat_term-&gt;taxonomy .&#039;][]&quot; &#039; . $main_list_class . &#039; alt=&quot;&#039; . $cat_term-&gt;taxonomy . &#039;&quot; title=&quot;&#039; . geodir_utf8_ucfirst($cat_term-&gt;name) . &#039;&quot; value=&quot;&#039; . $cat_term-&gt;term_id . &#039;&quot; &#039; . $checked . $onchange . &#039; id=&quot;gd-cat-&#039; . $cat_term-&gt;term_id . &#039;&quot; data-cradio=&quot;default_category&quot;&gt;&#039; . $term_check . geodir_utf8_ucfirst($cat_term-&gt;name) . &#039;&lt;/span&gt;&#039;;
                elseif ($cat_display == &#039;select&#039; || $cat_display == &#039;multiselect&#039;)
                    $out .= &#039;&lt;option &#039; . $main_list_class . &#039; style=&quot;margin-left:&#039; . $p . &#039;px;&quot; alt=&quot;&#039; . $cat_term-&gt;taxonomy . &#039;&quot; title=&quot;&#039; . geodir_utf8_ucfirst($cat_term-&gt;name) . &#039;&quot; value=&quot;&#039; . $cat_term-&gt;term_id . &#039;&quot; &#039; . $checked . $onchange . &#039; &gt;&#039; . $term_check . $child_dash . geodir_utf8_ucfirst($cat_term-&gt;name) . &#039;&lt;/option&gt;&#039;;

                else {
					$class = $checked ? &#039;class=&quot;gd-term-checked&quot;&#039; : &#039;&#039;;
                    $out .= &#039;&lt;span style=&quot;display:block&quot; &#039; . $class . &#039;&gt;&lt;input style=&quot;display:inline-block&quot; type=&quot;checkbox&quot; field_type=&quot;checkbox&quot; name=&quot;tax_input[&#039;.$cat_term-&gt;taxonomy .&#039;][]&quot; &#039; . $main_list_class . &#039; alt=&quot;&#039; . $cat_term-&gt;taxonomy . &#039;&quot; title=&quot;&#039; . geodir_utf8_ucfirst($cat_term-&gt;name) . &#039;&quot; value=&quot;&#039; . $cat_term-&gt;term_id . &#039;&quot; &#039; . $checked . $onchange . &#039; id=&quot;gd-cat-&#039; . $cat_term-&gt;term_id . &#039;&quot; data-ccheckbox=&quot;default_category&quot;&gt;&#039; . $term_check . geodir_utf8_ucfirst($cat_term-&gt;name) . &#039;&lt;span class=&quot;gd-make-default-term&quot; style=&quot;display:none&quot; title=&quot;&#039; . esc_attr( wp_sprintf( __( &#039;Make %s default category&#039;, &#039;geodirectory&#039; ), geodir_utf8_ucfirst($cat_term-&gt;name) ) ) . &#039;&quot;&gt;&#039; . __( &#039;Make default&#039;, &#039;geodirectory&#039; ). &#039;&lt;/span&gt;&lt;span class=&quot;gd-is-default-term&quot; style=&quot;display:none&quot;&gt;&#039; . __( &#039;Default&#039;, &#039;geodirectory&#039; ). &#039;&lt;/span&gt;&lt;/span&gt;&#039;;
                }

                if ( ! ( absint( $cat_parent ) == 0 &amp;&amp; count( $cat_terms ) == 1 ) ) {
					// Call recursion to print sub cats
					$sub_out = self::taxonomy_walker( $cat_taxonomy, $cat_term-&gt;term_id, $hide_empty, $padding );
				}

				$out .= $sub_out;
            }

            if ( $cat_display == &#039;checkbox&#039; || $cat_display == &#039;radio&#039; )
                $out .= &#039;&lt;/div&gt;&#039;;

            return $out;
        }
        return &#039;&#039;;
    }

    /**
     * Get CPT taxonomy select.
     *
     * Check if $echo is true then select category html echo
     * else return select category html.
     *
     * @since 2.0.0
     *
     * @param string $post_type Optional. Post type. Default null.
     * @param string $selected Optional. Category selected. Default null.
     * @param bool $is_tag Optional. Is tag. Default false.
     * @param bool $echo Optional. Html echo. Default true.
     * @return string
     */
    public static function get_category_select($post_type = &#039;&#039;, $selected = &#039;&#039;, $is_tag = false, $echo = true){
        $html = &#039;&#039;;
        $taxonomies = geodir_get_taxonomies($post_type, $is_tag);

        $categories = get_terms($taxonomies);

        $html .= &#039;&lt;option value=&quot;0&quot;&gt;&#039; . __(&#039;All&#039;, &#039;geodirectory&#039;) . &#039;&lt;/option&gt;&#039;;

        foreach ($categories as $category_obj) {
            $select_opt = &#039;&#039;;
            if ($selected == $category_obj-&gt;term_id) {
                $select_opt = &#039;selected=&quot;selected&quot;&#039;;
            }
            $html .= &#039;&lt;option &#039; . $select_opt . &#039; value=&quot;&#039; . $category_obj-&gt;term_id . &#039;&quot;&gt;&#039;
                     . geodir_utf8_ucfirst($category_obj-&gt;name) . &#039;&lt;/option&gt;&#039;;
        }

        if ($echo)
            echo $html;
        else
            return $html;
    }

    /**
     * Return the schemas options as an array.
     * 
     * @return mixed|void
     */
    public static function get_schemas(){
        include_once( GEODIRECTORY_PLUGIN_DIR . &#039;includes/admin/settings/data_schemas.php&#039; );
        $raw_schemas = geodir_data_schemas();
        $schemas = array_merge(array(&#039;&#039; =&gt; __( &#039;Default (LocalBusiness)&#039;, &#039;geodirectory&#039; )), $raw_schemas);

        /*
		 * Allows you to add/filter the cat schema types.
		 *
		 * @since 1.5.7
		 */
        return apply_filters( &#039;geodir_cat_schemas&#039;, $schemas );
    }

    /**
     * Get the category top description html.
     *
     * @param int $term_id The term id.
     *
     * @return mixed|void
     */
    public static function get_cat_top_description( $term_id ) {
        $top_description = get_term_meta( $term_id, &#039;ct_cat_top_desc&#039;, true );

        if($top_description){
            // location variable
            $location_replace_vars = geodir_location_replace_vars();
            foreach($location_replace_vars as $lkey=&gt;$lval){
                if ( strpos( $top_description, $lkey ) !== false ) {
                    $top_description = str_replace( $lkey, $lval, $top_description );
                }
            }
        }
        
        return apply_filters( &#039;geodir_get_cat_top_description&#039;, $top_description, $term_id );
    }

    /**
     * Get the category default image.
     *
     * @param $term_id
     * @param bool $full_path
     *
     * @return mixed|void
     */
    public static function get_cat_image( $term_id, $full_path = false ) {
        $term_meta = get_term_meta( $term_id, &#039;ct_cat_default_img&#039;, true );

        $cat_image = is_array( $term_meta ) &amp;&amp; !empty( $term_meta[&#039;src&#039;] ) ? $term_meta[&#039;src&#039;] : &#039;&#039;;

        if ( $cat_image &amp;&amp; $full_path &amp;&amp; strpos( $cat_image, &#039;http://&#039; ) !== 0 &amp;&amp; strpos( $cat_image, &#039;https://&#039; ) !== 0 ) {
            $cat_image = geodir_file_relative_url( $cat_image, true );
        }

        return apply_filters( &#039;geodir_get_cat_image&#039;, $cat_image, $term_id, $full_path );
    }

    /**
     * Get the category icon url.
     *
     * @param $term_id
     * @param bool $full_path
     * @param bool $default
     *
     * @return mixed|void
     */
    public static function get_cat_icon( $term_id, $full_path = false, $default = false ) {
        $term_meta = get_term_meta( $term_id, &#039;ct_cat_icon&#039;, true );

        $cat_icon = is_array( $term_meta ) &amp;&amp; !empty( $term_meta[&#039;src&#039;] ) ? $term_meta[&#039;src&#039;] : &#039;&#039;;

        if ( !$cat_icon &amp;&amp; $default ) {
            $cat_icon = GeoDir_Maps::default_marker_icon( $full_path );
        }

        if ( $cat_icon &amp;&amp; $full_path ) {
            $cat_icon = geodir_file_relative_url( $cat_icon, true );
        }

        return apply_filters( &#039;geodir_get_cat_icon&#039;, $cat_icon, $term_id, $full_path, $default );
    }


    /**
     * Fires after a new term is created or term updated.
     *
     * @since 2.0.0
     *
     * @param int    $term_id  Term ID.
     * @param int    $tt_id    Term taxonomy ID.
     * @param string $taxonomy Taxonomy slug.
     */
    public static function update_term_icons( $term_id, $tt_id, $taxonomy ) {
        if ( geodir_is_gd_taxonomy( $taxonomy ) ) {
            geodir_update_option( &#039;gd_term_icons&#039;, &#039;&#039; ); // Rebuild term icons.
        }
    }

	/**
	 * Update post data on term delete.
	 *
	 * @since 2.0.0
	 *
	 * @global object $wpdb WordPress Database object.
	 *
	 * @param int     $term         Term ID.
	 * @param int     $tt_id        Term taxonomy ID.
	 * @param string  $taxonomy     Taxonomy slug.
	 * @param mixed   $deleted_term Copy of the already-deleted term, in the form specified
	 *                              by the parent function. WP_Error otherwise.
	 * @param array   $object_ids   List of term object IDs.
	 */
	public function on_delete_term( $term, $tt_id, $taxonomy = &#039;&#039;, $deleted_term = array(), $object_ids = array() ) {
		global $wpdb;

		if ( ! geodir_is_gd_taxonomy( $taxonomy ) ) {
            return;
        }

		if ( ! empty( $object_ids ) &amp;&amp; geodir_taxonomy_type( $taxonomy ) == &#039;tag&#039; &amp;&amp; ( $taxonomy_obj = get_taxonomy( $taxonomy ) ) ) {
			$post_type = !empty( $taxonomy_obj ) ? $taxonomy_obj-&gt;object_type[0] : &#039;&#039;;

			if ( $post_type ) {
				$table = geodir_db_cpt_table( $post_type );
			
				foreach ( $object_ids as $post_id ) {
					$post_tags = wp_get_object_terms( $post_id, $taxonomy, array( &#039;fields&#039; =&gt; &#039;names&#039; ) );
					$post_tags = ! empty( $post_tags ) &amp;&amp; ! is_wp_error( $post_tags ) ? array_map( &#039;trim&#039;, $post_tags ) : &#039;&#039;;
					$post_tags = ! empty( $post_tags ) ? implode( &#039;,&#039;, array_filter( array_unique( $post_tags ) ) ) : &#039;&#039;;

					$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$table} SET post_tags = %s WHERE post_id = %d&quot;, array( $post_tags, $post_id ) ) );
				}
			}
		}
	}

}

new GeoDir_Admin_Taxonomies();
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Geodirectory Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on May 12th, 2022 at 07:38 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1652341136"></script>
    <script src="../js/search.js?updated=1652341136"></script>
</body>
</html>
