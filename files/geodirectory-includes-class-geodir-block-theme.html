<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Geodirectory Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1652337338">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1652337338">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.png" alt="WPGeodirectory" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">Geodirectory Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/elementorpro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/elementorpro-modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Geodirectory.html"><abbr title="\Geodirectory">Geodirectory</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectory.html"><abbr title="\GeoDirectory">GeoDirectory</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/GeoDirectory-Templates.html"><abbr title="\GeoDirectory\Templates">Templates</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAbstracts.html"><abbr title="\GeoDirectoryAbstracts">GeoDirectoryAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAPI.html"><abbr title="\GeoDirectoryAPI">GeoDirectoryAPI</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClasses.html"><abbr title="\GeoDirectoryClasses">GeoDirectoryClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminFunctions.html"><abbr title="\GeoDirectoryAdminFunctions">GeoDirectoryAdminFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoruAdmin.html"><abbr title="\GeoDirectoruAdmin">GeoDirectoruAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdmin.html"><abbr title="\GeoDirectoryAdmin">GeoDirectoryAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirAdmin.html"><abbr title="\GeoDirAdmin">GeoDirAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectroyAdmin.html"><abbr title="\GeoDirectroyAdmin">GeoDirectroyAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminSystemStatus.html"><abbr title="\GeoDirectoryAdminSystemStatus">GeoDirectoryAdminSystemStatus</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminTools.html"><abbr title="\GeoDirectoryAdminTools">GeoDirectoryAdminTools</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminWidgets.html"><abbr title="\GeoDirectoryAdminWidgets">GeoDirectoryAdminWidgets</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesEmails.html"><abbr title="\GeoDirectoryClassesEmails">GeoDirectoryClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesData.html"><abbr title="\GeoDirectoryClassesData">GeoDirectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDIrectoryClassesData.html"><abbr title="\GeoDIrectoryClassesData">GeoDIrectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/ElementorPro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/ElementorPro-Modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryFunctions.html"><abbr title="\GeoDirectoryFunctions">GeoDirectoryFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryparamarraytermsAnarrayoftermobjects.html"><abbr title="\GeoDirectoryparamarraytermsAnarrayoftermobjects">GeoDirectoryparamarraytermsAnarrayoftermobjects</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WP.html"><abbr title="\WP">WP</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WP-Background.html"><abbr title="\WP\Background">Background</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryTemplates.html"><abbr title="\GeoDirectoryTemplates">GeoDirectoryTemplates</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-geodir-block-theme.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * GeoDir_Block_Theme class
 *
 * @package GeoDirectory
 * @since   2.2.4
 */

// Exit if accessed directly
if ( ! defined( &#039;ABSPATH&#039; ) ) exit;

/**
 * GeoDir_Block_Theme class.
 */
class GeoDir_Block_Theme {

	/**
	 * GeoDirectory plugin slug
	 *
	 * This is used to save templates to the DB which are stored against this value in the wp_terms table.
	 *
	 * @var string
	 */
	const PLUGIN_SLUG = &#039;geodirectory/geodirectory&#039;;

	/**
	 * Directory name of the block template directory.
	 *
	 * @var string
	 */
	const TEMPLATES_DIR_NAME = &#039;block-templates&#039;;

	/**
	 * Directory name of the block template parts directory.
	 *
	 * @var string
	 */
	const TEMPLATE_PARTS_DIR_NAME = &#039;block-template-parts&#039;;

	/**
	 * Init.
	 *
	 * @since 2.2.4
	 */
	public static function init() {
		add_action( &#039;init&#039;, array( __CLASS__, &#039;on_init&#039; ), 20 );
		add_filter( &#039;geodir_page_options&#039;, array( __CLASS__, &#039;pages_settings&#039; ), 10, 1 );
		add_filter( &#039;geodir_cpt_page_options&#039;, array( __CLASS__, &#039;cpt_pages_settings&#039; ), 10, 3 );
		add_action( &#039;template_redirect&#039;, array( __CLASS__, &#039;render_block_template&#039; ) );
		add_filter( &#039;pre_get_block_file_template&#039;, array( __CLASS__, &#039;maybe_return_blocks_template&#039; ), 10, 3 );
		add_filter( &#039;get_block_templates&#039;, array( __CLASS__, &#039;set_block_templates&#039; ), 10, 3 );
		add_filter( &#039;geodirectory_screen_ids&#039;, array( __CLASS__, &#039;set_screen_id&#039; ), 10, 1 );

		add_filter( &#039;archive_template_hierarchy&#039;, array( __CLASS__, &#039;set_template_hierarchy&#039; ), 10, 1 );
		add_filter( &#039;page_template_hierarchy&#039;, array( __CLASS__, &#039;set_template_hierarchy&#039; ), 10, 1 );
		add_filter( &#039;search_template_hierarchy&#039;, array( __CLASS__, &#039;set_template_hierarchy&#039; ), 10, 1 );
		add_filter( &#039;single_template_hierarchy&#039;, array( __CLASS__, &#039;set_template_hierarchy&#039; ), 10, 1 );
	}

	/**
	 * Load style on FSE.
	 *
	 * @since 2.2.4
	 */
	public static function on_init() {
		// For FSE iframe
		if ( geodir_design_style() ) {
			wp_register_style(&#039;geodir-fse&#039;, geodir_plugin_url() . &#039;/assets/css/admin.css&#039;, array( &#039;font-awesome&#039;, &#039;ayecode-ui&#039; ), GEODIRECTORY_VERSION );
		} else {
			wp_register_style(&#039;geodir-fse&#039;, geodir_plugin_url() . &#039;/assets/css/block_editor.css&#039;, array( &#039;wp-edit-blocks&#039;, &#039;font-awesome&#039; ), GEODIRECTORY_VERSION );
		}

		register_block_type(
			&#039;geodirectory/fse-styles&#039;, 
			array(
				&#039;editor_style&#039; =&gt; &#039;geodir-fse&#039; 
			)
		);
	}

	/*
	 * Setup general pages settings.
	 *
	 * @since 2.2.4
	 */
	public static function pages_settings( $settings ) {
		$default_post_type = geodir_get_default_posttype();

		$settings = apply_filters( &#039;geodir_wp_template_options&#039;, array(
			array(
				&#039;title&#039; =&gt; __( &#039;Page Settings&#039;, &#039;geodirectory&#039; ),
				&#039;type&#039; =&gt; &#039;title&#039;,
				&#039;desc&#039; =&gt; &#039;These are essential pages used by GD, you can set the pages here and edit the title/slug of the page via WP page settings.&#039;,
				&#039;id&#039; =&gt; &#039;page_options&#039;,
				&#039;desc_tip&#039; =&gt; true,
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Location Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use for locations&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_location&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_location&#039;,
				&#039;default_content&#039; =&gt; GeoDir_Defaults::page_location_content( false, true ),
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; __( &#039;Auto (GD Location)&#039;, &#039;geodirectory&#039; ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Add Listing Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use for adding listings&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_add&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_add&#039;,
				&#039;default_content&#039; =&gt; GeoDir_Defaults::page_add_content( false, true ),
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; __( &#039;Auto (GD Add Listing)&#039;, &#039;geodirectory&#039; ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				),
				&#039;view_page_args&#039; =&gt; array( 
					&#039;listing_type&#039; =&gt; $default_post_type
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Search Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use as the GD Search page&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_search&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_search&#039;,
				&#039;default_content&#039; =&gt; GeoDir_Defaults::page_search_content( false, true ),
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; __( &#039;Auto (GD Search)&#039;, &#039;geodirectory&#039; ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				),
				&#039;view_page_args&#039; =&gt; array( 
					&#039;geodir_search&#039; =&gt; 1,
					&#039;stype&#039; =&gt; $default_post_type,
					&#039;s&#039; =&gt; &#039;&#039;
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Terms and Conditions page&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the page to use for your terms and conditions.&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;page_terms_conditions&#039;,
				&#039;type&#039; =&gt; &#039;single_select_page&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;default_content&#039; =&gt; __(&#039;ENTER YOUR SITE TERMS AND CONDITIONS HERE&#039;,&#039;geodirectory&#039;)
			),
			array(
				&#039;type&#039; =&gt; &#039;sectionend&#039;,
				&#039;id&#039; =&gt; &#039;page_options&#039;
			),

			array(
				&#039;title&#039; =&gt; __( &#039;Template Page Settings&#039;, &#039;geodirectory&#039; ),
				&#039;type&#039; =&gt; &#039;title&#039;,
				&#039;desc&#039; =&gt; &#039;Template pages are used to design the respective pages and should never be linked to directly.&#039;,
				&#039;id&#039; =&gt; &#039;page_template_options&#039;,
				&#039;desc_tip&#039; =&gt; true,
			),

			array(
				&#039;name&#039; =&gt; __( &#039;Single Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use as the GD Single page template&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_details&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;is_template_page&#039; =&gt; true,
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_details&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;default_content&#039; =&gt; GeoDir_Defaults::page_details_content( false, true ),
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; __( &#039;Auto (GD Single)&#039;, &#039;geodirectory&#039; ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Archive Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use for GD archives such as taxonomy and CPT pages.&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_archive&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;is_template_page&#039; =&gt; true,
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_archive&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;default_content&#039; =&gt; GeoDir_Defaults::page_archive_content( false, true ),
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; __( &#039;Auto (GD Archive)&#039;, &#039;geodirectory&#039; ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Archive item page&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the page to use for GD archive items, this is the item template used on taxonomy and CPT pages&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;page_archive_item&#039;,
				&#039;type&#039; =&gt; &#039;single_select_page&#039;,
				&#039;is_template_page&#039; =&gt; true,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;default_content&#039; =&gt; GeoDir_Defaults::page_archive_item_content(),
			),
			array(
				&#039;type&#039; =&gt; &#039;sectionend&#039;,
				&#039;id&#039; =&gt; &#039;page_template_options&#039;
			),
		));

		return $settings;
	}

	/*
	 * Setup CPT pages settings.
	 *
	 * @since 2.2.4
	 */
	public static function cpt_pages_settings( $settings, $post_type_values, $post_type ) {
		$template_add = (int) geodir_get_option( &#039;template_add&#039; );
		$template_single = (int) geodir_get_option( &#039;template_details&#039; );
		$template_archive = (int) geodir_get_option( &#039;template_archive&#039; );

		if ( $template_add &amp;&amp; ( $_template_add_title = get_the_title( $template_add ) ) ) {
			$template_add_title = $_template_add_title;
		} else {
			$template_add_title = __( &#039;GD Add Listing&#039;, &#039;geodirectory&#039; );
		}

		if ( $template_single &amp;&amp; ( $_template_single_title = get_the_title( $template_single ) ) ) {
			$template_single_title = $_template_single_title;
		} else {
			$template_single_title = __( &#039;GD Single&#039;, &#039;geodirectory&#039; );
		}

		if ( $template_archive &amp;&amp; ( $_template_single_archive = get_the_title( $template_archive ) ) ) {
			$template_archive_title = $_template_single_archive;
		} else {
			$template_archive_title = __( &#039;GD Archive&#039;, &#039;geodirectory&#039; );
		}

		$settings = array(
			array(
				&#039;title&#039;    =&gt; __( &#039;Template Page Settings&#039;, &#039;geodirectory&#039; ),
				&#039;type&#039;     =&gt; &#039;title&#039;,
				&#039;desc&#039;     =&gt; __( &#039;Template pages are used to design the respective pages and should never be linked to directly.&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039;       =&gt; &#039;cpt_settings_page&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;advanced&#039; =&gt; true,
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Add Listing Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use as the GD add listing page template&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_add&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;advanced&#039; =&gt; true,
				&#039;value&#039; =&gt; $post_type_values[&#039;template_add&#039;],
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_add&#039;,
				&#039;page_cpt&#039; =&gt; $post_type,
				&#039;view_page_args&#039; =&gt; array( 
					&#039;listing_type&#039; =&gt; $post_type
				),
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; wp_sprintf( __( &#039;Default (%s)&#039;, &#039;geodirectory&#039; ), $template_add_title ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Single Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use as the GD details page template&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_details&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;is_template_page&#039; =&gt; true,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;advanced&#039; =&gt; true,
				&#039;value&#039; =&gt; $post_type_values[&#039;template_details&#039;],
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_details&#039;,
				&#039;page_cpt&#039; =&gt; $post_type,
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; wp_sprintf( __( &#039;Default (%s)&#039;, &#039;geodirectory&#039; ), $template_single_title ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Archive Template&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the template to use for GD archives such as taxonomy and CPT pages&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;template_archive&#039;,
				&#039;type&#039; =&gt; &#039;single_wp_template&#039;,
				&#039;is_template_page&#039; =&gt; true,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;advanced&#039; =&gt; true,
				&#039;value&#039; =&gt; $post_type_values[&#039;template_archive&#039;],
				&#039;create_template&#039; =&gt; true,
				&#039;page_option&#039; =&gt; &#039;page_archive&#039;,
				&#039;page_cpt&#039; =&gt; $post_type,
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; wp_sprintf( __( &#039;Default (%s)&#039;, &#039;geodirectory&#039; ), $template_archive_title ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;name&#039; =&gt; __( &#039;Archive Item Page&#039;, &#039;geodirectory&#039; ),
				&#039;desc&#039; =&gt; __( &#039;Select the page to use for GD archive items, this is the item template used on taxonomy and CPT pages&#039;, &#039;geodirectory&#039; ),
				&#039;id&#039; =&gt; &#039;page_archive_item&#039;,
				&#039;type&#039; =&gt; &#039;single_select_page&#039;,
				&#039;is_template_page&#039; =&gt; true,
				&#039;class&#039; =&gt; &#039;geodir-select&#039;,
				&#039;desc_tip&#039; =&gt; true,
				&#039;advanced&#039; =&gt; true,
				&#039;value&#039; =&gt; $post_type_values[&#039;page_archive_item&#039;],
				&#039;args&#039; =&gt; array(
					&#039;show_option_none&#039; =&gt; wp_sprintf( __( &#039;Default (%s)&#039;, &#039;geodirectory&#039; ), get_the_title( geodir_get_option( &#039;page_archive_item&#039; ) ) ),
					&#039;option_none_value&#039; =&gt; &#039;0&#039;,
					&#039;sort_column&#039; =&gt; &#039;post_title&#039;,
				)
			),
			array(
				&#039;type&#039; =&gt; &#039;sectionend&#039;,
				&#039;id&#039; =&gt; &#039;cpt_settings_page&#039;
			)
		);

		$settings = apply_filters( &#039;geodir_cpt_wp_template_options&#039;, $settings, $post_type_values, $post_type );

		return $settings;
	}

	/**
	 * Set GD pages template hierarchy.
	 *
	 * @since 2.2.4
	 *
	 * @params array $templates Templates array.
	 * @return array Filtered templates.
	 */
	public static function set_template_hierarchy( $templates ) {
		if ( geodir_is_geodir_page() ) {
			$offset = false;

			if ( geodir_is_page( &#039;location&#039; ) ) {
				// Location
				$offset = 0;
				$push = array();

				$template_id = (int) geodir_location_template_id();

				if ( $template_id &amp;&amp; ( $template_slug = get_post_field( &#039;post_name&#039;, $template_id ) ) ) {
					$push[] = $template_slug;
				}

				$push[] = &#039;gd-location.php&#039;;
			} else if ( geodir_is_page( &#039;add-listing&#039; ) ) {
				// Add Listing
				$post_type = geodir_get_current_posttype();
				$offset = 0;
				$push = array();

				$template_id = (int) geodir_add_listing_template_id( $post_type );

				if ( $template_id &amp;&amp; ( $template_slug = get_post_field( &#039;post_name&#039;, $template_id ) ) ) {
					$push[] = $template_slug;
				}

				$push[] = &#039;gd-add-listing.php&#039;;
			}  else if ( geodir_is_page( &#039;single&#039; ) ) {
				// GD Single
				$post_type = geodir_get_current_posttype();
				$offset = 0;
				$push = array();

				$template_id = (int) geodir_details_template_id( $post_type );

				if ( $template_id &amp;&amp; ( $template_slug = get_post_field( &#039;post_name&#039;, $template_id ) ) ) {
					$push[] = $template_slug;
				}

				$push[] = &#039;single-&#039; . $post_type . &#039;.php&#039;;
				$push[] = &#039;gd-single.php&#039;;
			} else if ( geodir_is_page( &#039;search&#039; ) ) {
				// Search
				$post_type = geodir_get_current_posttype();
				$offset = 0;
				$push = array();

				$template_id = (int) geodir_search_template_id( $post_type );

				if ( $template_id &amp;&amp; ( $template_slug = get_post_field( &#039;post_name&#039;, $template_id ) ) ) {
					$push[] = $template_slug;
				}

				$push[] = &#039;gd-search.php&#039;;
				$push[] = &#039;gd-archive.php&#039;;
			} else if ( geodir_is_page( &#039;archive&#039; ) ) {
				// Archive
				$post_type = geodir_get_current_posttype();
				$offset = 0;
				$push = array();

				if ( is_tax() &amp;&amp; ( $term_id = get_queried_object_id() ) ) {
					$taxonomy = get_query_var( &#039;taxonomy&#039; );

					if ( $taxonomy == $post_type . &#039;category&#039; || $taxonomy == $post_type . &#039;_tags&#039; ) {
						$push[] = &#039;taxonomy-&#039; . $taxonomy . &#039;-&#039; . $term_id . &#039;.php&#039;;
						$push[] = &#039;taxonomy-&#039; . $taxonomy . &#039;.php&#039;;
					}
				}

				$template_id = (int) geodir_archive_template_id( $post_type );

				if ( $template_id &amp;&amp; ( $template_slug = get_post_field( &#039;post_name&#039;, $template_id ) ) ) {
					$push[] = $template_slug;
				} else {
					$offset = in_array( &#039;archive-&#039; . $post_type . &#039;.php&#039;, $templates ) ? array_search( &#039;archive-&#039; . $post_type . &#039;.php&#039;, array_values( $templates ) ) + 1 : 0;
				}

				if ( is_tax() ) {
					$push[] = &#039;gd-taxonomy.php&#039;;
				}
				$push[] = &#039;archive-&#039; . $post_type . &#039;.php&#039;;
				$push[] = &#039;gd-archive.php&#039;;
			}

			if ( $offset !== false ) {
				$templates = array_merge( array_slice( $templates, 0, $offset ), $push, array_slice( $templates, $offset ) );
				$templates = array_unique( $templates );
			}
		}

		return $templates;
	}

	/**
	 * Checks to see if they are using a compatible version of WP.
	 *
	 * @since 2.2.4
	 *
	 * @return boolean
	 */
	public static function supports_block_templates() {
		if ( function_exists( &#039;wp_is_block_theme&#039; ) &amp;&amp; wp_is_block_theme() ) {
			return true;
		}

		return false;
	}

	/**
	 * Load AUI on site editor.
	 *
	 * @since 2.2.4
	 *
	 * @return array
	 */
	public static function set_screen_id( $aui_screens ) {
		global $current_screen;

		if ( ! empty( $current_screen ) &amp;&amp; ( $current_screen instanceof WP_Screen ) &amp;&amp; $current_screen-&gt;id == &#039;site-editor&#039; &amp;&amp; self::supports_block_templates() &amp;&amp; function_exists( &#039;wp_should_load_block_editor_scripts_and_styles&#039; ) &amp;&amp; wp_should_load_block_editor_scripts_and_styles() ) {
			$aui_screens[] = &#039;site-editor&#039;;
		}

		return $aui_screens;
	}

	/**
	 * Add the block template objects to be used.
	 *
	 * @since 2.2.4
	 *
	 * @param array $query_result Array of template objects.
	 * @param array $query Optional. Arguments to retrieve templates.
	 * @param array $template_type wp_template or wp_template_part.
	 * @return array
	 */
	public static function set_block_templates( $query_result, $query, $template_type ) {
		if ( ! self::supports_block_templates() ) {
			return $query_result;
		}

		$post_type      = isset( $query[&#039;post_type&#039;] ) ? $query[&#039;post_type&#039;] : &#039;&#039;;
		$slugs          = isset( $query[&#039;slug__in&#039;] ) ? $query[&#039;slug__in&#039;] : array();
		$template_files = self::get_block_templates( $slugs, $template_type );

		foreach ( $template_files as $template_file ) {
			// Avoid adding the same template if it&#039;s already in the array of $query_result.
			if (
				array_filter(
					$query_result,
					function( $query_result_template ) use ( $template_file ) {
						return $query_result_template-&gt;slug === $template_file-&gt;slug &amp;&amp; $query_result_template-&gt;theme === $template_file-&gt;theme;
					}
				)
			) {
				continue;
			}

			// If the current $post_type is set (e.g. on an Edit Post screen), and isn&#039;t included in the available post_types
			// on the template file, then lets skip it so that it doesn&#039;t get added. This is typically used to hide templates
			// in the template dropdown on the Edit Post page.
			if ( $post_type &amp;&amp; isset( $template_file-&gt;post_types ) &amp;&amp; ! in_array( $post_type, $template_file-&gt;post_types, true ) ) {
				continue;
			}

			// It would be custom if the template was modified in the editor, so if it&#039;s not custom we can load it from
			// the filesystem.
			if ( &#039;custom&#039; !== $template_file-&gt;source ) {
				$template = self::gutenberg_build_template_result_from_file( $template_file, $template_type );
			} else {
				$template_file-&gt;title = self::convert_slug_to_title( $template_file-&gt;slug );
				$query_result[]       = $template_file;
				continue;
			}

			$is_not_custom   = false === array_search( wp_get_theme()-&gt;get_stylesheet() . &#039;//&#039; . $template_file-&gt;slug, array_column( $query_result, &#039;id&#039; ), true );
			$fits_slug_query = ! isset( $query[&#039;slug__in&#039;] ) || in_array( $template_file-&gt;slug, $query[&#039;slug__in&#039;], true );
			$fits_area_query = ! isset( $query[&#039;area&#039;] ) || $template_file-&gt;area === $query[&#039;area&#039;];
			$should_include  = $is_not_custom &amp;&amp; $fits_slug_query &amp;&amp; $fits_area_query;
			if ( $should_include ) {
				$query_result[] = $template;
			}
		}

		$query_result = self::remove_theme_templates_with_custom_alternative( $query_result );

		return $query_result;
	}

	/**
	 * Get and build the block template objects from the block template files.
	 *
	 * @since 2.2.4
	 *
	 * @param array $slugs An array of slugs to retrieve templates for.
	 * @param array $template_type wp_template or wp_template_part.
	 *
	 * @return array
	 */
	public static function get_block_templates( $slugs = array(), $template_type = &#039;wp_template&#039; ) {
		$templates_from_db  = self::get_block_templates_from_db( $slugs, $template_type );
		$templates_from_gd = self::get_block_templates_from_gd( $slugs, $templates_from_db, $template_type );

		return array_merge( $templates_from_db, $templates_from_gd );
	}

	/**
	 * Gets the templates saved in the database.
	 *
	 * @since 2.2.4
	 *
	 * @param array $slugs An array of slugs to retrieve templates for.
	 * @param array $template_type wp_template or wp_template_part.
	 *
	 * @return int[]|\WP_Post[] An array of found templates.
	 */
	public static function get_block_templates_from_db( $slugs = array(), $template_type = &#039;wp_template&#039; ) {
		// This was the previously incorrect slug used to save DB templates against.
		$invalid_plugin_slug = &#039;geodirectory&#039;;

		$check_query_args = array(
			&#039;post_type&#039;      =&gt; $template_type,
			&#039;posts_per_page&#039; =&gt; -1,
			&#039;no_found_rows&#039;  =&gt; true,
			&#039;tax_query&#039;      =&gt; array( // phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_tax_query
				array(
					&#039;taxonomy&#039; =&gt; &#039;wp_theme&#039;,
					&#039;field&#039;    =&gt; &#039;name&#039;,
					&#039;terms&#039;    =&gt; array( $invalid_plugin_slug, self::PLUGIN_SLUG, get_stylesheet() ),
				),
			),
		);

		if ( is_array( $slugs ) &amp;&amp; count( $slugs ) &gt; 0 ) {
			$check_query_args[&#039;post_name__in&#039;] = $slugs;
		}

		$check_query         = new \WP_Query( $check_query_args );
		$saved_gd_templates = $check_query-&gt;posts;

		return array_map(
			function( $saved_gd_template ) {
				return self::gutenberg_build_template_result_from_post( $saved_gd_template );
			},
			$saved_gd_templates
		);
	}

	/**
	 * Gets the templates from the GD blocks directory, skipping those for which a template already exists
	 * in the theme directory.
	 *
	 * @since 2.2.4
	 *
	 * @param string[] $slugs An array of slugs to filter templates by. Templates whose slug does not match will not be returned.
	 * @param array    $already_found_templates Templates that have already been found, these are customised templates that are loaded from the database.
	 * @param string   $template_type wp_template or wp_template_part.
	 * @return array Templates from the GD blocks plugin directory.
	 */
	public static function get_block_templates_from_gd( $slugs, $already_found_templates, $template_type = &#039;wp_template&#039; ) {
		$directory      = self::get_templates_directory( $template_type );
		$template_files = _get_block_templates_paths( $directory );
		$templates      = array();

		if ( &#039;wp_template_part&#039; === $template_type ) {
			$dir_name = self::TEMPLATE_PARTS_DIR_NAME;
		} else {
			$dir_name = self::TEMPLATES_DIR_NAME;
		}

		foreach ( $template_files as $template_file ) {
			$template_slug = self::generate_template_slug_from_path( $template_file, $dir_name );

			// This template does not have a slug we&#039;re looking for. Skip it.
			if ( is_array( $slugs ) &amp;&amp; count( $slugs ) &gt; 0 &amp;&amp; ! in_array( $template_slug, $slugs, true ) ) {
				continue;
			}

			// If the theme already has a template, or the template is already in the list (i.e. it came from the
			// database) then we should not overwrite it with the one from the filesystem.
			if (
				self::theme_has_template( $template_slug ) ||
				count(
					array_filter(
						$already_found_templates,
						function ( $template ) use ( $template_slug ) {
							$template_obj = (object) $template; //phpcs:ignore WordPress.CodeAnalysis.AssignmentInCondition.Found
							return $template_obj-&gt;slug === $template_slug;
						}
					)
				) &gt; 0 ) {
				continue;
			}

			// At this point the template only exists in the Blocks filesystem and has not been saved in the DB,
			// or superseded by the theme.
			$templates[] = self::create_new_block_template_object( $template_file, $template_type, $template_slug );
		}

		return $templates;
	}

	/**
	 * Build a unified template object based a post Object.
	 *
	 * @since 2.2.4
	 *
	 * @param \WP_Post $post Template post.
	 * @return \WP_Block_Template|\WP_Error Template.
	 */
	public static function gutenberg_build_template_result_from_post( $post ) {
		$terms = get_the_terms( $post, &#039;wp_theme&#039; );

		if ( is_wp_error( $terms ) ) {
			return $terms;
		}

		if ( ! $terms ) {
			return new \WP_Error( &#039;template_missing_theme&#039;, __( &#039;No theme is defined for this template.&#039;, &#039;geodirectory&#039; ) );
		}

		$theme          = $terms[0]-&gt;name;
		$has_theme_file = true;

		$template                 = new \WP_Block_Template();
		$template-&gt;wp_id          = $post-&gt;ID;
		$template-&gt;id             = $theme . &#039;//&#039; . $post-&gt;post_name;
		$template-&gt;theme          = $theme;
		$template-&gt;content        = $post-&gt;post_content;
		$template-&gt;slug           = $post-&gt;post_name;
		$template-&gt;source         = &#039;custom&#039;;
		$template-&gt;type           = $post-&gt;post_type;
		$template-&gt;description    = $post-&gt;post_excerpt;
		$template-&gt;title          = $post-&gt;post_title;
		$template-&gt;status         = $post-&gt;post_status;
		$template-&gt;has_theme_file = $has_theme_file;
		$template-&gt;is_custom      = false;
		$template-&gt;post_types     = array();

		if ( &#039;wp_template_part&#039; === $post-&gt;post_type ) {
			$type_terms = get_the_terms( $post, &#039;wp_template_part_area&#039; );

			if ( ! is_wp_error( $type_terms ) &amp;&amp; false !== $type_terms ) {
				$template-&gt;area = $type_terms[0]-&gt;name;
			}
		}

		if ( self::PLUGIN_SLUG === $theme ) {
			$template-&gt;origin = &#039;plugin&#039;;
		}

		return $template;
	}

	/**
	 * Converts template paths into a slug
	 *
	 * @since 2.2.4
	 *
	 * @param string $path The template&#039;s path.
	 * @param string $directory_name The template&#039;s directory name.
	 * @return string slug
	 */
	public static function generate_template_slug_from_path( $path, $directory_name = &#039;block-templates&#039; ) {
		return substr(
			$path,
			strpos( $path, $directory_name . DIRECTORY_SEPARATOR ) + 1 + strlen( $directory_name ),
			-5
		);
	}

	/**
	 * Gets the directory where templates of a specific template type can be found.
	 *
	 * @since 2.2.4
	 *
	 * @param array $template_type wp_template or wp_template_part.
	 * @return string
	 */
	public static function get_templates_directory( $template_type = &#039;wp_template&#039; ) {
		$templates_dir = untrailingslashit( geodir_get_templates_dir() ) . &#039;/&#039;;

		if ( $design_style = geodir_design_style() ) {
			$templates_dir .= $design_style . &#039;/&#039;;
		}

		if ( &#039;wp_template_part&#039; === $template_type ) {
			return $templates_dir . self::TEMPLATE_PARTS_DIR_NAME;
		}

		return $templates_dir . self::TEMPLATES_DIR_NAME;
	}

	/**
	 * Checks whether a block template with that name exists in GD Blocks
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_name Template to check.
	 * @param array  $template_type wp_template or wp_template_part.
	 * @return boolean
	 */
	public static function block_template_is_available( $template_name, $template_type = &#039;wp_template&#039; ) {
		if ( ! $template_name ) {
			return false;
		}
		$directory = self::get_templates_directory( $template_type ) . &#039;/&#039; . $template_name . &#039;.html&#039;;

		return is_readable( $directory ) || self::get_block_templates( array( $template_name ), $template_type );
	}

	/**
	 * Renders the default block template from GD Blocks if no theme templates exist.
	 *
	 * @since 2.2.4
	 */
	public static function render_block_template() {
		if ( is_embed() || ! self::supports_block_templates() ) {
			return;
		}

		if ( ! geodir_is_geodir_page() ) {
			return;
		}

		$post_type = geodir_get_current_posttype();

		if ( geodir_is_singular() &amp;&amp; ! self::theme_has_template( &#039;single-&#039; . $post_type ) &amp;&amp; self::block_template_is_available( &#039;single-&#039; . $post_type ) ) {
			add_filter( &#039;geodir_has_block_template&#039;, &#039;__return_true&#039;, 10 );
		} elseif ( ( geodir_is_taxonomy() &amp;&amp; is_tax( $post_type . &#039;category&#039; ) ) &amp;&amp; ! self::theme_has_template( $post_type . &#039;category&#039; ) &amp;&amp; self::block_template_is_available( $post_type . &#039;category&#039; ) ) {
			add_filter( &#039;geodir_has_block_template&#039;, &#039;__return_true&#039;, 10 );
		} elseif ( ( geodir_is_taxonomy() &amp;&amp; is_tax( $post_type . &#039;_tags&#039; ) ) &amp;&amp; ! self::theme_has_template( $post_type . &#039;_tags&#039; ) &amp;&amp; self::block_template_is_available( $post_type . &#039;_tags&#039; ) ) {
			add_filter( &#039;geodir_has_block_template&#039;, &#039;__return_true&#039;, 10 );
		} elseif ( geodir_is_post_type_archive() &amp;&amp; ! ( self::theme_has_template( &#039;archive-&#039; . $post_type ) || self::theme_has_template( &#039;gd-archive&#039; ) ) &amp;&amp; ( self::block_template_is_available( &#039;archive-&#039; . $post_type ) || self::block_template_is_available( &#039;gd-archive&#039; ) ) ) {
			add_filter( &#039;geodir_has_block_template&#039;, &#039;__return_true&#039;, 10 );
		}
	}

	/**
	 * Check if the theme has a template. So we know if to load our own in or not.
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_name name of the template file without .html extension e.g. &#039;gd-location&#039;.
	 * @return boolean
	 */
	public static function theme_has_template( $template_name ) {
		return is_readable( get_template_directory() . &#039;/block-templates/&#039; . $template_name . &#039;.html&#039; ) || is_readable( get_stylesheet_directory() . &#039;/block-templates/&#039; . $template_name . &#039;.html&#039; );
	}

	/**
	 * Check if the theme has a template. So we know if to load our own in or not.
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_name name of the template file without .html extension e.g. &#039;gd-location&#039;.
	 * @return boolean
	 */
	public static function theme_has_template_part( $template_name ) {
		return is_readable( get_template_directory() . &#039;/block-template-parts/&#039; . $template_name . &#039;.html&#039; ) || is_readable( get_stylesheet_directory() . &#039;/block-template-parts/&#039; . $template_name . &#039;.html&#039; );
	}

	/**
	 * Build a new template object so that we can make GD Blocks default templates available in the current theme should they not have any.
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_file Block template file path.
	 * @param string $template_type wp_template or wp_template_part.
	 * @param string $template_slug Block template slug e.g. gd-location.
	 * @param bool   $template_is_from_theme If the block template file is being loaded from the current theme instead of GD Blocks.
	 *
	 * @return object Block template object.
	 */
	public static function create_new_block_template_object( $template_file, $template_type, $template_slug, $template_is_from_theme = false ) {
		$theme_name = wp_get_theme()-&gt;get( &#039;TextDomain&#039; );

		$new_template_item = array(
			&#039;slug&#039;        =&gt; $template_slug,
			&#039;id&#039;          =&gt; $template_is_from_theme ? $theme_name . &#039;//&#039; . $template_slug : self::PLUGIN_SLUG . &#039;//&#039; . $template_slug,
			&#039;path&#039;        =&gt; $template_file,
			&#039;type&#039;        =&gt; $template_type,
			&#039;theme&#039;       =&gt; $template_is_from_theme ? $theme_name : self::PLUGIN_SLUG,
			&#039;source&#039;      =&gt; $template_is_from_theme ? &#039;theme&#039; : &#039;plugin&#039;,
			&#039;title&#039;       =&gt; self::convert_slug_to_title( $template_slug ),
			&#039;description&#039; =&gt; self::get_block_description( $template_slug ),
			&#039;post_types&#039;  =&gt; array(), // Don&#039;t appear in any Edit Post template selector dropdown.
		);

		return (object) $new_template_item;
	}

	/**
	 * Converts template slugs into readable titles.
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_slug The templates slug (e.g. gd-location).
	 * @return string Human friendly title converted from the slug.
	 */
	public static function convert_slug_to_title( $template_slug ) {
		switch ( $template_slug ) {
			case &#039;gd-location&#039;:
				return __( &#039;GD Location&#039;, &#039;geodirectory&#039; );
			case &#039;gd-search&#039;:
				return __( &#039;GD Search&#039;, &#039;geodirectory&#039; );
			case &#039;gd-add-listing&#039;:
				return __( &#039;GD Add Listing&#039;, &#039;geodirectory&#039; );
			case &#039;gd-archive&#039;:
				return __( &#039;GD Archive&#039;, &#039;geodirectory&#039; );
			case &#039;gd-single&#039;:
				return __( &#039;GD Single&#039;, &#039;geodirectory&#039; );
			default:
				// Replace all hyphens and underscores with spaces.
				return ucwords( preg_replace( &#039;/[\-_]/&#039;, &#039; &#039;, $template_slug ) );
		}
	}

	/**
	 * Converts page option to template slug.
	 *
	 * @since 2.2.4
	 *
	 * @param string $page The page option (e.g. location).
	 * @return string Human friendly title converted from the slug.
	 */
	public static function convert_page_to_slug( $page ) {
		switch ( $page ) {
			case &#039;location&#039;:
			case &#039;template_location&#039;:
				return &#039;gd-location&#039;;
			case &#039;search&#039;:
			case &#039;template_search&#039;:
				return &#039;gd-search&#039;;
			case &#039;add&#039;:
			case &#039;template_add&#039;:
			case &#039;add_listing&#039;:
			case &#039;template_add_listing&#039;:
				return &#039;gd-add-listing&#039;;
			case &#039;archive&#039;:
			case &#039;template_archive&#039;:
				return &#039;gd-archive&#039;;
			case &#039;details&#039;:
			case &#039;template_details&#039;:
			case &#039;single&#039;:
			case &#039;template_single&#039;:
				return &#039;gd-single&#039;;
			default:
				return $page;
		}
	}

	/**
	 * Get the block template description.
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_slug The templates slug (e.g. gd-location).
	 * @return string Block template description.
	 */
	public static function get_block_description( $template_slug ) {
		switch ( $template_slug ) {
			case &#039;gd-location&#039;:
				return __( &#039;Displays GD location page content.&#039;, &#039;geodirectory&#039; );
			case &#039;gd-search&#039;:
				return __( &#039;Displays GD search results.&#039;, &#039;geodirectory&#039; );
			case &#039;gd-add-listing&#039;:
				return __( &#039;Displays GD Add Listing page content.&#039;, &#039;geodirectory&#039; );
			case &#039;gd-archive&#039;:
				return __( &#039;Displays GD post categories, tags, and other archives.&#039;, &#039;geodirectory&#039; );
			case &#039;gd-single&#039;:
				return __( &#039;Displays GD single page content.&#039;, &#039;geodirectory&#039; );
			default:
				return &#039;&#039;;
		}
	}

	/**
	 * Build a unified template object based on a theme file.
	*
	 * @since 2.2.4
	 *
	 * @param array $template_file Theme file.
	 * @param array $template_type wp_template or wp_template_part.
	 * @return \WP_Block_Template Template.
	 */
	public static function gutenberg_build_template_result_from_file( $template_file, $template_type ) {
		$template_file = (object) $template_file;

		// If the theme has an archive-gd_place.html template but does not have post taxonomy templates
		// then we will load in the archive-gd_place.html template from the theme to use for post taxonomies on the frontend.
		$template_is_from_theme = &#039;theme&#039; === $template_file-&gt;source;
		$theme_name             = wp_get_theme()-&gt;get( &#039;TextDomain&#039; );

		$template_content  = file_get_contents( $template_file-&gt;path ); // phpcs:ignore WordPress.WP.AlternativeFunctions.file_get_contents_file_get_contents
		$template          = new \WP_Block_Template();
		$template-&gt;id      = $template_is_from_theme ? $theme_name . &#039;//&#039; . $template_file-&gt;slug : self::PLUGIN_SLUG . &#039;//&#039; . $template_file-&gt;slug;
		$template-&gt;theme   = $template_is_from_theme ? $theme_name : self::PLUGIN_SLUG;
		$template-&gt;content = _inject_theme_attribute_in_block_template_content( $template_content );
		$template-&gt;source         = $template_file-&gt;source ? $template_file-&gt;source : &#039;plugin&#039;;
		$template-&gt;slug           = $template_file-&gt;slug;
		$template-&gt;type           = $template_type;
		$template-&gt;title          = ! empty( $template_file-&gt;title ) ? $template_file-&gt;title : self::convert_slug_to_title( $template_file-&gt;slug );
		$template-&gt;status         = &#039;publish&#039;;
		$template-&gt;has_theme_file = true;
		$template-&gt;origin         = $template_file-&gt;source;
		$template-&gt;is_custom      = false;
		$template-&gt;post_types     = array();
		if ( &#039;wp_template_part&#039; === $template_type ) {
			$template-&gt;area = &#039;uncategorized&#039;;
		}

		return $template;
	}

	/**
	 * Removes templates that were added to a theme&#039;s block-templates directory, but already had a customised version saved in the database.
	 *
	 * @since 2.2.4
	 *
	 * @param \WP_Block_Template[]|\stdClass[] $templates List of templates to run the filter on.
	 * @return array List of templates with duplicates removed. The customised alternative is preferred over the theme default.
	 */
	public static function remove_theme_templates_with_custom_alternative( $templates ) {
		// Get the slugs of all templates that have been customised and saved in the database.
		$customised_template_slugs = array_map(
			function( $template ) {
				return $template-&gt;slug;
			},
			array_values(
				array_filter(
					$templates,
					function( $template ) {
						// This template has been customised and saved as a post.
						return &#039;custom&#039; === $template-&gt;source;
					}
				)
			)
		);

		// Remove theme (i.e. filesystem) templates that have the same slug as a customised one. We don&#039;t need to check
		// for `geodirectory` in $template-&gt;source here because geodirectory templates won&#039;t have been added to $templates
		// if a saved version was found in the db. This only affects saved templates that were saved BEFORE a theme
		// template with the same slug was added.
		return array_values(
			array_filter(
				$templates,
				function( $template ) use ( $customised_template_slugs ) {
					// This template has been customised and saved as a post, so return it.
					return ! ( &#039;theme&#039; === $template-&gt;source &amp;&amp; in_array( $template-&gt;slug, $customised_template_slugs, true ) );
				}
			)
		);
	}

	/**
	 * This function checks if there&#039;s a blocks template to return to pre_get_posts short-circuiting the query in Gutenberg.
	 *
	 * @since 2.2.4
	 *
	 * @param \WP_Block_Template|null $template Return a block template object to short-circuit the default query,
	 *                                               or null to allow WP to run its normal queries.
	 * @param string                  $id Template unique identifier (example: theme_slug//template_slug).
	 * @param array                   $template_type wp_template or wp_template_part.
	 *
	 * @return mixed|\WP_Block_Template|\WP_Error
	 */
	public static function maybe_return_blocks_template( $template, $id, $template_type ) {
		// &#039;get_block_template&#039; was introduced in WP 5.9.
		if ( ! function_exists( &#039;get_block_template&#039; ) ) {
			return $template;
		}

		$template_name_parts = explode( &#039;//&#039;, $id );
		if ( count( $template_name_parts ) &lt; 2 ) {
			return $template;
		}
		list( , $slug ) = $template_name_parts;

		// Remove the filter at this point because if we don&#039;t then this function will infinite loop.
		remove_filter( &#039;pre_get_block_file_template&#039;, array( __CLASS__, &#039;maybe_return_blocks_template&#039; ), 10, 3 );

		// Check if the theme has a saved version of this template before falling back to the GD one. Please note how
		// the slug has not been modified at this point, we&#039;re still using the default one passed to this hook.
		$maybe_template = get_block_template( $id, $template_type );

		if ( null !== $maybe_template ) {
			add_filter( &#039;pre_get_block_file_template&#039;, array( __CLASS__, &#039;maybe_return_blocks_template&#039; ), 10, 3 );
			return $maybe_template;
		}

		// Theme-based template didn&#039;t exist, try switching the theme to geodirectory and try again. This function has
		// been unhooked so won&#039;t run again.
		add_filter( &#039;get_block_file_template&#039;, array( __CLASS__, &#039;get_single_block_template&#039; ), 10, 3 );

		$maybe_template = get_block_template( self::PLUGIN_SLUG . &#039;//&#039; . $slug, $template_type );

		// Re-hook this function, it was only unhooked to stop recursion.
		add_filter( &#039;pre_get_block_file_template&#039;, array( __CLASS__, &#039;maybe_return_blocks_template&#039; ), 10, 3 );
		remove_filter( &#039;get_block_file_template&#039;, array( __CLASS__, &#039;get_single_block_template&#039; ), 10, 3 );

		if ( null !== $maybe_template ) {
			return $maybe_template;
		}

		return $template;
	}

	/**
	 * Runs on the get_block_template hook. If a template is already found and passed to this function, then return it
	 * and don&#039;t run.
	 * If a template is *not* passed, try to look for one that matches the ID in the database, if that&#039;s not found defer
	 * to Blocks templates files. Priority goes: DB-Theme, DB-Blocks, Filesystem-Theme, Filesystem-Blocks.
	 *
	 * @since 2.2.4
	 *
	 * @param \WP_Block_Template $template The found block template.
	 * @param string             $id Template unique identifier (example: theme_slug//template_slug).
	 * @param array              $template_type wp_template or wp_template_part.
	 *
	 * @return mixed|null
	 */
	public static function get_single_block_template( $template, $id, $template_type ) {
		// The template was already found before the filter runs, just return it immediately.
		if ( null !== $template ) {
			return $template;
		}

		$template_name_parts = explode( &#039;//&#039;, $id );
		if ( count( $template_name_parts ) &lt; 2 ) {
			return $template;
		}
		list( , $slug ) = $template_name_parts;

		// If this blocks template doesn&#039;t exist then we should just skip the function and let Gutenberg handle it.
		if ( ! self::block_template_is_available( $slug, $template_type ) ) {
			return $template;
		}

		$available_templates = self::get_block_templates( array( $slug ), $template_type );

		return ( is_array( $available_templates ) &amp;&amp; count( $available_templates ) &gt; 0 ) ? self::gutenberg_build_template_result_from_file( $available_templates[0], $available_templates[0]-&gt;type ) : $template;
	}

	/**
	 * Checks whether a block template with requested name exists or not.
	 *
	 * @since 2.2.4
	 *
	 * @param string $template_name Template to check.
	 * @return boolean
	 */
	public static function has_block_template( $template_name ) {
		if ( ! $template_name ) {
			return false;
		}

		$has_template            = false;
		$template_filename       = $template_name . &#039;.html&#039;;

		// Combine the possible root directory names with either the template directory
		// or the stylesheet directory for child themes, getting all possible block templates
		// locations combinations.
		$filepath        = DIRECTORY_SEPARATOR . &#039;templates&#039; . DIRECTORY_SEPARATOR . $template_filename;
		$possible_paths  = array(
			get_stylesheet_directory() . $filepath,
			get_template_directory() . $filepath,
		);

		// Check the first matching one.
		foreach ( $possible_paths as $path ) {
			if ( is_readable( $path ) ) {
				$has_template = true;
				break;
			}
		}

		/**
		 * Filters the value of the result of the block template check.
		 *
		 * @since 2.2.4
		 *
		 * @param boolean $has_template value to be filtered.
		 * @param string $template_name The name of the template.
		 */
		return (bool) apply_filters( &#039;geodir_has_block_template&#039;, $has_template, $template_name );
	}

	/**
	 * Handle the new WP template request.
	 *
	 * @since 2.2.4
	 */
	public static function handle_new_template_request( $request ) {
		$response = self::process_new_template_request( $request );

		if ( is_wp_error( $response ) ) {
			$message = aui()-&gt;alert(
				array(
					&#039;type&#039;=&gt; &#039;warning&#039;,
					&#039;content&#039;=&gt; $response-&gt;get_error_message(),
					&#039;class&#039; =&gt; &#039;geodir-new-tmpl-msg mb-3 text-left&#039;
				)
			);
			wp_send_json_error( array( &#039;message&#039; =&gt; $message ) );
		} else {
			if ( ! empty( $response[&#039;message&#039;] ) ) {
				$response[&#039;message&#039;] = aui()-&gt;alert(
					array(
						&#039;type&#039;=&gt; &#039;success&#039;,
						&#039;content&#039;=&gt; $response[&#039;message&#039;],
						&#039;class&#039; =&gt; &#039;geodir-new-tmpl-msg m-3 text-left&#039;
					)
				);
			}

			wp_send_json_success( $response );
		}
	}

	/**
	 * Process the new WP template request.
	 *
	 * @since 2.2.4
	 */
	public static function process_new_template_request( $request ) {
		global $wpdb;

		$page = ! empty( $request[&#039;gd_page&#039;] ) ? sanitize_text_field( $request[&#039;gd_page&#039;] ) : &#039;&#039;;
		$post_type = ! empty( $request[&#039;gd_post_type&#039;] ) ? sanitize_text_field( $request[&#039;gd_post_type&#039;] ) : &#039;&#039;;
		$cpt_name = ! empty( $request[&#039;gd_cpt_name&#039;] ) ? sanitize_text_field( $request[&#039;gd_cpt_name&#039;] ) : &#039;&#039;;

		if ( empty( $page ) ) {
			return new WP_Error( &#039;invalid_page&#039;, __( &#039;Invalid page.&#039;, &#039;geodirectory&#039; ) );
		}

		$template_content = self::get_default_wp_template_html( $page );

		if ( empty( $template_content ) ) {
			return new WP_Error( &#039;invalid_page&#039;, __( &#039;Page template not found.&#039;, &#039;geodirectory&#039; ) );
		}

		$template_name = self::convert_page_to_slug( $page );

		$_post_title = __( &#039;%s (Custom)&#039;, &#039;geodirectory&#039; );

		if ( ! empty( $cpt_name ) ) {
			$_post_title = __( &#039;%s (&#039; . $cpt_name . &#039;)&#039;, &#039;geodirectory&#039; );
		}

		if ( ! empty( $post_type ) &amp;&amp; geodir_is_gd_post_type( $post_type ) &amp;&amp; ( $cpt_name = geodir_post_type_name( $post_type ) ) ) {
			$_post_title = __( &#039;%s (&#039; . $cpt_name . &#039;)&#039;, &#039;geodirectory&#039; );
		}

		$term = get_term_by( &#039;name&#039;, wp_get_theme()-&gt;get_stylesheet(), &#039;wp_theme&#039; );
		$term_ids = ! is_wp_error( $term ) &amp;&amp; ! empty( $term-&gt;term_id ) ? array( $term-&gt;term_id ) : 0;

		$args = array(
			&#039;post_title&#039; =&gt; wp_sprintf( $_post_title, self::convert_slug_to_title( $template_name ) ),
			&#039;post_content&#039; =&gt; $template_content,
			&#039;tax_input&#039;      =&gt; array(
				&#039;wp_theme&#039; =&gt; $term_ids
			),
		);

		if ( geodir_is_gd_post_type( $post_type ) ) {
			$args[&#039;post_name&#039;] = $template_name . &#039;-&#039; . $post_type;
		}

		$post_id = geodir_create_wp_template( $page, $args, ( empty( $post_type ) ? true : false ) );

		if ( is_wp_error( $post_id ) ) {
			return $post_id;
		} else if ( ! $post_id ) {
			return new WP_Error( &#039;invalid_page&#039;, __( &#039;Unable to create new template.&#039;, &#039;geodirectory&#039; ) );
		}

		$response = array( &#039;post_id&#039; =&gt; $post_id, &#039;post_title&#039; =&gt; strip_tags( get_the_title( $post_id ) ), &#039;reload&#039; =&gt; true );

		return apply_filters( &#039;geodir_new_wp_template_response&#039;, $response, $post_id, $request );
	}

	/**
	 * Get the WP template file content.
	 *
	 * @since 2.2.4
	 */
	public static function get_default_wp_template_html( $page, $template_type = &#039;wp_template&#039;, $inject_theme_attribute = true ) {
		$content = &#039;&#039;;

		$template_name = self::convert_page_to_slug( $page );
		$template_path = self::get_templates_directory( $template_type ) . &#039;/&#039; . $template_name . &#039;.html&#039;;

		if ( file_exists( $template_path ) ) {
			$content = @file_get_contents( $template_path ); // phpcs:ignore WordPress.WP.AlternativeFunctions.file_get_contents_file_get_contents
			
			if ( $content ) {
				$content = _inject_theme_attribute_in_block_template_content( $content );
			}
		}

		return $content;
	}
}</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Geodirectory Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on May 12th, 2022 at 06:35 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1652337338"></script>
    <script src="../js/search.js?updated=1652337338"></script>
</body>
</html>
