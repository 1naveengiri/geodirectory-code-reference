<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Geodirectory Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1652337337">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1652337337">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.png" alt="WPGeodirectory" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">Geodirectory Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/elementorpro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/elementorpro-modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Geodirectory.html"><abbr title="\Geodirectory">Geodirectory</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectory.html"><abbr title="\GeoDirectory">GeoDirectory</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/GeoDirectory-Templates.html"><abbr title="\GeoDirectory\Templates">Templates</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAbstracts.html"><abbr title="\GeoDirectoryAbstracts">GeoDirectoryAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAPI.html"><abbr title="\GeoDirectoryAPI">GeoDirectoryAPI</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClasses.html"><abbr title="\GeoDirectoryClasses">GeoDirectoryClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminFunctions.html"><abbr title="\GeoDirectoryAdminFunctions">GeoDirectoryAdminFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoruAdmin.html"><abbr title="\GeoDirectoruAdmin">GeoDirectoruAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdmin.html"><abbr title="\GeoDirectoryAdmin">GeoDirectoryAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirAdmin.html"><abbr title="\GeoDirAdmin">GeoDirAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectroyAdmin.html"><abbr title="\GeoDirectroyAdmin">GeoDirectroyAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminSystemStatus.html"><abbr title="\GeoDirectoryAdminSystemStatus">GeoDirectoryAdminSystemStatus</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminTools.html"><abbr title="\GeoDirectoryAdminTools">GeoDirectoryAdminTools</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminWidgets.html"><abbr title="\GeoDirectoryAdminWidgets">GeoDirectoryAdminWidgets</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesEmails.html"><abbr title="\GeoDirectoryClassesEmails">GeoDirectoryClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesData.html"><abbr title="\GeoDirectoryClassesData">GeoDirectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDIrectoryClassesData.html"><abbr title="\GeoDIrectoryClassesData">GeoDIrectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/ElementorPro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/ElementorPro-Modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryFunctions.html"><abbr title="\GeoDirectoryFunctions">GeoDirectoryFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryparamarraytermsAnarrayoftermobjects.html"><abbr title="\GeoDirectoryparamarraytermsAnarrayoftermobjects">GeoDirectoryparamarraytermsAnarrayoftermobjects</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WP.html"><abbr title="\WP">WP</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WP-Background.html"><abbr title="\WP\Background">Background</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryTemplates.html"><abbr title="\GeoDirectoryTemplates">GeoDirectoryTemplates</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-geodir-admin-install.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Installation related functions and actions.
 *
 * @author   AyeCode
 * @category Admin
 * @package  GeoDirectory/Classes
 * @version  2.0.0
 */

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit;
}

/**
 * GeoDir_Admin_Install Class.
 */
class GeoDir_Admin_Install {

	/** @var array DB updates and callbacks that need to be run per version */
	private static $db_updates = array(
		&#039;2.0.0.0&#039; =&gt; array(
			&#039;geodir_update_200_settings&#039;,
			&#039;geodir_update_200_fields&#039;,
			&#039;geodir_update_200_terms&#039;,
			&#039;geodir_update_200_posts&#039;,
			&#039;geodir_update_200_merge_data&#039;,
			&#039;geodir_update_200_db_version&#039;,
		),
		&#039;2.0.0.60&#039; =&gt; array(
			&#039;geodir_upgrade_20060&#039;,
		),
		&#039;2.0.0.64&#039; =&gt; array(
			&#039;geodir_upgrade_20064&#039;,
		),
		&#039;2.0.0.82&#039; =&gt; array(
			&#039;geodir_upgrade_20082&#039;,
		),
		&#039;2.0.0.96&#039; =&gt; array(
			&#039;geodir_upgrade_20096&#039;,
		),
		&#039;2.1.0.16&#039; =&gt; array(
			&#039;geodir_upgrade_21016&#039;,
		)
	);

	/** @var object Background update class */
	private static $background_updater;

	/**
	 * Hook in tabs.
	 */
	public static function init() {
		add_action( &#039;init&#039;, array( __CLASS__, &#039;check_version&#039; ), 5 );
		add_action( &#039;init&#039;, array( __CLASS__, &#039;init_background_updater&#039; ), 5 );
		add_action( &#039;admin_init&#039;, array( __CLASS__, &#039;install_actions&#039; ) );
		//add_filter( &#039;plugin_action_links_&#039; . GEODIRECTORY_PLUGIN_BASENAME, array( __CLASS__, &#039;plugin_action_links&#039; ) );
		add_filter( &#039;plugin_row_meta&#039;, array( __CLASS__, &#039;plugin_row_meta&#039; ), 10, 2 );
		add_filter( &#039;wpmu_drop_tables&#039;, array( __CLASS__, &#039;wpmu_drop_tables&#039; ) );
		add_filter( &#039;cron_schedules&#039;, array( __CLASS__, &#039;cron_schedules&#039; ) );
		//add_action( &#039;geodir_plugin_background_installer&#039;, array( __CLASS__, &#039;background_installer&#039; ), 10, 2 );

		add_filter(&#039;upgrader_package_options&#039;,array( __CLASS__, &#039;maybe_downgrade_v1&#039;));

		// schedule rewrite rules
		add_action( &#039;geodirectory_installed&#039;, array( __CLASS__, &#039;schedule_rewrite_rules&#039; ), 99 );
	}

	/**
	 * Used to allow downgrade if a user installs v2 but is not ready to convert yet.
	 *
	 * @param $options
	 *
	 * @return mixed
	 */
	public static function maybe_downgrade_v1($options){

		if(
			!empty($_REQUEST[&#039;geodir_downgrade&#039;])
			&amp;&amp; !empty($options[&#039;package&#039;])
			&amp;&amp; strpos( $options[&#039;package&#039;], &quot;https://downloads.wordpress.org/plugin/geodirectory.&quot; ) === 0
//			&amp;&amp; strpos( $options[&#039;package&#039;], &quot;https://downloads.wordpress.org/plugin/advanced-cron-manager.&quot; ) === 0 //@todo remove after testing
			&amp;&amp; version_compare( get_option( &#039;geodirectory_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; )
		){

//			print_r($options);exit;
			$options[&#039;package&#039;] = &quot;https://downloads.wordpress.org/plugin/geodirectory.1.6.38.zip&quot;;
//			$options[&#039;package&#039;] = &quot;https://downloads.wordpress.org/plugin/advanced-cron-manager.2.2.2.zip&quot;; //@todo remove after testing
			$options[&#039;abort_if_destination_exists&#039;] = false;
		}

		return $options;
	}

	/**
	 * Init background updates
	 */
	public static function init_background_updater() {
		include_once( GEODIRECTORY_PLUGIN_DIR . &#039;includes/class-geodir-background-updater.php&#039; );
		self::$background_updater = new GeoDir_Background_Updater();
	}

	/**
	 * Check GeoDirectory version and run the updater as required.
	 *
	 * This check is done on all requests and runs if the versions do not match.
	 */
	public static function check_version() {
		if ( ! defined( &#039;IFRAME_REQUEST&#039; ) ) {
			if ( self::is_v2_upgrade() ) {
				GeoDir_Admin_Notices::add_notice( &#039;update&#039; );
			} else if ( get_option( &#039;geodirectory_version&#039; ) !== GeoDir()-&gt;version ) {
				self::install();
				do_action( &#039;geodirectory_updated&#039; );
			}
		}
	}

	/**
	 * Install actions when a update button is clicked within the admin area.
	 *
	 * This function is hooked into admin_init to affect admin only.
	 */
	public static function install_actions() {
		if ( ! empty( $_GET[&#039;do_update_geodirectory&#039;] ) ) {
			self::update();
			GeoDir_Admin_Notices::add_notice( &#039;update&#039; );
		}
		if ( ! empty( $_GET[&#039;force_update_geodirectory&#039;] ) ) {
			$blog_id = get_current_blog_id();

			// Used to fire an action added in WP_Background_Process::_construct() that calls WP_Background_Process::handle_cron_healthcheck().
			// This method will make sure the database updates are executed even if cron is disabled. Nothing will happen if the updates are already running.
			do_action( &#039;wp_&#039; . $blog_id . &#039;_geodir_updater_cron&#039; );

			wp_safe_redirect( admin_url( &#039;admin.php?page=gd-settings&#039; ) );
			exit;
		}
	}

	/**
	 * Install GeoDirectory.
	 */
	public static function install() {
		global $wpdb;

		if ( ! is_blog_installed() ) {
			return;
		}

		if ( ! defined( &#039;GD_INSTALLING&#039; ) ) {
			define( &#039;GD_INSTALLING&#039;, true );
		}

		// Ensure needed classes are loaded
		//include_once( dirname( __FILE__ ) . &#039;/class-geodir-admin-notices.php&#039; );


		self::upgrades(); // do any db upgrades
		self::remove_admin_notices();
		self::create_tables();
		self::create_options();
		self::insert_default_fields();
		self::insert_default_tabs();
		self::create_pages();


		// Register post types
		GeoDir_Post_types::register_post_types();
		// Register listing status
		GeoDir_Post_types::register_post_status();
		GeoDir_Post_types::register_taxonomies();

		self::create_uncategorized_categories();

		// Also register endpoints - this needs to be done prior to rewrite rule flush
		//()-&gt;query-&gt;init_query_vars();
		//()-&gt;query-&gt;add_endpoints();
		//_API::add_endpoint();
		//_Auth::add_endpoint();
		
		self::create_cron_jobs();

		// Queue upgrades/setup wizard
		self::maybe_enable_setup_wizard();

		// Update GD version
		self::update_gd_version();

		// Update DB version
		self::maybe_update_db_version();

		// Flush rules after install
		do_action( &#039;geodir_flush_rewrite_rules&#039; );

		// Trigger action
		do_action( &#039;geodirectory_installed&#039; );
	}
	
	/**
	 * Reset any notices added to admin.
	 *
	 * @since 2.0.0
	 */
	private static function remove_admin_notices() {
		GeoDir_Admin_Notices::remove_all_notices();
	}
	
	/**
	 * Is this a brand new GeoDirectory install?
	 *
	 * @since 2.0.0
	 * @return boolean
	 */
	private static function is_new_install() {
		return is_null( get_option( &#039;geodirectory_version&#039;, null ) ) &amp;&amp; is_null( get_option( &#039;geodirectory_db_version&#039;, null ) );
	}

	/**
	 * Is v1 to v2 upgrade.
	 *
	 * @since 2.0.0
	 * @return boolean
	 */
	private static function is_v2_upgrade() {
		if ( self::is_new_install() ) {
			return false;
		}

		if ( get_option( &#039;geodirectory_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodirectory_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) {
			return true;
		}

		return false;
	}

	/**
	 * Is a DB update needed?
	 *
	 * @since 2.0.0
	 * @return boolean
	 */
	private static function needs_db_update() {
		$current_db_version = get_option( &#039;geodirectory_db_version&#039;, null );
		$updates            = self::get_db_update_callbacks();

		return ! is_null( $current_db_version ) &amp;&amp; ! empty( $updates ) &amp;&amp; version_compare( $current_db_version, max( array_keys( $updates ) ), &#039;&lt;&#039; );
	}

	/**
	 * See if we need the wizard or not.
	 *
	 * @since 2.0.0
	 */
	private static function maybe_enable_setup_wizard() {
		if ( apply_filters( &#039;geodirectory_enable_setup_wizard&#039;, self::is_new_install() ) ) {
			GeoDir_Admin_Notices::add_notice( &#039;install&#039; );
			set_transient( &#039;_gd_activation_redirect&#039;, 1, 30 );
		} elseif ( ! geodir_get_option( &#039;page_archive&#039; ) ) {
			GeoDir_Admin_Notices::add_notice( &#039;install&#039; );
		}
	}

    /**
     * Insert the default field for the CPTs.
     *
     * @since 2.0.0
     *
     * @param string $post_type Optional. Post type. Default gd_place.
     */
	public static function insert_default_fields($post_type = &#039;gd_place&#039;){
		$fields = GeoDir_Admin_Dummy_Data::default_custom_fields($post_type);

		/**
		 * Filter the array of default custom fields DB table data.
		 *
		 * @since 1.0.0
		 * @param string $fields The default custom fields as an array.
		 */
		$fields = apply_filters(&#039;geodir_before_default_custom_fields_saved&#039;, $fields);
		foreach ($fields as $field_index =&gt; $field) {
			geodir_custom_field_save($field);
		}
	}

    /**
     * Insert the default field for the CPTs.
     *
     * @since 2.0.0
     *
     * @param string $post_type Optional. Post type. Default gd_place.
     */
	public static function insert_default_tabs($post_type = &#039;gd_place&#039;){
		$fields = array();
		
		// Profile / description
		$fields[] = array(
			&#039;post_type&#039;     =&gt; $post_type,
			&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
			&#039;tab_type&#039;      =&gt; &#039;meta&#039;,
			&#039;tab_name&#039;      =&gt; __(&#039;Profile&#039;,&#039;geodirectory&#039;),
			&#039;tab_icon&#039;      =&gt; &#039;fas fa-home&#039;,
			&#039;tab_key&#039;       =&gt; &#039;post_content&#039;,
			&#039;tab_content&#039;   =&gt; &#039;&#039;,
			&#039;sort_order&#039;    =&gt; &#039;1&#039;,
			&#039;tab_level&#039;     =&gt; &#039;0&#039;
		);

		// Photos
		$fields[] = array(
			&#039;post_type&#039;     =&gt; $post_type,
			&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
			&#039;tab_type&#039;      =&gt; &#039;standard&#039;,
			&#039;tab_name&#039;      =&gt; __(&#039;Photos&#039;,&#039;geodirectory&#039;),
			&#039;tab_icon&#039;      =&gt; &#039;fas fa-image&#039;,
			&#039;tab_key&#039;       =&gt; &#039;post_images&#039;,
			&#039;tab_content&#039;   =&gt; &#039;[gd_post_images type=&quot;gallery&quot; ajax_load=&quot;1&quot; slideshow=&quot;1&quot; show_title=&quot;1&quot; animation=&quot;slide&quot; controlnav=&quot;1&quot; link_to=&quot;lightbox&quot;]&#039;,
			&#039;sort_order&#039;    =&gt; &#039;2&#039;,
			&#039;tab_level&#039;     =&gt; &#039;0&#039;
		);

		// Photos
		$fields[] = array(
			&#039;post_type&#039;     =&gt; $post_type,
			&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
			&#039;tab_type&#039;      =&gt; &#039;standard&#039;,
			&#039;tab_name&#039;      =&gt; __(&#039;Map&#039;,&#039;geodirectory&#039;),
			&#039;tab_icon&#039;      =&gt; &#039;fas fa-globe-americas&#039;,
			&#039;tab_key&#039;       =&gt; &#039;post_map&#039;,
			&#039;tab_content&#039;   =&gt; &#039;[gd_map width=&quot;100%&quot; height=&quot;325px&quot; maptype=&quot;ROADMAP&quot; zoom=&quot;0&quot; map_type=&quot;post&quot; map_directions=&quot;1&quot;]&#039;,
			&#039;sort_order&#039;    =&gt; &#039;3&#039;,
			&#039;tab_level&#039;     =&gt; &#039;0&#039;
		);

		// Reviews
		$fields[] = array(
			&#039;post_type&#039;     =&gt; $post_type,
			&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
			&#039;tab_type&#039;      =&gt; &#039;standard&#039;,
			&#039;tab_name&#039;      =&gt; __(&#039;Reviews&#039;,&#039;geodirectory&#039;),
			&#039;tab_icon&#039;      =&gt; &#039;fas fa-comments&#039;,
			&#039;tab_key&#039;       =&gt; &#039;reviews&#039;,
			&#039;tab_content&#039;   =&gt; &#039;&#039;,
			&#039;sort_order&#039;    =&gt; &#039;4&#039;,
			&#039;tab_level&#039;     =&gt; &#039;0&#039;
		);


		/**
		 * Filter the array of default tabs DB table data.
		 *
		 * @since 1.0.0
		 * @param string $fields The default tabs fields as an array.
		 */
		$fields = apply_filters(&#039;geodir_before_default_tabs_saved&#039;, $fields);
		$has_tabs = GeoDir_Settings_Cpt_Tabs::get_tabs_fields($post_type);
		if(empty($has_tabs)){
			foreach ($fields as $field_index =&gt; $field) {
				GeoDir_Settings_Cpt_Tabs::save_tab_item( $field );
			}
		}
	}
	
	/**
	 * See if we need to show or run database updates during install.
	 *
	 * @since 2.0.0
	 */
	private static function maybe_update_db_version() {
		if ( self::needs_db_update() ) {
			if ( apply_filters( &#039;geodir_enable_auto_update_db&#039;, false ) ) {
				self::update();
			} else {
				GeoDir_Admin_Notices::add_notice( &#039;update&#039; );
			}
		} else {
			self::update_db_version();
		}
	}

	/**
	 * Update GeoDirectory version to current.
     *
     * @since 2.0.0
	 */
	private static function update_gd_version() {
		delete_option( &#039;geodirectory_version&#039; );
		add_option( &#039;geodirectory_version&#039;, GEODIRECTORY_VERSION );
	}

	/**
	 * Get list of DB update callbacks.
	 *
	 * @since  3.0.0
	 * @return array
	 */
	public static function get_db_update_callbacks() {
		return self::$db_updates;
	}

	/**
	 * Push all needed DB updates to the queue for processing.
     *
     * @since 2.0.0
	 */
	private static function update() {
		$current_db_version = get_option( &#039;geodirectory_db_version&#039; );
		$update_queued      = false;

		foreach ( self::get_db_update_callbacks() as $version =&gt; $update_callbacks ) {
			if ( version_compare( $current_db_version, $version, &#039;&lt;&#039; ) ) {
				foreach ( $update_callbacks as $update_callback ) {
					geodir_error_log( sprintf( &#039;Queuing %s - %s&#039;, $version, $update_callback ) );
					self::$background_updater-&gt;push_to_queue( $update_callback );
					$update_queued = true;
				}
			}
		}

		if ( $update_queued ) {
			self::$background_updater-&gt;save()-&gt;dispatch();
		}
	}

	/**
	 * Update DB version to current.
	 * @param string $version
	 */
	public static function update_db_version( $version = null ) {
		delete_option( &#039;geodirectory_db_version&#039; );
		add_option( &#039;geodirectory_db_version&#039;, is_null( $version ) ? GEODIRECTORY_VERSION : $version );
	}

	/**
	 * Add more cron schedules.
	 * @param  array $schedules
	 * @return array
	 */
	public static function cron_schedules( $schedules ) {
		// Kadence starter templates page is broken when monthly schedule option is set. 
		if ( ( ! empty( $_REQUEST[&#039;page&#039;] ) &amp;&amp; $_REQUEST[&#039;page&#039;] == &#039;kadence-starter-templates&#039; ) || ( ! empty( $_REQUEST[&#039;action&#039;] ) &amp;&amp; in_array( $_REQUEST[&#039;action&#039;], array( &#039;kadence_check_plugin_data&#039;, &#039;kadence_import_get_template_data&#039;, &#039;kadence_import_install_plugins&#039; ) ) ) ) {
			return $schedules;
		}

		$schedules[&#039;monthly&#039;] = array(
			&#039;interval&#039; =&gt; 2635200,
			&#039;display&#039;  =&gt; __( &#039;Once Monthly&#039;, &#039;geodirectory&#039; ),
		);
		return $schedules;
	}

	/**
	 * Create cron jobs (clear them first).
     *
     * @since 2.0.0
	 */
	private static function create_cron_jobs() {
		//@todo add crons here
		wp_clear_scheduled_hook( &#039;geodirectory_tracker_send_event&#039; );
		wp_schedule_event( time(), apply_filters( &#039;geodirectory_tracker_event_recurrence&#039;, &#039;daily&#039; ), &#039;geodirectory_tracker_send_event&#039; );
	}


	/**
	 * Create pages that the plugin relies on, storing page IDs in variables.
     *
     * @since 2.0.0
	 */
	public static function create_pages() {

		$gutenberg = geodir_is_gutenberg();

		$pages = apply_filters( &#039;geodirectory_create_pages&#039;, array(
			&#039;page_add&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;add-listing&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;Add Listing&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; GeoDir_Defaults::page_add_content(false, $gutenberg),
			),
			&#039;page_search&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;search&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;Search page&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; GeoDir_Defaults::page_search_content(false, $gutenberg),
			),
			&#039;page_terms_conditions&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;terms-and-conditions&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;Terms and Conditions&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; __(&#039;ENTER YOUR SITE TERMS AND CONDITIONS HERE&#039;,&#039;geodirectory&#039;),
			),
			&#039;page_location&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;location&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;Location&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; GeoDir_Defaults::page_location_content(false, $gutenberg),
			),
			&#039;page_archive&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;gd-archive&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;GD Archive&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; GeoDir_Defaults::page_archive_content(false, $gutenberg),
			),
			&#039;page_archive_item&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;gd-archive-item&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;GD Archive Item&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; GeoDir_Defaults::page_archive_item_content(false, $gutenberg),
			),
			&#039;page_details&#039; =&gt; array(
				&#039;name&#039;    =&gt; _x( &#039;gd-details&#039;, &#039;Page slug&#039;, &#039;geodirectory&#039;),
				&#039;title&#039;   =&gt; _x( &#039;GD Details&#039;, &#039;Page title&#039;, &#039;geodirectory&#039;),
				&#039;content&#039; =&gt; GeoDir_Defaults::page_details_content(false, $gutenberg),
			),

			
		) );

		foreach ( $pages as $key =&gt; $page ) {
			geodir_create_page( esc_sql( $page[&#039;name&#039;] ), $key , $page[&#039;title&#039;], $page[&#039;content&#039;]);
		}

		delete_transient( &#039;geodir_cache_excluded_uris&#039; );
	}

	/**
	 * Create a category for each CPT.
	 *
	 * So users can start adding posts right away.
     *
     * @since 2.0.0
	 */
	public static function create_uncategorized_categories(){
		$post_types = geodir_get_posttypes();
		if(!empty($post_types)){
			foreach($post_types as $post_type){
				$taxonomy = $post_type.&#039;category&#039;;
				if(!get_option($taxonomy.&#039;_installed&#039;,false)){
					$dummy_categories[&#039;uncategorized&#039;] = array(
						&#039;name&#039;        =&gt; &#039;Uncategorized&#039;,
						&#039;icon&#039;        =&gt; GEODIRECTORY_PLUGIN_URL . &#039;/assets/images/pin.png&#039;,
						&#039;schema_type&#039; =&gt; &#039;&#039;
					);
					GeoDir_Admin_Dummy_Data::create_taxonomies( $post_type, $dummy_categories );
					update_option($taxonomy.&#039;_installed&#039;,true);
				}

			}
		}

	}

	/**
	 * Default options.
	 *
	 * Sets up the default options used on the settings page.
     *
     * @since 2.0.0
	 */
	private static function create_options() {
		// Before set default options.
		self::before_create_options();

		// Include settings so that we can run through defaults
		include_once( dirname( __FILE__ ) . &#039;/class-geodir-admin-settings.php&#039; );
		
		$current_settings = geodir_get_settings();

		$settings = GeoDir_Admin_Settings::get_settings_pages();

		foreach ( $settings as $section ) {
			if ( ! method_exists( $section, &#039;get_settings&#039; ) ) {
				continue;
			}
			$subsections = array_unique( array_merge( array( &#039;&#039; ), array_keys( $section-&gt;get_sections() ) ) );

			foreach ( $subsections as $subsection ) {
				foreach ( $section-&gt;get_settings( $subsection ) as $value ) {
					if ( !isset($current_settings[$value[&#039;id&#039;]]) &amp;&amp; isset( $value[&#039;default&#039;] ) &amp;&amp; isset( $value[&#039;id&#039;] ) ) {
						geodir_update_option($value[&#039;id&#039;], $value[&#039;default&#039;]);
					}
				}
			}
		}

	}

	/**
	 * Set up the database tables which the plugin needs to function.
	 *
	 * Tables:
	 *		geodir_api_keys - API keys table.
	 *		geodir_attachments - Listing attachments table.
	 *		geodir_business_hours - Business hours table.
	 *		geodir_custom_fields - Custom fields table.
	 *		geodir_custom_sort_fields - Custom fields sorting table.
	 *		geodir_post_review - Listing reviews table.
     *
     * @global object $wpdb WordPress Database object.
     * @since 2.0.0
	 */
	public static function create_tables() {
		global $wpdb;

		$wpdb-&gt;hide_errors();

		require_once( ABSPATH . &#039;wp-admin/includes/upgrade.php&#039; );

		dbDelta( self::get_schema() );

	}

	/**
	 * Get Table schema.
	 *
	 * A note on indexes; Indexes have a maximum size of 767 bytes. Historically, we haven&#039;t need to be concerned about that.
	 * As of WordPress 4.2, however, we moved to utf8mb4, which uses 4 bytes per character. This means that an index which
	 * used to have room for floor(767/3) = 255 characters, now only has room for floor(767/4) = 191 characters.
	 *
	 * Changing indexes may cause duplicate index notices in logs due to https://core.trac.wordpress.org/ticket/34870 but dropping
	 * indexes first causes too much load on some servers/larger DB.
	 *
     * @since 2.0.0
     *
     * @global object $wpdb WordPress Database object.
     * @global object $plugin_prefix WordPress plugin prefix.
     *
	 * @return string $tables.
	 */
	public static function get_schema() {
		global $wpdb, $plugin_prefix;

		/*
         * Indexes have a maximum size of 767 bytes. Historically, we haven&#039;t need to be concerned about that.
         * As of 4.2, however, we moved to utf8mb4, which uses 4 bytes per character. This means that an index which
         * used to have room for floor(767/3) = 255 characters, now only has room for floor(767/4) = 191 characters.
         */
		$max_index_length = 191;

		$collate = &#039;&#039;;

		if ( $wpdb-&gt;has_cap( &#039;collation&#039; ) ) {
			$collate = $wpdb-&gt;get_charset_collate();
		}

		// Table for storing post custom fields - these are user defined
		$tables = &quot; CREATE TABLE &quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot; (
							  id int(11) NOT NULL AUTO_INCREMENT,
							  post_type varchar(100) NULL,
							  data_type varchar(100) NULL DEFAULT NULL,
							  field_type varchar(255) NOT NULL COMMENT &#039;text,checkbox,radio,select,textarea&#039;,
							  field_type_key varchar(255) NOT NULL,
							  admin_title varchar(255) NULL DEFAULT NULL,
							  frontend_desc text NULL DEFAULT NULL,
							  frontend_title varchar(255) NULL DEFAULT NULL,
							  htmlvar_name varchar(255) NULL DEFAULT NULL,
							  default_value text NULL DEFAULT NULL,
							  placeholder_value text NULL DEFAULT NULL,
							  sort_order int(11) NOT NULL,
							  tab_parent varchar(100) NOT NULL DEFAULT &#039;0&#039;,
							  tab_level int(11) NOT NULL DEFAULT &#039;0&#039;,
							  option_values text NULL DEFAULT NULL,
							  clabels text NULL DEFAULT NULL,
							  is_active tinyint(1) NOT NULL DEFAULT &#039;1&#039;,
							  is_default tinyint(1) NOT NULL DEFAULT &#039;0&#039;,
							  is_required tinyint(1) NOT NULL DEFAULT &#039;0&#039;,
							  required_msg varchar(255) NULL DEFAULT NULL,
							  show_in text NULL DEFAULT NULL,
							  for_admin_use tinyint(1) NOT NULL DEFAULT &#039;0&#039;,
							  packages text NULL DEFAULT NULL,
							  cat_sort text NULL DEFAULT NULL,
							  cat_filter text NULL DEFAULT NULL,
							  extra_fields text NULL DEFAULT NULL,
							  field_icon varchar(255) NULL DEFAULT NULL,
							  css_class varchar(255) NULL DEFAULT NULL,
							  decimal_point varchar( 10 ) NOT NULL,
							  validation_pattern varchar( 255 ) NOT NULL,
							  validation_msg text NULL DEFAULT NULL,
							  PRIMARY KEY  (id)
							  ) $collate; &quot;;


		// Table for storing tabs layout settings
		$tables .= &quot; CREATE TABLE &quot; . GEODIR_TABS_LAYOUT_TABLE . &quot; (
							  id int(11) NOT NULL AUTO_INCREMENT,
							  post_type varchar(100) NULL,
							  sort_order int(11) NOT NULL,
							  tab_layout varchar(100) NOT NULL,
							  tab_parent varchar(100) NOT NULL,
							  tab_type varchar(100) NOT NULL,
							  tab_level int(11) NOT NULL,
							  tab_name varchar(255) NOT NULL,
							  tab_icon varchar(255) NOT NULL,
							  tab_key varchar(255) NOT NULL,
							  tab_content text NULL DEFAULT NULL,
							  PRIMARY KEY  (id)
							  ) $collate; &quot;;


		// run through all GD CPTs

		$post_types = geodir_get_option( &#039;post_types&#039;, array() );

		if(empty($post_types)){
			// Table for storing place attribute - these are user defined
			$tables .= &quot; CREATE TABLE &quot; . $plugin_prefix . &quot;gd_place_detail (
						&quot;.implode (&quot;, \n&quot;,self::db_cpt_default_columns()).&quot;,
						&quot;.implode (&quot;, \n&quot;,self::db_cpt_default_keys()).&quot; 
						) $collate; &quot;;
		}else{
			foreach($post_types as $post_type =&gt; $cpt){
				// Table for storing place attribute - these are user defined
				$tables .= &quot; CREATE TABLE &quot; . $plugin_prefix . $post_type . &quot;_detail (
						&quot;.implode (&quot;, \n&quot;,self::db_cpt_default_columns($cpt, $post_type)).&quot;,
						&quot;.implode (&quot;, \n&quot;,self::db_cpt_default_keys($cpt, $post_type)).&quot; 
						) $collate; &quot;;
			}

			//print_r($tables);exit;
		}


		// Table for storing place images - these are user defined
		$tables .= &quot; CREATE TABLE &quot; . GEODIR_ATTACHMENT_TABLE . &quot; (
						ID int(11) NOT NULL AUTO_INCREMENT,
						post_id int(11) NOT NULL,
						date_gmt datetime NULL default null,
						user_id int(11) DEFAULT NULL,
						other_id int(11) DEFAULT NULL,
						title varchar(254) NULL DEFAULT NULL,
						caption varchar(254) NULL DEFAULT NULL,
						file varchar(254) NOT NULL, 
						mime_type varchar(150) NOT NULL,
						menu_order int(11) NOT NULL DEFAULT &#039;0&#039;,
						featured tinyint(1) NULL DEFAULT &#039;0&#039;,
						is_approved tinyint(1) NULL DEFAULT &#039;1&#039;,
						metadata text NULL DEFAULT NULL,
					    type varchar(254) NULL DEFAULT &#039;post_images&#039;,
						PRIMARY KEY  (ID)
						) $collate ; &quot;;

		// Table for storing custom sort fields
		$tables .= &quot; CREATE TABLE &quot; . GEODIR_CUSTOM_SORT_FIELDS_TABLE . &quot; (
			id int(11) NOT NULL AUTO_INCREMENT,
			post_type varchar(255) NOT NULL,
			data_type varchar(255) NOT NULL,
			field_type varchar(255) NOT NULL,
			frontend_title varchar(255) NOT NULL,
			htmlvar_name varchar(255) NOT NULL,
			sort_order int(11) NOT NULL,
			tab_parent varchar(100) NOT NULL DEFAULT &#039;0&#039;,
			tab_level int(11) NOT NULL DEFAULT &#039;0&#039;,
			is_active int(11) NOT NULL,
			is_default int(11) NOT NULL,
			sort varchar(5) DEFAULT &#039;asc&#039;,
			PRIMARY KEY  (id)
			) $collate; &quot;;

		// Table for storing review info
		/**
		 * UNIQUE KEY replaced to PRIMARY KEY to prevent database error:
		 * &quot;Percona-XtraDB-Cluster prohibits use of DML command on a table without an explicit 
		 * primary key with pxc_strict_mode = ENFORCING or MASTER&quot;
		 */
		$tables .= &quot; CREATE TABLE &quot; . GEODIR_REVIEW_TABLE . &quot; (
		  comment_id bigint(20) UNSIGNED NOT NULL,
		  post_id bigint(20) DEFAULT &#039;0&#039;,
		  user_id bigint(20) DEFAULT &#039;0&#039;,
		  rating float DEFAULT &#039;0&#039;,
		  ratings text DEFAULT &#039;&#039;,
		  attachments text DEFAULT &#039;&#039;,
		  post_type varchar(20) DEFAULT &#039;&#039;,
		  city varchar(50) DEFAULT &#039;&#039;,
		  region varchar(50) DEFAULT &#039;&#039;,
		  country varchar(50) DEFAULT &#039;&#039;,
		  latitude varchar(22) DEFAULT &#039;&#039;,
		  longitude varchar(22) DEFAULT &#039;&#039;,
		  PRIMARY KEY (comment_id)
		) $collate; &quot;;
			
		// Table to store api keys
		$tables .= &quot; CREATE TABLE &quot; . GEODIR_API_KEYS_TABLE . &quot; (
			  key_id BIGINT UNSIGNED NOT NULL auto_increment,
			  user_id BIGINT UNSIGNED NOT NULL,
			  description varchar(200) NULL,
			  permissions varchar(10) NOT NULL,
			  consumer_key char(64) NOT NULL,
			  consumer_secret char(43) NOT NULL,
			  nonces longtext NULL,
			  truncated_key char(7) NOT NULL,
			  last_access datetime NULL default null,
			  PRIMARY KEY  (key_id),
			  KEY consumer_key (consumer_key),
			  KEY consumer_secret (consumer_secret)
			) $collate; &quot;;

		$tables .= &quot; CREATE TABLE &quot; . GEODIR_POST_REPORTS_TABLE . &quot; (
			`id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
			  `post_id` bigint(20) UNSIGNED NOT NULL,
			  `user_id` bigint(20) UNSIGNED NOT NULL,
			  `user_ip` varchar(200) DEFAULT NULL,
			  `user_name` varchar(100) NOT NULL,
			  `user_email` varchar(100) NOT NULL,
			  `reason` varchar(200) NOT NULL,
			  `message` text NOT NULL,
			  `status` varchar(50) NOT NULL,
			  `report_date` datetime DEFAULT NULL,
			  `updated_date` datetime DEFAULT NULL,
			  PRIMARY KEY (`id`),
			  KEY `post_id` (`post_id`),
			  KEY `user_id` (`user_id`)
			) $collate; &quot;;

		return $tables;
	}


    /**
     * Show plugin changes. Code adapted from W3 Total Cache.
     *
     * @since 2.0.0
     *
     * @param array $args {
     *      An array to update message arguments.
     *
     *      @type string $Version Plugin version.
     * }
     */
	public static function in_plugin_update_message( $args ) {
		$transient_name = &#039;gd_upgrade_notice_&#039; . $args[&#039;Version&#039;];

		if ( false === ( $upgrade_notice = get_transient( $transient_name ) ) ) {
			$response = wp_safe_remote_get( &#039;https://plugins.svn.wordpress.org/geodirectory/trunk/readme.txt&#039; );

			if ( ! is_wp_error( $response ) &amp;&amp; ! empty( $response[&#039;body&#039;] ) ) {
				$upgrade_notice = self::parse_update_notice( $response[&#039;body&#039;], $args[&#039;new_version&#039;] );
				set_transient( $transient_name, $upgrade_notice, DAY_IN_SECONDS );
			}
		}

		echo wp_kses_post( $upgrade_notice );
	}

	/**
	 * Parse update notice from readme file.
	 *
	 * @param  string $content
	 * @param  string $new_version
	 * @return string
	 */
	private static function parse_update_notice( $content, $new_version ) {
		// Output Upgrade Notice.
		$matches        = null;
		$regexp         = &#039;~==\s*Upgrade Notice\s*==\s*=\s*(.*)\s*=(.*)(=\s*&#039; . preg_quote( GEODIRECTORY_VERSION ) . &#039;\s*=|$)~Uis&#039;;
		$upgrade_notice = &#039;&#039;;

		if ( preg_match( $regexp, $content, $matches ) ) {
			$notices = (array) preg_split( &#039;~[\r\n]+~&#039;, trim( $matches[2] ) );

			// Convert the full version strings to minor versions.
			$notice_version_parts  = explode( &#039;.&#039;, trim( $matches[1] ) );
			$current_version_parts = explode( &#039;.&#039;, GEODIRECTORY_VERSION );

			if ( 3 !== sizeof( $notice_version_parts ) ) {
				return;
			}

			$notice_version  = $notice_version_parts[0] . &#039;.&#039; . $notice_version_parts[1];
			$current_version = $current_version_parts[0] . &#039;.&#039; . $current_version_parts[1];

			// Check the latest stable version and ignore trunk.
			if ( version_compare( $current_version, $notice_version, &#039;&lt;&#039; ) ) {

				$upgrade_notice .= &#039;&lt;/p&gt;&lt;p class=&quot;gd_plugin_upgrade_notice&quot;&gt;&#039;;

				foreach ( $notices as $index =&gt; $line ) {
					$upgrade_notice .= preg_replace( &#039;~\[([^\]]*)\]\(([^\)]*)\)~&#039;, &#039;&lt;a href=&quot;${2}&quot;&gt;${1}&lt;/a&gt;&#039;, $line );
				}
			}
		}

		return wp_kses_post( $upgrade_notice );
	}

	/**
	 * Show action links on the plugin screen.
	 *
	 * @param	mixed $links Plugin Action links
	 * @return	array
	 */
	public static function plugin_action_links( $links ) {
		$action_links = array(
			&#039;settings&#039; =&gt; &#039;&lt;a href=&quot;&#039; . admin_url( &#039;admin.php?page=gd-settings&#039; ) . &#039;&quot; aria-label=&quot;&#039; . esc_attr__( &#039;View GeoDirectory settings&#039;, &#039;geodirectory&#039; ) . &#039;&quot;&gt;&#039; . esc_html__( &#039;Settings&#039;, &#039;geodirectory&#039; ) . &#039;&lt;/a&gt;&#039;,
		);

		return array_merge( $action_links, $links );
	}

	/**
	 * Show row meta on the plugin screen.
	 *
	 * @param	mixed $links Plugin Row Meta
	 * @param	mixed $file  Plugin Base file
	 * @return	array
	 */
	public static function plugin_row_meta( $links, $file ) {
		if ( GEODIRECTORY_PLUGIN_BASENAME == $file ) {
			$row_meta = array(
				&#039;docs&#039;    =&gt; &#039;&lt;a href=&quot;&#039; . esc_url( apply_filters( &#039;geodirectory_docs_url&#039;, &#039;https://docs.wpgeodirectory.com/&#039; ) ) . &#039;&quot; aria-label=&quot;&#039; . esc_attr__( &#039;View GeoDirectory documentation&#039;, &#039;geodirectory&#039; ) . &#039;&quot;&gt;&#039; . esc_html__( &#039;Docs&#039;, &#039;geodirectory&#039; ) . &#039;&lt;/a&gt;&#039;,
				&#039;support&#039; =&gt; &#039;&lt;a href=&quot;&#039; . esc_url( apply_filters( &#039;geodirectory_support_url&#039;, &#039;https://wpgeodirectory.com/support/&#039; ) ) . &#039;&quot; aria-label=&quot;&#039; . esc_attr__( &#039;Visit GeoDirectory support&#039;, &#039;geodirectory&#039; ) . &#039;&quot;&gt;&#039; . esc_html__( &#039;Support&#039;, &#039;geodirectory&#039; ) . &#039;&lt;/a&gt;&#039;,
				&#039;translation&#039; =&gt; &#039;&lt;a href=&quot;&#039; . esc_url( apply_filters( &#039;geodirectory_translation_url&#039;, &#039;https://wpgeodirectory.com/translate/projects&#039; ) ) . &#039;&quot; aria-label=&quot;&#039; . esc_attr__( &#039;View translations&#039;, &#039;geodirectory&#039; ) . &#039;&quot;&gt;&#039; . esc_html__( &#039;Translations&#039;, &#039;geodirectory&#039; ) . &#039;&lt;/a&gt;&#039;,
			);

			return array_merge( $links, $row_meta );
		}

		return (array) $links;
	}

	/**
	 * Return a list of GeoDirectory tables. Used to make sure all WC tables are dropped when uninstalling the plugin
	 * in a single site or multi site environment.
	 *
	 * @return array GeoDir tables.
	 */
	public static function get_tables() {
		global $wpdb;

		$db_prefix = $wpdb-&gt;prefix;
		$gd_prefix = &#039;geodir_&#039;;

		$tables = array();
		$tables[&quot;{$gd_prefix}api_keys&quot;] = &quot;{$db_prefix}{$gd_prefix}api_keys&quot;;
		$tables[&quot;{$gd_prefix}attachments&quot;] = &quot;{$db_prefix}{$gd_prefix}attachments&quot;;
		$tables[&quot;{$gd_prefix}custom_fields&quot;] = &quot;{$db_prefix}{$gd_prefix}custom_fields&quot;;
		$tables[&quot;{$gd_prefix}custom_sort_fields&quot;] = &quot;{$db_prefix}{$gd_prefix}custom_sort_fields&quot;;
		$tables[&quot;{$gd_prefix}post_review&quot;] = &quot;{$db_prefix}{$gd_prefix}post_review&quot;;
		$tables[&quot;{$gd_prefix}tabs_layout&quot;] = &quot;{$db_prefix}{$gd_prefix}tabs_layout&quot;;
		$tables[&quot;{$gd_prefix}post_reports&quot;] = &quot;{$db_prefix}{$gd_prefix}post_reports&quot;;

		$post_types = array_keys( (array) geodir_get_option( &#039;post_types&#039; ) );
		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $post_type ) {
				$tables[&quot;{$gd_prefix}{$post_type}_detail&quot;] = &quot;{$db_prefix}{$gd_prefix}{$post_type}_detail&quot;;
			}
		}

		/**
		 * Filter the list of known GeoDirectory tables.
		 *
		 * If GeoDirectory plugins need to add new tables, they can inject them here.
		 *
		 * @param array $tables An array of GeoDirectory-specific database table names.
		 */
		$tables = apply_filters( &#039;geodir_install_get_tables&#039;, $tables );

		return $tables;
	}

	/**
	 * Drop GeoDirectory tables.
	 *
	 * @return void
	 */
	public static function drop_tables() {
		global $wpdb;

		$tables = self::get_tables();

		foreach ( $tables as $key =&gt; $table ) {
			$wpdb-&gt;query( &quot;DROP TABLE IF EXISTS {$table}&quot; ); // phpcs:ignore WordPress.WP.PreparedSQL.NotPrepared
		}
	}

	/**
	 * Uninstall tables when MU blog is deleted.
	 *
	 * @param  array $tables List of tables that will be deleted by WP.
	 * @return string[]
	 */
	public static function wpmu_drop_tables( $tables ) {
		return array_merge( $tables, self::get_tables() );
	}

	/**
	 * Get slug from path
	 * @param  string $key
	 * @return string
	 */
	private static function format_plugin_slug( $key ) {
		$slug = explode( &#039;/&#039;, $key );
		$slug = explode( &#039;.&#039;, end( $slug ) );
		return $slug[0];
	}

	/**
	 * Install a plugin from .org in the background via a cron job (used by
	 * installer - opt in).
	 * @param string $plugin_to_install_id
	 * @param array $plugin_to_install
	 * @since 2.6.0
	 */
	public static function background_installer( $plugin_to_install_id, $plugin_to_install ) {
		// Explicitly clear the event.
		wp_clear_scheduled_hook( &#039;geodir_plugin_background_installer&#039;, func_get_args() );

		if ( ! empty( $plugin_to_install[&#039;repo-slug&#039;] ) ) {
			require_once( ABSPATH . &#039;wp-admin/includes/file.php&#039; );
			require_once( ABSPATH . &#039;wp-admin/includes/plugin-install.php&#039; );
			require_once( ABSPATH . &#039;wp-admin/includes/class-wp-upgrader.php&#039; );
			require_once( ABSPATH . &#039;wp-admin/includes/plugin.php&#039; );

			WP_Filesystem();

			$skin              = new Automatic_Upgrader_Skin;
			$upgrader          = new WP_Upgrader( $skin );
			$installed_plugins = array_map( array( __CLASS__, &#039;format_plugin_slug&#039; ), array_keys( get_plugins() ) );
			$plugin_slug       = $plugin_to_install[&#039;repo-slug&#039;];
			$plugin            = $plugin_slug . &#039;/&#039; . $plugin_slug . &#039;.php&#039;;
			$installed         = false;
			$activate          = false;

			// See if the plugin is installed already
			if ( in_array( $plugin_to_install[&#039;repo-slug&#039;], $installed_plugins ) ) {
				$installed = true;
				$activate  = ! is_plugin_active( $plugin );
			}

			// Install this thing!
			if ( ! $installed ) {
				// Suppress feedback
				ob_start();

				try {
					$plugin_information = plugins_api( &#039;plugin_information&#039;, array(
						&#039;slug&#039;   =&gt; $plugin_to_install[&#039;repo-slug&#039;],
						&#039;fields&#039; =&gt; array(
							&#039;short_description&#039; =&gt; false,
							&#039;sections&#039;          =&gt; false,
							&#039;requires&#039;          =&gt; false,
							&#039;rating&#039;            =&gt; false,
							&#039;ratings&#039;           =&gt; false,
							&#039;downloaded&#039;        =&gt; false,
							&#039;last_updated&#039;      =&gt; false,
							&#039;added&#039;             =&gt; false,
							&#039;tags&#039;              =&gt; false,
							&#039;homepage&#039;          =&gt; false,
							&#039;donate_link&#039;       =&gt; false,
							&#039;author_profile&#039;    =&gt; false,
							&#039;author&#039;            =&gt; false,
						),
					) );

					if ( is_wp_error( $plugin_information ) ) {
						throw new Exception( $plugin_information-&gt;get_error_message() );
					}

					$package  = $plugin_information-&gt;download_link;
					$download = $upgrader-&gt;download_package( $package );

					if ( is_wp_error( $download ) ) {
						throw new Exception( $download-&gt;get_error_message() );
					}

					$working_dir = $upgrader-&gt;unpack_package( $download, true );

					if ( is_wp_error( $working_dir ) ) {
						throw new Exception( $working_dir-&gt;get_error_message() );
					}

					$result = $upgrader-&gt;install_package( array(
						&#039;source&#039;                      =&gt; $working_dir,
						&#039;destination&#039;                 =&gt; WP_PLUGIN_DIR,
						&#039;clear_destination&#039;           =&gt; false,
						&#039;abort_if_destination_exists&#039; =&gt; false,
						&#039;clear_working&#039;               =&gt; true,
						&#039;hook_extra&#039;                  =&gt; array(
							&#039;type&#039;   =&gt; &#039;plugin&#039;,
							&#039;action&#039; =&gt; &#039;install&#039;,
						),
					) );

					if ( is_wp_error( $result ) ) {
						throw new Exception( $result-&gt;get_error_message() );
					}

					$activate = true;

				} catch ( Exception $e ) {
					GeoDir_Admin_Notices::add_custom_notice(
						$plugin_to_install_id . &#039;_install_error&#039;,
						sprintf(
							__( &#039;%1$s could not be installed (%2$s). &lt;a href=&quot;%3$s&quot;&gt;Please install it manually by clicking here.&lt;/a&gt;&#039;, &#039;geodirectory&#039; ),
							$plugin_to_install[&#039;name&#039;],
							$e-&gt;getMessage(),
							esc_url( admin_url( &#039;index.php?gd-install-plugin-redirect=&#039; . $plugin_to_install[&#039;repo-slug&#039;] ) )
						)
					);
				}

				// Discard feedback
				ob_end_clean();
			}

			wp_clean_plugins_cache();

			// Activate this thing
			if ( $activate ) {
				try {
					$result = activate_plugin( $plugin );

					if ( is_wp_error( $result ) ) {
						throw new Exception( $result-&gt;get_error_message() );
					}
				} catch ( Exception $e ) {
					GeoDir_Admin_Notices::add_custom_notice(
						$plugin_to_install_id . &#039;_install_error&#039;,
						sprintf(
							__( &#039;%1$s was installed but could not be activated. &lt;a href=&quot;%2$s&quot;&gt;Please activate it manually by clicking here.&lt;/a&gt;&#039;, &#039;geodirectory&#039; ),
							$plugin_to_install[&#039;name&#039;],
							admin_url( &#039;plugins.php&#039; )
						)
					);
				}
			}
		}
	}


	/**
	 * Get the Custom Post Type database default fields.
	 *
	 * @since 2.0.0
	 * @since 2.0.0.82 Added _search_title column.
	 *
	 * @param bool $cpt CPT parameters.
	 * @param string $post_type The post type.
	 * @return array The array of default fields.
	 */
	public static function db_cpt_default_columns( $cpt = array(), $post_type = &#039;&#039; ) {
		$columns = array();

		// Standard fields
		$columns[&#039;post_id&#039;] = &quot;post_id int(11) NOT NULL&quot;;
		$columns[&#039;post_title&#039;] = &quot;post_title text NULL DEFAULT NULL&quot;;
		$columns[&#039;_search_title&#039;] = &quot;_search_title text NOT NULL&quot;;
		$columns[&#039;post_status&#039;] = &quot;post_status varchar(20) NULL DEFAULT NULL&quot;;
		$columns[&#039;post_tags&#039;] = &quot;post_tags text NULL DEFAULT NULL&quot;;
		$columns[&#039;post_category&#039;] = &quot;post_category varchar(254) NULL DEFAULT NULL&quot;;
		$columns[&#039;default_category&#039;] = &quot;default_category INT NULL DEFAULT NULL&quot;;
		$columns[&#039;featured&#039;] = &quot;featured tinyint(1) NOT NULL DEFAULT &#039;0&#039;&quot;;
		$columns[&#039;featured_image&#039;] = &quot;featured_image varchar( 254 ) NULL DEFAULT NULL&quot;;
		$columns[&#039;submit_ip&#039;] = &quot;submit_ip varchar(100) NULL DEFAULT NULL&quot;;
		$columns[&#039;overall_rating&#039;] = &quot;overall_rating float(11) DEFAULT &#039;0&#039;&quot;;
		$columns[&#039;rating_count&#039;] = &quot;rating_count int(11) DEFAULT &#039;0&#039;&quot;;

		// Location fields
		if ( ! isset( $cpt[&#039;disable_location&#039;] ) || ! $cpt[&#039;disable_location&#039;] ) {
			$columns[&#039;street&#039;] = &quot;street VARCHAR( 254 ) NULL&quot;;
			$columns[&#039;street2&#039;] = &quot;street2 VARCHAR( 254 ) NULL&quot;;
			$columns[&#039;city&#039;] = &quot;city VARCHAR( 50 ) NULL&quot;;
			$columns[&#039;region&#039;] = &quot;region VARCHAR( 50 ) NULL&quot;;
			$columns[&#039;country&#039;] = &quot;country VARCHAR( 50 ) NULL&quot;;
			$columns[&#039;zip&#039;] = &quot;zip VARCHAR( 50 ) NULL&quot;;
			$columns[&#039;latitude&#039;] = &quot;latitude VARCHAR( 22 ) NULL&quot;;
			$columns[&#039;longitude&#039;] = &quot;longitude VARCHAR( 22 ) NULL&quot;;
			$columns[&#039;mapview&#039;] = &quot;mapview VARCHAR( 15 ) NULL&quot;;
			$columns[&#039;mapzoom&#039;] = &quot;mapzoom VARCHAR( 3 ) NULL&quot;;
		}

		return apply_filters( &#039;geodir_db_cpt_default_columns&#039;, $columns, $cpt, $post_type );
	}

	/**
	 * Get the Custom Post Type database default keys.
	 *
	 * @param bool $cpt CPT parameters.
	 * @param string $post_type The post type.
	 * @since 2.0.0
	 *
	 * @return array The array of default fields.
	 */
	public static function db_cpt_default_keys($cpt = array(), $post_type = &#039;&#039;){

		/*
		 * Indexes have a maximum size of 767 bytes. Historically, we haven&#039;t need to be concerned about that.
		 * As of 4.2, however, we moved to utf8mb4, which uses 4 bytes per character. This means that an index which
		 * used to have room for floor(767/3) = 255 characters, now only has room for floor(767/4) = 191 characters.
		 */
		$max_index_length = 191;

		$keys = array();

		// Standard keys
		$keys[&#039;post_id&#039;] = &quot;PRIMARY KEY  (post_id)&quot;;
		//$keys[&#039;featured&#039;] = &quot;KEY featured (featured)&quot;;

		// Location keys
		if(!isset($cpt[&#039;disable_location&#039;]) || !$cpt[&#039;disable_location&#039;]){
			$keys[&#039;country&#039;] = &quot;KEY country (country(50))&quot;;
			$keys[&#039;region&#039;] = &quot;KEY region (region(50))&quot;;
			$keys[&#039;city&#039;] = &quot;KEY city (city(50))&quot;;
		}


		return apply_filters(&#039;geodir_db_cpt_default_keys&#039;,$keys,$cpt,$post_type);
	}

    /**
     * Run some upgrade scripts.
     *
     * @since 2.0.0
     *
     * @global object $wpdb WordPress Database object.
     */
	public static function upgrades(){
		/**
		 * DB type change for post_images
		 */
		if (get_option( &#039;geodirectory_version&#039; ) &amp;&amp; version_compare(get_option( &#039;geodirectory_version&#039; ), &#039;2.0.0.13-beta&#039;, &#039;&lt;=&#039;)) {
			global $wpdb;
			$wpdb-&gt;query(&quot;UPDATE &quot;.GEODIR_ATTACHMENT_TABLE.&quot; SET type=&#039;post_images&#039; WHERE type=&#039;post_image&#039;&quot;);
		}
	}

	/**
	 * Check &amp; schedule flush rewrite rules.
	 *
	 * @since 2.0.0.92
	 *
	 * @return void
	 */
	public static function schedule_rewrite_rules() {
		// Rank Math schedule flush rewrite rules.
		if ( class_exists( &#039;RankMath\\Helper&#039; ) ) {
			update_option( &#039;geodir_rank_math_flush_rewrite&#039;, 1 );
		}
	}

	/**
	 * Execute before default options are set.
	 *
	 * @since 2.1.0.0
	 *
	 * @return void
	 */
	public static function before_create_options() {
		// Maybe add try AUI notice
		self::maybe_try_aui();
	}

	/**
	 * Check and set default AUI option value.
	 *
	 * @since 2.1.0.0
	 *
	 * @return void
	 */
	public static function maybe_try_aui() {
		if ( self::is_new_install() ) {
			// New installs should be set to use it by default.
		} else {
			if ( get_option( &#039;geodirectory_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodirectory_version&#039; ), &#039;2.0.9.0&#039;, &#039;&lt;&#039; ) &amp;&amp; ! geodir_get_option( &#039;design_style&#039; ) ) {
				// Update blank to set default.
				geodir_update_option( &#039;design_style&#039;, &#039;&#039; );

				GeoDir_Admin_Notices::add_notice( &#039;try_aui&#039; );
			}
		}
	}
}


</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Geodirectory Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on May 12th, 2022 at 06:35 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1652337337"></script>
    <script src="../js/search.js?updated=1652337337"></script>
</body>
</html>
