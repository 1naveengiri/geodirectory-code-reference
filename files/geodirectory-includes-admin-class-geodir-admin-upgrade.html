<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Geodirectory Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1652336885">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1652336885">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.png" alt="WPGeodirectory" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">Geodirectory Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/elementorpro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/elementorpro-modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Geodirectory.html"><abbr title="\Geodirectory">Geodirectory</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectory.html"><abbr title="\GeoDirectory">GeoDirectory</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/GeoDirectory-Templates.html"><abbr title="\GeoDirectory\Templates">Templates</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAbstracts.html"><abbr title="\GeoDirectoryAbstracts">GeoDirectoryAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAPI.html"><abbr title="\GeoDirectoryAPI">GeoDirectoryAPI</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClasses.html"><abbr title="\GeoDirectoryClasses">GeoDirectoryClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminFunctions.html"><abbr title="\GeoDirectoryAdminFunctions">GeoDirectoryAdminFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoruAdmin.html"><abbr title="\GeoDirectoruAdmin">GeoDirectoruAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdmin.html"><abbr title="\GeoDirectoryAdmin">GeoDirectoryAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirAdmin.html"><abbr title="\GeoDirAdmin">GeoDirAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectroyAdmin.html"><abbr title="\GeoDirectroyAdmin">GeoDirectroyAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminSystemStatus.html"><abbr title="\GeoDirectoryAdminSystemStatus">GeoDirectoryAdminSystemStatus</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminTools.html"><abbr title="\GeoDirectoryAdminTools">GeoDirectoryAdminTools</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryAdminWidgets.html"><abbr title="\GeoDirectoryAdminWidgets">GeoDirectoryAdminWidgets</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesEmails.html"><abbr title="\GeoDirectoryClassesEmails">GeoDirectoryClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryClassesData.html"><abbr title="\GeoDirectoryClassesData">GeoDirectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDIrectoryClassesData.html"><abbr title="\GeoDIrectoryClassesData">GeoDIrectoryClassesData</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/ElementorPro.html"><abbr title="\ElementorPro">ElementorPro</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/ElementorPro-Modules.html"><abbr title="\ElementorPro\Modules">Modules</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryFunctions.html"><abbr title="\GeoDirectoryFunctions">GeoDirectoryFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryparamarraytermsAnarrayoftermobjects.html"><abbr title="\GeoDirectoryparamarraytermsAnarrayoftermobjects">GeoDirectoryparamarraytermsAnarrayoftermobjects</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WP.html"><abbr title="\WP">WP</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WP-Background.html"><abbr title="\WP\Background">Background</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/GeoDirectoryTemplates.html"><abbr title="\GeoDirectoryTemplates">GeoDirectoryTemplates</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-geodir-admin-upgrade.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * GeoDirectory v1 to v2 conversion class.
 *
 * @author   AyeCode
 * @category Admin
 * @package  GeoDirectory/Classes
 * @version  2.0.0
 */

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit;
}

/**
 * GeoDir_Admin_Upgrade Class.
 */
class GeoDir_Admin_Upgrade {

	public static function init() {
		add_action( &#039;geodir_update_200_settings_after&#039;, array( __CLASS__, &#039;update_200_set_permalink_structure&#039; ), 10, 1 );

		// Payment Manager
		if ( self::needs_upgrade( &#039;payment_manager&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_pm_get_options&#039; ), 9, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_pm_create_default_options&#039; ), 9 );
			add_action( &#039;geodir_update_200_create_tables&#039;, array( __CLASS__, &#039;update_200_pm_create_tables&#039; ), 9 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_pm_update_version&#039; ), 9 );
		}

		// Custom post types
		if ( self::needs_upgrade( &#039;custom_post_types&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_cp_get_options&#039; ), 10, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_cp_create_default_options&#039; ), 10 );
			add_action( &#039;geodir_update_200_custom_fields&#039;, array( __CLASS__, &#039;update_200_cp_custom_fields&#039; ), 10 );
			add_action( &#039;geodir_update_200_post_fields&#039;, array( __CLASS__, &#039;update_200_cp_post_fields&#039; ), 10, 1 );
			add_action( &#039;geodir_update_200_create_tables&#039;, array( __CLASS__, &#039;update_200_cp_create_tables&#039; ), 10 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_cp_update_version&#039; ), 10 );
		}

		// Location manager
		if ( self::needs_upgrade( &#039;location_manager&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_lm_get_options&#039; ), 11, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_lm_create_default_options&#039; ), 11 );
			add_action( &#039;geodir_update_200_post_fields&#039;, array( __CLASS__, &#039;update_200_lm_post_fields&#039; ), 11, 1 );
			add_action( &#039;geodir_update_200_term_metas&#039;, array( __CLASS__, &#039;update_200_lm_term_metas&#039; ), 11 );
			add_action( &#039;geodir_update_200_create_tables&#039;, array( __CLASS__, &#039;update_200_lm_create_tables&#039; ), 11 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_lm_update_version&#039; ), 11 );
		}

		// Advance search
		if ( self::needs_upgrade( &#039;advance_search&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_search_get_options&#039; ), 12, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_search_create_default_options&#039; ), 12 );
			add_action( &#039;geodir_update_200_custom_fields&#039;, array( __CLASS__, &#039;update_200_search_custom_fields&#039; ), 12 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_search_update_version&#039; ), 12 );
		}

		// Event manager
		if ( self::needs_upgrade( &#039;event_manager&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_event_get_options&#039; ), 10, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_event_create_default_options&#039; ), 10 );
			add_action( &#039;geodir_update_200_create_tables&#039;, array( __CLASS__, &#039;update_200_event_create_tables&#039; ), 10 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_event_update_version&#039; ), 10 );
		}

		// Review Ratings
		if ( self::needs_upgrade( &#039;review_rating&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_rr_get_options&#039; ), 13, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_rr_create_default_options&#039; ), 13 );
			add_action( &#039;geodir_update_200_create_tables&#039;, array( __CLASS__, &#039;update_200_rr_create_tables&#039; ), 13 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_rr_update_version&#039; ), 13 );
		}

		// Claim Manager
		if ( self::needs_upgrade( &#039;claim_manager&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_claim_get_options&#039; ), 30, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_claim_create_default_options&#039; ), 30 );
			add_action( &#039;geodir_update_200_create_tables&#039;, array( __CLASS__, &#039;update_200_claim_create_tables&#039; ), 30 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_claim_update_version&#039; ), 30 );
		}

		// Franchise Manager
		if ( self::needs_upgrade( &#039;franchise_manager&#039; ) ) {
			add_filter( &#039;geodir_update_200_get_options&#039;, array( __CLASS__, &#039;update_200_franchise_get_options&#039; ), 40, 1 );

			add_action( &#039;geodir_update_200_create_default_options&#039;, array( __CLASS__, &#039;update_200_franchise_create_default_options&#039; ), 40 );
			add_action( &#039;geodir_update_200_custom_fields&#039;, array( __CLASS__, &#039;update_200_franchise_custom_fields&#039; ), 40 );
			add_action( &#039;geodir_update_200_update_gd_version&#039;, array( __CLASS__, &#039;update_200_franchise_update_version&#039; ), 40 );
		}

		add_action( &#039;geodirectory_v2_updated&#039;, array( __CLASS__, &#039;v2_updated&#039; ), 10 );
	}

	public static function needs_upgrade( $plugin ) {
		$found = false;

		switch ( $plugin ) {
			case &#039;advance_search&#039;:
				$found = ! is_null( get_option( &#039;geodiradvancesearch_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_advance_search_db_version&#039;, null ) ) || ( get_option( &#039;geodir_advance_search_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_advance_search_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
			case &#039;claim_manager&#039;:
				$found = ! is_null( get_option( &#039;geodirclaim_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_claim_db_version&#039;, null ) ) || ( get_option( &#039;geodir_claim_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_claim_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
			case &#039;custom_post_types&#039;:
				$found = ! is_null( get_option( &#039;geodir_custom_posts_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_cp_db_version&#039;, null ) ) || ( get_option( &#039;geodir_cp_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_cp_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
			case &#039;event_manager&#039;:
				$found = ! is_null( get_option( &#039;geodirevents_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_event_db_version&#039;, null ) ) || ( get_option( &#039;geodir_event_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_event_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
			case &#039;franchise_manager&#039;:
				$found = ( is_null( get_option( &#039;geodir_franchise_db_version&#039;, null ) ) || ( get_option( &#039;geodir_franchise_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_franchise_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) ) &amp;&amp; ! is_null( get_option( &#039;geodir_franchise_posttypes&#039;, null ) );
			break;
			case &#039;location_manager&#039;:
				$found = ! is_null( get_option( &#039;geodirlocation_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_location_db_version&#039;, null ) ) || ( get_option( &#039;geodir_location_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_location_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
			case &#039;payment_manager&#039;:
				$found = ! is_null( get_option( &#039;geodir_payments_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_pricing_db_version&#039;, null ) ) || ( get_option( &#039;geodir_pricing_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_pricing_db_version&#039; ), &#039;2.5.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
			case &#039;review_rating&#039;:
				$found = ! is_null( get_option( &#039;geodir_reviewratings_db_version&#039;, null ) ) &amp;&amp; ( is_null( get_option( &#039;geodir_reviewrating_db_version&#039;, null ) ) || ( get_option( &#039;geodir_reviewrating_db_version&#039; ) &amp;&amp; version_compare( get_option( &#039;geodir_reviewrating_db_version&#039; ), &#039;2.0.0.0&#039;, &#039;&lt;&#039; ) ) );
			break;
		}

		return $found;
	}

	public static function update_200_settings() {
		global $geodir_options;

		if ( self::is_done( &#039;update_200_settings&#039; ) ) {
			return;
		}

		do_action( &#039;geodir_update_200_settings_before&#039; );

		self::create_default_options();

		$saved_options = get_option( &#039;geodir_settings&#039; );
		if ( empty( $saved_options ) || ! is_array( $saved_options ) ) {
			$saved_options = array();
		}

		$update_options = self::update_200_get_options();
		foreach ( $update_options as $key =&gt; $value ) {
			$saved_options[ $key ] = $value;
		}

		update_option( &#039;geodir_settings&#039;, $saved_options );

		$geodir_options = geodir_get_settings();

		do_action( &#039;geodir_update_200_settings_after&#039; );

		self::update_log( &#039;update_200_settings&#039; );
	}

	public static function update_200_fields() {
		do_action( &#039;geodir_update_200_fields_before&#039; );

		// Custom fields
		self::update_200_custom_fields();

		// Post fields
		self::update_200_post_fields();

		do_action( &#039;geodir_update_200_fields_after&#039; );
	}

	public static function update_200_terms() {
		do_action( &#039;geodir_update_200_terms_before&#039; );

		self::update_200_term_metas();

		do_action( &#039;geodir_update_200_terms_after&#039; );
	}

	public static function update_200_posts() {
		do_action( &#039;geodir_update_200_posts_before&#039; );

		self::update_200_reviews();
		self::update_200_attachments();

		do_action( &#039;geodir_update_200_posts_after&#039; );
	}

	public static function update_200_merge_data() {
		self::create_tables();
		self::insert_default_fields();
		self::insert_default_tabs();
		self::create_pages();

		if ( ! self::is_done( &#039;register_post_status&#039; ) ) {
			GeoDir_Post_types::register_post_status();

			self::update_log( &#039;register_post_status&#039; );
		}

		if ( ! self::is_done( &#039;create_uncategorized_categories&#039; ) ) {
			GeoDir_Admin_Install::create_uncategorized_categories();

			self::update_log( &#039;create_uncategorized_categories&#039; );
		}
		
		self::create_cron_jobs();

		// Queue upgrades/setup wizard
		self::maybe_enable_setup_wizard();
	}

	public static function update_200_db_version() {
		// Update GD version
		self::update_gd_version();

		// Update DB version
		GeoDir_Admin_Install::update_db_version( GEODIRECTORY_VERSION );

		// Flush rules after install
		flush_rewrite_rules();
		do_action( &#039;geodir_flush_rewrite_rules&#039; );
		wp_schedule_single_event( time(), &#039;geodir_flush_rewrite_rules&#039; );

		// Trigger action
		do_action( &#039;geodirectory_v2_updated&#039; );
	}

	/**
	 * Default options.
	 *
	 * Sets up the default options used on the settings page.
     *
     * @since 2.0.0
	 */
	public static function create_default_options() {
		// Include settings so that we can run through defaults
		include_once( dirname( __FILE__ ) . &#039;/class-geodir-admin-settings.php&#039; );
		
		$current_settings = geodir_get_settings();

		$settings = GeoDir_Admin_Settings::get_settings_pages();

		foreach ( $settings as $section ) {
			if ( ! method_exists( $section, &#039;get_settings&#039; ) ) {
				continue;
			}
			$subsections = array_unique( array_merge( array( &#039;&#039; ), array_keys( $section-&gt;get_sections() ) ) );

			foreach ( $subsections as $subsection ) {
				foreach ( $section-&gt;get_settings( $subsection ) as $value ) {
					if ( !isset($current_settings[$value[&#039;id&#039;]]) &amp;&amp; isset( $value[&#039;default&#039;] ) &amp;&amp; isset( $value[&#039;id&#039;] ) ) {
						geodir_update_option($value[&#039;id&#039;], $value[&#039;default&#039;]);
					}
				}
			}
		}

		do_action( &#039;geodir_update_200_create_default_options&#039; );
	}

	public static function update_200_get_options() {
		// Post types
		$v1_post_types = self::v1_post_types();
		$v2_post_types = geodir_get_option( &#039;post_types&#039; );
		if ( ! is_array( $v2_post_types ) || empty( $v2_post_types ) ) {
			$v2_post_types = array();
		}
		if ( ! empty( $v1_post_types ) ) {
			foreach( $v1_post_types as $post_type =&gt; $data ) {
				if ( ! empty( $data[&#039;labels&#039;] ) ) {
					$remove_labels = array( &#039;label_post_profile&#039;, &#039;label_post_info&#039;, &#039;label_post_images&#039;, &#039;label_post_map&#039;, &#039;label_reviews&#039;, &#039;label_related_listing&#039; );
					foreach ( $remove_labels as $label ) {
						if ( isset( $data[&#039;labels&#039;][ $label ] ) ) {
							unset( $data[&#039;labels&#039;][ $label ] );
						}
					}
				}

				if ( ! in_array( &#039;revisions&#039;, $data[&#039;supports&#039;] ) ) {
					$data[&#039;supports&#039;][] = &#039;revisions&#039;;
				}

				if ( $post_type == &#039;gd_place&#039; ) {
					$data[&#039;menu_icon&#039;] = &#039;dashicons-location-alt&#039;;
				} else if ( $post_type == &#039;gd_event&#039; ) {
					$data[&#039;menu_icon&#039;] = &#039;dashicons-calendar-alt&#039;;
				} else {
					$data[&#039;menu_icon&#039;] = &#039;dashicons-admin-site&#039;;
				}

				$data[&#039;default_image&#039;] = self::update_200_generate_attachment_id( get_option( &#039;geodir_cpt_img_&#039; . $post_type ) );

				$data[&#039;disable_reviews&#039;] = in_array( $post_type, (array) get_option( &#039;geodir_disable_rating_cpt&#039; ) );
				$data[&#039;disable_favorites&#039;] = 0;
				$data[&#039;disable_frontend_add&#039;] = ! in_array( $post_type, (array) get_option( &#039;geodir_allow_posttype_frontend&#039; ) );

				if ( self::needs_upgrade( &#039;custom_post_types&#039; ) ) {
					$data[&#039;disable_location&#039;] = in_array( $post_type, (array) get_option( &#039;geodir_cpt_disable_location&#039; ) );
				}

				if ( self::needs_upgrade( &#039;franchise_manager&#039; ) ) {
					$data[&#039;supports_franchise&#039;] = in_array( $post_type, (array) get_option( &#039;geodir_franchise_posttypes&#039; ) );
				}

				$data[&#039;seo&#039;] = array(
					&#039;title&#039; =&gt; ( isset( $data[&#039;seo&#039;][&#039;title&#039;] ) ? $data[&#039;seo&#039;][&#039;title&#039;] : &#039;&#039; ),
                    &#039;meta_title&#039; =&gt; ( isset( $data[&#039;seo&#039;][&#039;meta_title&#039;] ) ? $data[&#039;seo&#039;][&#039;meta_title&#039;] : &#039;&#039; ),
                    &#039;meta_description&#039; =&gt; ( isset( $data[&#039;seo&#039;][&#039;meta_description&#039;] ) ? $data[&#039;seo&#039;][&#039;meta_description&#039;] : &#039;&#039; ),
				);

				$v2_post_types[ $post_type ] = $data;
			}
		}

		// Taxonomies
		$v1_taxonomies = self::v1_taxonomies();
		$v2_taxonomies = geodir_get_option( &#039;taxonomies&#039; );
		if ( ! is_array( $v2_taxonomies ) || empty( $v2_taxonomies ) ) {
			$v2_taxonomies = array();
		}
		if ( ! empty( $v1_taxonomies ) ) {
			foreach( $v1_taxonomies as $taxonomy =&gt; $data ) {
				$v2_taxonomies[ $taxonomy ] = $data;
			}
		}

		$default_location = wp_parse_args( (array) get_option( &#039;geodir_default_location&#039; ), array(
			&#039;country&#039; =&gt; &#039;&#039;,
			&#039;region&#039; =&gt; &#039;&#039;,
			&#039;city&#039; =&gt; &#039;&#039;,
			&#039;city_latitude&#039; =&gt; &#039;&#039;,
			&#039;city_longitude&#039; =&gt; &#039;&#039;,
		) );

		$rating_color = get_option( &#039;geodir_reviewrating_fa_full_rating_color&#039;, &#039;#ff9900&#039; );
		if ( $rating_color == &#039;#757575&#039; ) {
			$rating_color = &#039;#ff9900&#039;;
		}

		// Core options
		$options = array(
			&#039;taxonomies&#039; =&gt; $v2_taxonomies,
			&#039;post_types&#039; =&gt; $v2_post_types,
			&#039;page_add&#039; =&gt; get_option( &#039;geodir_add_listing_page&#039; ),
			&#039;page_location&#039; =&gt; get_option( &#039;geodir_location_page&#039; ),
			&#039;page_terms_conditions&#039; =&gt; get_option( &#039;geodir_term_condition_page&#039; ),
			&#039;email_name&#039; =&gt; get_option( &#039;site_email_name&#039; ),
			&#039;email_address&#039; =&gt; get_option( &#039;site_email&#039; ),
			&#039;search_radius&#039; =&gt; get_option( &#039;geodir_search_dist&#039; ),
			&#039;search_distance_long&#039; =&gt; get_option( &#039;geodir_search_dist_1&#039; ),
			&#039;search_distance_short&#039; =&gt; get_option( &#039;geodir_search_dist_2&#039; ),
			&#039;search_near_addition&#039; =&gt; get_option( &#039;geodir_search_near_addition&#039; ),
			&#039;default_status&#039; =&gt; get_option( &#039;geodir_new_post_default_status&#039; ),
			&#039;search_default_text&#039; =&gt; get_option( &#039;geodir_search_field_default_text&#039; ),
			&#039;search_default_near_text&#039; =&gt; get_option( &#039;geodir_near_field_default_text&#039; ),
			&#039;search_default_button_text&#039; =&gt; get_option( &#039;geodir_search_button_label&#039; ),
			&#039;map_default_marker_icon&#039; =&gt; self::update_200_generate_attachment_id( get_option( &#039;geodir_default_marker_icon&#039; ) ),
			&#039;exclude_post_type_on_map&#039; =&gt; get_option( &#039;geodir_exclude_post_type_on_map&#039; ),
			&#039;exclude_cat_on_map&#039; =&gt; get_option( &#039;geodir_exclude_cat_on_map&#039; ),
			&#039;email_admin_pending_post&#039; =&gt; get_option( &#039;geodir_notify_post_submit&#039; ),
			&#039;email_admin_pending_post_subject&#039; =&gt; get_option( &#039;geodir_post_submited_success_email_subject_admin&#039; ),
			&#039;email_admin_pending_post_body&#039; =&gt; get_option( &#039;geodir_post_submited_success_email_content_admin&#039; ),
			&#039;email_user_pending_post&#039; =&gt; 1,
			&#039;email_user_pending_post_subject&#039; =&gt; get_option( &#039;geodir_post_submited_success_email_subject&#039; ),
			&#039;email_user_pending_post_body&#039; =&gt; get_option( &#039;geodir_post_submited_success_email_content&#039; ),
			&#039;email_user_publish_post&#039; =&gt; 1,
			&#039;email_user_publish_post_subject&#039; =&gt; get_option( &#039;geodir_post_published_email_subject&#039; ),
			&#039;email_user_publish_post_body&#039; =&gt; get_option( &#039;geodir_post_published_email_content&#039; ),
			&#039;email_admin_post_edit&#039; =&gt; get_option( &#039;geodir_notify_post_edited&#039; ),
			&#039;email_admin_post_edit_subject&#039; =&gt; get_option( &#039;geodir_post_edited_email_subject_admin&#039; ),
			&#039;email_admin_post_edit_body&#039; =&gt; get_option( &#039;geodir_post_edited_email_content_admin&#039; ),
			&#039;default_location&#039; =&gt; get_option( &#039;geodir_default_location&#039; ),
			&#039;map_language&#039; =&gt; get_option( &#039;geodir_default_map_language&#039; ),
			&#039;gd_term_icons&#039; =&gt; &#039;&#039;, // force rebuild terms icon on upgrade
			&#039;upload_max_filesize&#039; =&gt; get_option( &#039;geodir_upload_max_filesize&#039; ),
			&#039;search_word_limit&#039; =&gt; get_option( &#039;geodir_search_word_limit&#039; ),
			&#039;email_bcc_user_publish_post&#039; =&gt; get_option( &#039;geodir_bcc_listing_published&#039; ),
			&#039;user_trash_posts&#039; =&gt; get_option( &#039;geodir_disable_perm_delete&#039; ),
			&#039;seo_cpt_title&#039; =&gt; get_option( &#039;geodir_page_title_pt&#039; ),
			&#039;seo_cpt_meta_title&#039; =&gt; get_option( &#039;geodir_meta_title_pt&#039; ),
			&#039;seo_cpt_meta_description&#039; =&gt; get_option( &#039;geodir_meta_desc_pt&#039; ),
			&#039;seo_cat_archive_title&#039; =&gt; get_option( &#039;geodir_page_title_cat-listing&#039; ),
			&#039;seo_cat_archive_meta_title&#039; =&gt; get_option( &#039;geodir_meta_title_listing&#039; ),
			&#039;seo_cat_archive_meta_description&#039; =&gt; get_option( &#039;geodir_meta_desc_listing&#039; ),
			&#039;seo_tag_archive_title&#039; =&gt; get_option( &#039;geodir_page_title_tag&#039; ),
			&#039;seo_single_meta_title&#039; =&gt; get_option( &#039;geodir_meta_title_detail&#039; ),
			&#039;seo_single_meta_description&#039; =&gt; get_option( &#039;geodir_meta_desc_detail&#039; ),
			&#039;seo_location_meta_title&#039; =&gt; get_option( &#039;geodir_meta_title_location&#039; ),
			&#039;seo_location_meta_description&#039; =&gt; get_option( &#039;geodir_meta_desc_location&#039; ),
			&#039;seo_search_meta_title&#039; =&gt; get_option( &#039;geodir_meta_title_search&#039; ),
			&#039;seo_search_meta_description&#039; =&gt; get_option( &#039;geodir_meta_desc_search&#039; ),
			&#039;seo_add_listing_title&#039; =&gt; get_option( &#039;geodir_page_title_add-listing&#039; ),
			&#039;seo_add_listing_title_edit&#039; =&gt; get_option( &#039;geodir_page_title_edit-listing&#039; ),
			&#039;seo_add_listing_meta_title&#039; =&gt; get_option( &#039;geodir_meta_title_add-listing&#039; ),
			&#039;seo_add_listing_meta_description&#039; =&gt; get_option( &#039;geodir_meta_desc_add-listing&#039; ),
			&#039;maps_api&#039; =&gt; get_option( &#039;geodir_load_map&#039; ),
			&#039;lazy_load&#039; =&gt; get_option( &#039;geodir_lazy_load&#039; ),
			&#039;google_maps_api_key&#039; =&gt; get_option( &#039;geodir_google_api_key&#039; ),
			&#039;admin_uninstall&#039; =&gt; get_option( &#039;geodir_un_geodirectory&#039; ),
			&#039;map_cache&#039; =&gt; get_option( &#039;geodir_enable_map_cache&#039; ),
			&#039;admin_blocked_roles&#039; =&gt; array( &#039;subscriber&#039; ),
			&#039;listing_default_image&#039; =&gt; self::update_200_generate_attachment_id( get_option( &#039;geodir_listing_no_img&#039; ) ),
			&#039;rating_color&#039; =&gt; $rating_color,
			&#039;rating_color_off&#039; =&gt; &#039;#afafaf&#039;,
			&#039;rating_type&#039; =&gt; &#039;font-awesome&#039;,
			&#039;rating_icon&#039; =&gt; &#039;fas fa-star&#039;,
			&#039;rating_image&#039; =&gt; self::update_200_generate_attachment_id( get_option( &#039;geodir_default_rating_star_icon&#039; ) ),
			&#039;default_location_city&#039; =&gt; $default_location[&#039;city&#039;],
			&#039;default_location_region&#039; =&gt; $default_location[&#039;region&#039;],
			&#039;default_location_country&#039; =&gt; $default_location[&#039;country&#039;],
			&#039;default_location_latitude&#039; =&gt; $default_location[&#039;city_latitude&#039;],
			&#039;default_location_longitude&#039; =&gt; $default_location[&#039;city_longitude&#039;],
			&#039;default_location_timezone_string&#039; =&gt; geodir_timezone_string(),
			&#039;permalink_category_base&#039; =&gt; &#039;category&#039;,
			&#039;permalink_tag_base&#039; =&gt; &#039;tags&#039;,

			// Google Analytics options
			&#039;ga_stats&#039; =&gt; get_option( &#039;geodir_ga_stats&#039; ),
			&#039;ga_account_id&#039; =&gt; get_option( &#039;geodir_ga_account_id&#039; ),
			&#039;ga_refresh_time&#039; =&gt; get_option( &#039;geodir_ga_refresh_time&#039; ),
			&#039;ga_auto_refresh&#039; =&gt; get_option( &#039;geodir_ga_auto_refresh&#039; ),
			&#039;ga_auth_code&#039; =&gt; get_option( &#039;geodir_ga_auth_code&#039; ),
			&#039;ga_add_tracking_code&#039; =&gt; get_option( &#039;geodir_ga_add_tracking_code&#039; ),
			&#039;ga_anonymize_ip&#039; =&gt; get_option( &#039;geodir_ga_anonymize_ip&#039; ),
			&#039;ga_tracking_code&#039; =&gt; get_option( &#039;geodir_ga_tracking_code&#039; ),
			&#039;gd_ga_access_token&#039; =&gt; get_option( &#039;gd_ga_access_token&#039; ),
			&#039;gd_ga_refresh_token&#039; =&gt; get_option( &#039;gd_ga_refresh_token&#039; ),
			&#039;ga_client_id&#039; =&gt; get_option( &#039;geodir_ga_client_id&#039; ),
			&#039;ga_client_secret&#039; =&gt; get_option( &#039;geodir_ga_client_secret&#039; )
		);

		if ( $options[&#039;rating_type&#039;] == &#039;image&#039; &amp;&amp; empty( $options[&#039;rating_image&#039;] ) ) {
			$options[&#039;rating_type&#039;] = &#039;font-awesome&#039;;
		}

		return apply_filters( &#039;geodir_update_200_get_options&#039;, $options );
	}

	public static function update_200_generate_attachment_id( $image_url ) {
		if ( empty( $image_url ) ) {
			return &#039;&#039;;
		}

		$image_url = str_replace( &#039;geodirectory-assets/&#039;, &#039;assets/&#039;, $image_url );
		$image_url = str_replace( &#039;geodirectory-functions/map-functions/icons&#039;, &#039;assets/images&#039;, $image_url );

		$upload = GeoDir_Media::upload_image_from_url( $image_url );
		if ( ! empty( $upload ) &amp;&amp; ! is_wp_error( $upload ) &amp;&amp; ! empty( $upload[&#039;file&#039;] ) ) {
			$attachment_id = GeoDir_Media::set_uploaded_image_as_attachment( $upload );

			if ( ! empty( $attachment_id ) &amp;&amp; ! is_wp_error( $attachment_id ) ) {
				return $attachment_id;
			}
		}

		return &#039;&#039;;
	}

	public static function update_200_set_permalink_structure() {
		if ( get_option( &#039;geodir_add_location_url&#039; ) ) {
			$show_location_url = get_option( &#039;geodir_show_location_url&#039; );

			if ( $show_location_url == &#039;all&#039; ) {
				$permalink_structure = &#039;/%country%/%region%/%city%/%category%/%postname%/&#039;;
			} else if ( $show_location_url == &#039;country_city&#039; ) {
				$permalink_structure = &#039;/%country%/%city%/%category%/%postname%/&#039;;
			} else if ( $show_location_url == &#039;region_city&#039; ) {
				$permalink_structure = &#039;/%region%/%city%/%category%/%postname%/&#039;;
			} else {
				$permalink_structure = &#039;/%city%/%category%/%postname%/&#039;;
			}
		} else {
			$permalink_structure = &#039;/%category%/%postname%/&#039;;
		}

		if ( ! get_option( &#039;geodir_add_categories_url&#039; ) ) {
			$permalink_structure = str_replace( &#039;/%category%&#039;, &#039;&#039;, $permalink_structure );
		}

		if ( ! empty( $permalink_structure ) ) {
			$permalink_structure = preg_replace( &#039;#/+#&#039;, &#039;/&#039;, &#039;/&#039; . str_replace( &#039;#&#039;, &#039;&#039;, $permalink_structure ) );
		}
		$permalink_structure = sanitize_option( &#039;permalink_structure&#039;, $permalink_structure );

		geodir_set_permalink_structure( $permalink_structure );
	}

	public static function update_200_term_metas() {
	    global $wpdb;

		if ( ! self::is_done( &#039;update_200_term_metas&#039; ) ) {
			// Migrate tax meta.
			$term_meta_options = $wpdb-&gt;get_results( &quot;SELECT option_name, option_value FROM &quot; . $wpdb-&gt;options . &quot; WHERE option_name LIKE &#039;tax_meta_%&#039;&quot; );

			foreach ( $term_meta_options as $option ) {
				$explode = explode( &#039;_&#039;, $option-&gt;option_name );
				$index = count( $explode ) - 1;

				
				if ( !empty( $explode[ $index ] ) ) {
					$term_id = $explode[ $index ];
					$value = maybe_unserialize( $option-&gt;option_value );
					$value = !empty( $value[0] ) &amp;&amp; is_array( $value[0] ) ? $value[0] : $value;
					
					if ( !empty( $value ) &amp;&amp; is_array( $value ) ) {
						foreach ( $value as $meta_key =&gt; $meta_value ) {
							if ( $meta_key == &#039;ct_cat_icon&#039; || $meta_key == &#039;ct_cat_default_img&#039; ) {
								if ( empty( $meta_value[&#039;src&#039;] ) || substr( $meta_value[&#039;src&#039;], 0, 4 ) != &quot;http&quot; ) {
									continue;
								}
								$meta_value[&#039;src&#039;] = geodir_file_relative_url( $meta_value[&#039;src&#039;] );
							}

							update_term_meta( $term_id, $meta_key, $meta_value );
						}
					}
				}
			}

			self::update_log( &#039;update_200_term_metas&#039; );
		}

		do_action( &#039;geodir_update_200_term_metas&#039; );
	}

	public static function update_200_custom_fields() {
		global $wpdb, $plugin_prefix;

		$post_types = self::v2_post_types( true );

		// Custom fields
		$custom_fields_table = GEODIR_CUSTOM_FIELDS_TABLE;
		$packages_table = $plugin_prefix . &#039;price&#039;;

		if ( ! self::is_done( &#039;update_200_custom_fields&#039; ) ) {
			$wpdb-&gt;query( &quot;ALTER TABLE `{$custom_fields_table}` 
				CHANGE admin_desc frontend_desc text NULL DEFAULT NULL, 
				CHANGE site_title frontend_title varchar(255) NULL DEFAULT NULL, 
				ADD `placeholder_value` text NULL DEFAULT NULL AFTER `default_value`, 
				ADD `tab_level` int(11) NOT NULL AFTER `sort_order`, 
				ADD `tab_parent` varchar(100) NOT NULL AFTER `sort_order`;&quot; 
			);

			$results = $wpdb-&gt;get_results( &quot;SELECT * FROM `{$custom_fields_table}`&quot; );

			$wpdb-&gt;query( &quot;ALTER TABLE `{$custom_fields_table}` 
				CHANGE `is_active` `is_active` CHAR(1) NOT NULL DEFAULT &#039;1&#039;, 
				CHANGE `is_default` `is_default` CHAR(1) NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `is_required` `is_required` CHAR(1) NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `for_admin_use` `for_admin_use` CHAR(1) NOT NULL DEFAULT &#039;0&#039;;&quot; 
			);
			$wpdb-&gt;query( &quot;ALTER TABLE `{$custom_fields_table}` 
				CHANGE `is_active` `is_active` TINYINT(1) NOT NULL DEFAULT &#039;1&#039;, 
				CHANGE `is_default` `is_default` TINYINT(1) NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `is_required` `is_required` TINYINT(1) NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `for_admin_use` `for_admin_use` TINYINT(1) NOT NULL DEFAULT &#039;0&#039;;&quot; 
			);

			foreach ( $results as $row ) {
				if ( in_array( $row-&gt;htmlvar_name, array( &#039;geodir_contact&#039;, &#039;is_featured&#039; ) ) ) {
					if ( $row-&gt;htmlvar_name == &#039;geodir_contact&#039; ) {
						$row-&gt;htmlvar_name = &#039;phone&#039;;
					}
					if ( $row-&gt;htmlvar_name == &#039;is_featured&#039; ) {
						$row-&gt;htmlvar_name = &#039;featured&#039;;
					}
				}
				if ( strpos( $row-&gt;htmlvar_name, &#039;geodir_&#039; ) === 0 ) {
					$row-&gt;htmlvar_name = strtolower( substr( $row-&gt;htmlvar_name, 7 ) );
				}

				if ( $row-&gt;field_type == &#039;taxonomy&#039; ) {
					$row-&gt;field_type = &#039;categories&#039;;
					$row-&gt;field_type_key = &#039;categories&#039;;
					$row-&gt;htmlvar_name = &#039;post_category&#039;;
					$extra_fields = maybe_unserialize( $row-&gt;extra_fields );
					if ( ! empty( $extra_fields ) ) {
						if ( $extra_fields == &#039;ajax_chained&#039; ) {
							$cat_display_type = &#039;multiselect&#039;;
						} else {
							$cat_display_type = $extra_fields;
						}
					} else {
						$cat_display_type = &#039;multiselect&#039;;
					}
					$row-&gt;extra_fields = maybe_serialize( array( &#039;cat_display_type&#039; =&gt; $cat_display_type ) );
				}

				if ( $row-&gt;field_type == &#039;address&#039; ) {
					$row-&gt;htmlvar_name = &#039;address&#039;;
					if ( empty( $row-&gt;field_icon ) ) {
						$row-&gt;field_icon = &#039;fas fa-map-marker-alt&#039;;
					}
				}

				if ( empty( $row-&gt;field_type_key ) ) {
					$row-&gt;field_type_key = $row-&gt;field_type;
				}

				if ( empty( $row-&gt;data_type ) ) {
					if ( $row-&gt;field_type == &#039;textarea&#039; || $row-&gt;field_type == &#039;html&#039; || $row-&gt;field_type == &#039;url&#039; ) {
						$data_type = &#039;TEXT&#039;;
					} else if ( $row-&gt;field_type == &#039;checkbox&#039; ) {
						$data_type = &#039;TINYINT&#039;;
					} else if ( $row-&gt;field_type == &#039;datepicker&#039; ) {
						$data_type = &#039;DATE&#039;;
					} else if ( $row-&gt;field_type == &#039;time&#039; ) {
						$data_type = &#039;TIME&#039;;
					} else {
						$data_type = &#039;VARCHAR&#039;;
					}
					$row-&gt;data_type = $data_type;
				}

				if ( ! empty( $row-&gt;field_icon ) &amp;&amp; ( strpos( $row-&gt;field_icon, &#039;fa &#039; ) === 0 || strpos( $row-&gt;field_icon, &#039;fa-&#039; ) === 0 ) ) {
					$field_icon = $row-&gt;field_icon;
					$field_icon = str_replace( &#039;fa &#039;, &#039;fas &#039;, $field_icon );
					$field_icon = str_replace( &#039;fa-usd&#039;, &#039;fa-dollar-sign&#039;, $field_icon );
					$field_icon = str_replace( &#039;fa-money&#039;, &#039;fa-money-bill-alt&#039;, $field_icon );
					$row-&gt;field_icon = $field_icon;
				}
				if ( empty( $row-&gt;htmlvar_name ) ) {
					$title = ( ! empty( $row-&gt;frontend_title ) ? $row-&gt;frontend_title : $row-&gt;admin_title );
					$row-&gt;htmlvar_name = str_replace( &#039;-&#039;, &#039;_&#039;, sanitize_key( str_replace( &#039; &#039;, &#039;_&#039;, $title ) ) . &#039;_&#039; . $row-&gt;id );
				}
				$row-&gt;is_active = (int) $row-&gt;is_active;
				$row-&gt;is_default = (int) $row-&gt;is_default;
				$row-&gt;is_required = (int) $row-&gt;is_required;
				$row-&gt;for_admin_use = (int) $row-&gt;for_admin_use;

				// Fix is_default issue
				if ( in_array( $row-&gt;htmlvar_name, array( &#039;timing&#039;, &#039;contact&#039;, &#039;phone&#039;, &#039;email&#039;, &#039;website&#039;, &#039;twitter&#039;, &#039;facebook&#039;, &#039;video&#039;, &#039;special_offers&#039; ) ) ) {
					$row-&gt;is_default = 0;
				}

				$wpdb-&gt;update( $custom_fields_table, (array) $row, array( &#039;id&#039; =&gt; $row-&gt;id ) );
			}

			self::update_log( &#039;update_200_custom_fields&#039; );
		}

		// Create pre-defined custom fields
		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $key =&gt; $post_type ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				if ( self::is_done( &#039;update_200_custom_fields_predefined_&#039; . $post_type ) ) {
					continue;
				}
				
				$packages = &#039;&#039;;
				if ( self::needs_upgrade( &#039;payment_manager&#039; ) ) {
					$results = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT pid FROM {$packages_table} WHERE post_type = %s&quot;, $post_type ) );
					if ( ! empty( $results ) ) {
						$packages = implode( &#039;,&#039;, $results );
					}
				}

				// Featured
				$field_data = array(
					&#039;post_type&#039; =&gt; $post_type,
					&#039;data_type&#039; =&gt; &#039;TINYINT&#039;, 
					&#039;field_type&#039; =&gt; &#039;checkbox&#039;, 
					&#039;field_type_key&#039; =&gt; &#039;featured&#039;, 
					&#039;admin_title&#039; =&gt; &#039;Featured&#039;, 
					&#039;frontend_desc&#039; =&gt; &#039;Mark listing as a featured.&#039;, 
					&#039;frontend_title&#039; =&gt; &#039;Is Featured?&#039;, 
					&#039;htmlvar_name&#039; =&gt; &#039;featured&#039;, 
					&#039;default_value&#039; =&gt; &#039;&#039;,
					&#039;sort_order&#039; =&gt; &#039;20&#039;,
					&#039;is_active&#039; =&gt; &#039;1&#039;, 
					&#039;show_in&#039; =&gt; &#039;&#039;,
					&#039;for_admin_use&#039; =&gt; &#039;1&#039;, 
					&#039;packages&#039; =&gt; $packages, 
					&#039;cat_sort&#039; =&gt; &#039;1&#039;, 
					&#039;extra_fields&#039; =&gt; &#039;&#039;, 
					&#039;field_icon&#039; =&gt; &#039;fas fa-certificate&#039;
				);

				$wpdb-&gt;insert( $custom_fields_table, $field_data, array( &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039; ) );

				// Claimed
				if ( self::needs_upgrade( &#039;claim_manager&#039; ) ) {
					$field_data = array(
						&#039;post_type&#039; =&gt; $post_type,
						&#039;data_type&#039; =&gt; &#039;TINYINT&#039;, 
						&#039;field_type&#039; =&gt; &#039;checkbox&#039;, 
						&#039;field_type_key&#039; =&gt; &#039;claimed&#039;, 
						&#039;admin_title&#039; =&gt; &#039;Is Claimed?&#039;, 
						&#039;frontend_desc&#039; =&gt; &#039;Mark listing as a claimed.&#039;, 
						&#039;frontend_title&#039; =&gt; &#039;Business Owner/Associate?&#039;, 
						&#039;htmlvar_name&#039; =&gt; &#039;claimed&#039;, 
						&#039;default_value&#039; =&gt; &#039;&#039;,
						&#039;sort_order&#039; =&gt; &#039;21&#039;,
						&#039;is_active&#039; =&gt; &#039;1&#039;, 
						&#039;show_in&#039; =&gt; &#039;&#039;,
						&#039;packages&#039; =&gt; $packages, 
						&#039;cat_sort&#039; =&gt; &#039;1&#039;, 
						&#039;extra_fields&#039; =&gt; &#039;&#039;, 
						&#039;field_icon&#039; =&gt; &#039;fas fa-user-check&#039;
					);

					$wpdb-&gt;insert( $custom_fields_table, $field_data, array( &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039; ) );
				}

				self::update_log( &#039;update_200_custom_fields_predefined_&#039; . $post_type );
			}
		}

		// Sorting fields
		$custom_sort_fields_table = GEODIR_CUSTOM_SORT_FIELDS_TABLE;

		if ( ! self::is_done( &#039;update_200_custom_fields_fields_table&#039; ) ) {
			$results = $wpdb-&gt;get_results( &quot;SELECT * FROM `{$custom_sort_fields_table}`&quot; );

			$wpdb-&gt;query( &quot;ALTER TABLE `{$custom_sort_fields_table}` 
				CHANGE site_title frontend_title varchar(255) NULL DEFAULT NULL, 
				ADD `tab_level` int(11) NOT NULL AFTER `sort_order`, 
				ADD `tab_parent` varchar(100) NOT NULL AFTER `sort_order`, 
				ADD sort varchar(5) DEFAULT &#039;asc&#039;;&quot; 
			);

			if ( ! empty( $results ) ) {
				foreach ( $results as $row ) {
					$htmlvar_name = $row-&gt;htmlvar_name;

					if ( $htmlvar_name == &#039;geodir_contact&#039; ) {
						$htmlvar_name = &#039;phone&#039;;
					}
					if ( $htmlvar_name == &#039;is_featured&#039; ) {
						$htmlvar_name = &#039;featured&#039;;
					}
					if ( strpos( $htmlvar_name, &#039;geodir_&#039; ) === 0 ) {
						$htmlvar_name = strtolower( substr( $htmlvar_name, 7 ) );
					}

					if ( ! empty( $row-&gt;data_type ) ) {
						$data_type = $row-&gt;data_type;
					} else {
						$data_type = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT data_type FROM `{$custom_fields_table}` WHERE htmlvar_name = %s&quot;, $htmlvar_name ) );
					}
					if ( empty( $data_type ) ) {
						$data_type = &#039;VARCHAR&#039;;
					}

					$data = array();
					$data[&#039;post_type&#039;] = $row-&gt;post_type;
					$data[&#039;data_type&#039;] = $data_type;
					$data[&#039;field_type&#039;] = $row-&gt;field_type;
					$data[&#039;htmlvar_name&#039;] = $htmlvar_name;
					$data[&#039;sort_order&#039;] = $row-&gt;sort_order;
					$data[&#039;is_active&#039;] = $row-&gt;is_active;
					$data[&#039;tab_parent&#039;] = 0;

					if ( $row-&gt;field_type == &#039;random&#039; ) {
						$data[&#039;htmlvar_name&#039;] = &#039;post_status&#039;;
						$data[&#039;frontend_title&#039;] = $row-&gt;site_title;
						$data[&#039;is_default&#039;] = ! empty( $row-&gt;is_default ) ? 1 : 0;
						$data[&#039;sort&#039;] = &#039;asc&#039;;

						$wpdb-&gt;update( $custom_sort_fields_table, (array) $data, array( &#039;id&#039; =&gt; $row-&gt;id ) );
					} else {
						$update = true;
						if ( ! empty( $row-&gt;sort_asc ) ) {
							$is_default = ! empty( $row-&gt;is_default ) &amp;&amp; $row-&gt;htmlvar_name . &#039;_asc&#039; ==  $row-&gt;default_order ? 1 : 0;
							$asc_data = $data;
							$asc_data[&#039;frontend_title&#039;] = ! empty( $row-&gt;asc_title ) ? $row-&gt;asc_title : $row-&gt;site_title;
							$asc_data[&#039;is_default&#039;] = $is_default;
							$asc_data[&#039;sort&#039;] = &#039;asc&#039;;

							$wpdb-&gt;update( $custom_sort_fields_table, (array) $asc_data, array( &#039;id&#039; =&gt; $row-&gt;id ) );
							$update = false;
						}
						if ( ! empty( $row-&gt;sort_desc ) ) {
							$is_default = ! empty( $row-&gt;is_default ) &amp;&amp; $row-&gt;htmlvar_name . &#039;_desc&#039; ==  $row-&gt;default_order ? 1 : 0;
							$desc_data = $data;
							$desc_data[&#039;frontend_title&#039;] = ! empty( $row-&gt;desc_title ) ? $row-&gt;desc_title : $row-&gt;site_title;
							$desc_data[&#039;is_default&#039;] = $is_default;
							$desc_data[&#039;sort&#039;] = &#039;desc&#039;;

							if ( $update ) {
								$wpdb-&gt;update( $custom_sort_fields_table, (array) $desc_data, array( &#039;id&#039; =&gt; $row-&gt;id ) );
							} else {
								$wpdb-&gt;insert( $custom_sort_fields_table, (array) $desc_data );
							}
						}
					}
				}

				// update sorting fields sort order
				self::update_200_sort_fields_sort_order();
			}

			self::update_log( &#039;update_200_custom_fields_fields_table&#039; );
		}

		do_action( &#039;geodir_update_200_custom_fields&#039; );
	}

	public static function update_200_post_fields() {
		global $wpdb;

		$post_types = self::v2_post_types( true );

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $key =&gt; $post_type ) {
				if ( self::is_done( &#039;update_200_post_fields_&#039; . $post_type ) ) {
					continue;
				}

				$table = $wpdb-&gt;prefix . &#039;geodir_&#039; . $post_type . &#039;_detail&#039;;
				
				$columns = @$wpdb-&gt;get_results(&quot;DESC {$table}&quot;);

				if ( empty( $columns ) ) {
					continue;
				}

				$fields = array();
				foreach ( $columns as $column_key =&gt; $column ) {
					$fields[ $column-&gt;Field ] = (array) $column;
				}
				$columns = array_keys( $fields );

				$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE {$post_type}category post_category varchar(254) DEFAULT NULL;&quot; );
				if ( in_array( &#039;is_featured&#039;, $columns ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE {$table} DROP INDEX is_featured&quot; );
					// Converting the ENUM to TINYINT directly might give unexpected results. So we should start by converting column to a CHAR(1) and then to TINYINT(1).
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE is_featured featured char(1) NOT NULL DEFAULT &#039;0&#039;;&quot; );
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE featured featured tinyint(1) NOT NULL DEFAULT &#039;0&#039;;&quot; );
				}
				$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` 
					CHANGE submit_ip `submit_ip` varchar(100) DEFAULT NULL, 
					CHANGE post_address `street` varchar(254) DEFAULT NULL, 
					CHANGE post_city `city` varchar(50) DEFAULT NULL, 
					CHANGE post_region `region` varchar(50) DEFAULT NULL, 
					CHANGE post_country `country` varchar(50) DEFAULT NULL, 
					CHANGE post_zip `zip` varchar(50) NULL, 
					CHANGE post_latitude `latitude` varchar(22)  DEFAULT NULL, 
					CHANGE post_longitude `longitude` varchar(22) DEFAULT NULL, 
					CHANGE post_mapview `mapview` varchar(15) DEFAULT NULL;&quot; 
				);
				if ( in_array( &#039;post_mapzoom&#039;, $columns ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE post_mapzoom `mapzoom` varchar(3) DEFAULT NULL;&quot; );
				}
				$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` 
					CHANGE geodir_contact `phone` varchar(254) DEFAULT NULL, 
					CHANGE geodir_email `email` varchar(254) DEFAULT NULL, 
					CHANGE geodir_website `website` text, 
					CHANGE geodir_twitter `twitter` text, 
					CHANGE geodir_facebook `facebook` text, 
					CHANGE geodir_video `video` text, 
					CHANGE geodir_special_offers `special_offers` text;&quot; 
				);
				if ( $post_type == &#039;gd_event&#039; ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` 
						CHANGE is_recurring recurring TINYINT(1) DEFAULT &#039;0&#039;, 
						CHANGE recurring_dates event_dates TEXT NOT NULL;&quot; 
					);
				}
				if ( in_array( &#039;expire_date&#039;, $columns ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE `expire_date` `expire_date` DATE DEFAULT NULL;&quot; );
				}
				if ( in_array( &#039;claimed&#039;, $columns ) ) {
					// Converting the ENUM to TINYINT directly might give unexpected results. So we should start by converting column to a CHAR(1) and then to INT(11).
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE claimed claimed char(1) NOT NULL DEFAULT &#039;0&#039;;&quot; );
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE claimed claimed int(11) DEFAULT &#039;0&#039;;&quot; );
				}
				if ( in_array( &#039;franchise&#039;, $columns ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE franchise franchise_of INT(11) UNSIGNED DEFAULT &#039;0&#039;;&quot; );
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` ADD franchise TINYINT(1) UNSIGNED DEFAULT &#039;0&#039;;&quot; );
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` ADD franchise_fields TEXT NULL;&quot; );
				}

				$wpdb-&gt;query( &quot;ALTER TABLE {$table} ADD INDEX country(country)&quot; );
				$wpdb-&gt;query( &quot;ALTER TABLE {$table} ADD INDEX region(region)&quot; );
				$wpdb-&gt;query( &quot;ALTER TABLE {$table} ADD INDEX city(city)&quot; );

				$change_columns = array();
				foreach ( $columns as $key =&gt; $column ) {
					if ( strpos( $column, &#039;geodir_&#039; ) === 0 &amp;&amp; ! in_array( $column, array( &#039;geodir_contact&#039;, &#039;geodir_email&#039;, &#039;geodir_website&#039;, &#039;geodir_twitter&#039;, &#039;geodir_facebook&#039;, &#039;geodir_video&#039;, &#039;geodir_special_offers&#039; ) ) ) {
						$new_column = strtolower( substr( $fields[ $column ][&#039;Field&#039;], 7 ) );
						$data_type = $fields[ $column ][&#039;Type&#039;];
						$null = strtolower( $fields[ $column ][&#039;Null&#039;] ) == &#039;no&#039; ? &#039; NOT NULL&#039; : &#039;&#039;;
						$default = $fields[ $column ][&#039;Default&#039;] !== &#039;&#039; &amp;&amp; $fields[ $column ][&#039;Default&#039;] !== NULL ? &quot; DEFAULT &#039;&quot; . addslashes( $fields[ $column ][&#039;Default&#039;] ) . &quot;&#039;&quot; : ( strtolower( $fields[ $column ][&#039;Null&#039;] ) == &#039;yes&#039; ? &#039; DEFAULT NULL&#039; : &#039;&#039; );

						$change_columns[] = &quot;CHANGE {$column} `{$new_column}` {$data_type}{$null}{$default}&quot;;
					}
				}
				if ( ! empty( $change_columns ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` &quot; . implode( &quot;, &quot;, $change_columns ) );
				}

				// Drop columns
				$drop_columns = array( &#039;marker_json&#039;, &#039;paid_amount&#039;, &#039;alive_days&#039;, &#039;paymentmethod&#039;, &#039;expire_notification&#039;, &#039;exp2&#039;, &#039;exp3&#039;, &#039;post_location_id&#039;, &#039;post_locations&#039; );

				$query_drop_columns = array();
				foreach( $drop_columns as $drop_column ) {
					if ( in_array( $drop_column, $columns ) ) {
						$query_drop_columns[] = &quot;DROP `{$drop_column}`&quot;;
					}
				}
				if ( ! empty( $query_drop_columns ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` &quot; . implode( &quot;, &quot;, $query_drop_columns ) );
				}

				self::update_log( &#039;update_200_post_fields_&#039; . $post_type );
			}
		}

		do_action( &#039;geodir_update_200_post_fields&#039;, $post_types );
	}

	public static function update_200_reviews() {
		global $wpdb;

		if ( self::is_done( &#039;update_200_reviews&#039; ) ) {
			return;
		}

		$reviews_table = GEODIR_REVIEW_TABLE;
		
		$wpdb-&gt;query( &quot;ALTER TABLE `{$reviews_table}` 
			DROP `id`,
			CHANGE post_id post_id bigint(20) DEFAULT &#039;0&#039;,
			DROP `post_title`,
			CHANGE post_type post_type varchar(20) DEFAULT &#039;&#039;,
			CHANGE user_id user_id bigint(20) DEFAULT &#039;0&#039;, 
			DROP `rating_ip`,
			CHANGE overall_rating rating float DEFAULT &#039;0&#039;,
			CHANGE comment_images attachments text DEFAULT &#039;&#039;,
			DROP `status`,
			DROP `post_status`,
			DROP `post_date`,
			CHANGE post_city city varchar(50) DEFAULT &#039;&#039;,
			CHANGE post_region region varchar(50) DEFAULT &#039;&#039;,
			CHANGE post_country country varchar(50) DEFAULT &#039;&#039;,
			CHANGE post_latitude latitude varchar(22) DEFAULT &#039;&#039;,
			CHANGE post_longitude longitude varchar(22) DEFAULT &#039;&#039;,
			DROP `comment_content`;&quot; 
		);

		if ( self::needs_upgrade( &#039;review_rating&#039; ) ) {
			$columns = @$wpdb-&gt;get_results(&quot;DESC {$reviews_table}&quot;);

			$fields = array();
			foreach ( $columns as $key =&gt; $column ) {
				$fields[ $column-&gt;Field ] = (array) $column;
			}
			$columns = array_keys( $fields );

			if ( ! in_array( &#039;wasthis_review&#039;, $columns ) ) {
				$wpdb-&gt;query( &quot;ALTER TABLE {$reviews_table} ADD `wasthis_review` int(11) NOT NULL;&quot; );
			}

			if ( ! in_array( &#039;read_unread&#039;, $columns ) ) {
				$wpdb-&gt;query( &quot;ALTER TABLE {$reviews_table} ADD `read_unread` VARCHAR(50) NOT NULL;&quot; );
			}

			if ( ! in_array( &#039;total_images&#039;, $columns ) ) {
				$wpdb-&gt;query( &quot;ALTER TABLE {$reviews_table} ADD `total_images` int(11) NOT NULL;&quot; );
			}
		}

		$wpdb-&gt;query( &quot;ALTER TABLE `{$reviews_table}` CHANGE comment_id comment_id bigint(20) DEFAULT NULL, ADD UNIQUE (`comment_id`);&quot; );

		self::update_log( &#039;update_200_reviews&#039; );
	}

	public static function update_200_attachments() {
		global $wpdb;
		
		if ( self::is_done( &#039;update_200_attachments&#039; ) ) {
			return;
		}
		
		$attachments_table = GEODIR_ATTACHMENT_TABLE;

		$wpdb-&gt;query( &quot;ALTER TABLE `{$attachments_table}` 
			DROP `content`, 
			CHANGE `is_featured` `featured` CHAR(1) NULL DEFAULT &#039;0&#039;,
			CHANGE `is_approved` `is_approved` CHAR(1) NULL DEFAULT &#039;1&#039;,
			ADD `date_gmt` datetime NULL default NULL AFTER `post_id`,
			ADD `type` varchar(254) NULL DEFAULT &#039;post_images&#039;;&quot; 
		);

		$wpdb-&gt;query( &quot;ALTER TABLE `{$attachments_table}` 
			CHANGE `featured` `featured` TINYINT(1) NULL DEFAULT &#039;0&#039;, 
			CHANGE `is_approved` `is_approved` TINYINT(1) NULL DEFAULT &#039;1&#039;;&quot; 
		);

		self::update_log( &#039;update_200_attachments&#039; );
	}

	private static function create_tables() {
		global $wpdb;

		$wpdb-&gt;hide_errors();

		require_once( ABSPATH . &#039;wp-admin/includes/upgrade.php&#039; );

		if ( ! self::is_done( &#039;create_tables&#039; ) ) {
			dbDelta( GeoDir_Admin_Install::get_schema() );

			self::update_log( &#039;create_tables&#039; );
		}

		do_action( &#039;geodir_update_200_create_tables&#039; );
	}

	private static function insert_default_fields() {
		$post_types = self::v2_post_types( true );

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $key =&gt; $post_type ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				if ( self::is_done( &#039;insert_default_fields_&#039; . $post_type ) ) {
					continue;
				}

				add_filter( &#039;geodir_before_default_custom_fields_saved&#039;, array( __CLASS__, &#039;filter_custom_fields_saved&#039; ), 100, 1 );

				GeoDir_Admin_Install::insert_default_fields( $post_type );

				remove_filter( &#039;geodir_before_default_custom_fields_saved&#039;, array( __CLASS__, &#039;filter_custom_fields_saved&#039; ), 100, 1 );

				// update custom fields sort order
				self::update_200_fields_sort_order( $post_type );

				self::update_log( &#039;insert_default_fields_&#039; . $post_type );
			}
		}
	}

	private static function insert_default_tabs() {
		global $wpdb;

		$custom_fields_table = GEODIR_CUSTOM_FIELDS_TABLE;
		$tabs_layout_table = GEODIR_TABS_LAYOUT_TABLE;

		$post_types = self::v2_post_types();

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $post_type =&gt; $data ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				if ( self::is_done( &#039;insert_default_tabs_&#039; . $post_type ) ) {
					continue;
				}

				GeoDir_Admin_Install::insert_default_tabs( $post_type );

				self::update_log( &#039;insert_default_tabs_&#039; . $post_type );
			}
		}

		// merge tabs from custom fields
		if ( ! self::is_done( &#039;insert_default_tabs_owntab_data&#039; ) ) {
			$results = $wpdb-&gt;get_results( &quot;SELECT post_type, htmlvar_name, frontend_title, field_icon, sort_order FROM `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` WHERE show_in LIKE &#039;%[owntab]%&#039; AND is_active = &#039;1&#039;&quot; );
			if ( ! empty( $results ) ) {
				foreach ( $results as $key =&gt; $row ) {
					if ( $row-&gt;htmlvar_name &amp;&amp; ! in_array( $row-&gt;htmlvar_name, array( &#039;post_content&#039;, &#039;post_images&#039; ) ) ) {
						$field = array(
							&#039;post_type&#039;     =&gt; $row-&gt;post_type,
							&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
							&#039;tab_type&#039;      =&gt; &#039;meta&#039;,
							&#039;tab_name&#039;      =&gt; __( $row-&gt;frontend_title, &#039;geodirectory&#039; ),
							&#039;tab_icon&#039;      =&gt; ( geodir_is_fa_icon( $row-&gt;field_icon ) ? $row-&gt;field_icon : &#039;&#039; ),
							&#039;tab_key&#039;       =&gt; $row-&gt;htmlvar_name,
							&#039;tab_content&#039;   =&gt; &#039;&#039;,
							&#039;sort_order&#039;    =&gt; $row-&gt;sort_order,
							&#039;tab_level&#039;     =&gt; &#039;0&#039;,
							&#039;tab_parent&#039;    =&gt; &#039;0&#039;
						);

						GeoDir_Settings_Cpt_Tabs::save_tab_item( $field );
					}
				}
			}

			self::update_log( &#039;insert_default_tabs_owntab_data&#039; );
		}

		if ( ! self::is_done( &#039;insert_default_tabs_plugins_data&#039; ) ) {
			if ( self::needs_upgrade( &#039;custom_post_types&#039; ) ) {
				$results = $wpdb-&gt;get_results( &quot;SELECT post_type, htmlvar_name, frontend_title, field_icon FROM `{$custom_fields_table}` WHERE field_type = &#039;link_posts&#039; AND is_active = &#039;1&#039; ORDER BY id ASC&quot; );
				if ( ! empty( $results ) ) {
					$sort_order = (int) $wpdb-&gt;get_var( &quot;SELECT MAX( sort_order ) FROM {$tabs_layout_table} LIMIT 1&quot; );
					foreach ( $results as $key =&gt; $row ) {
						$sort_order++;
						$field = array(
							&#039;post_type&#039;     =&gt; $row-&gt;post_type,
							&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
							&#039;tab_type&#039;      =&gt; &#039;meta&#039;,
							&#039;tab_name&#039;      =&gt; __( $row-&gt;frontend_title, &#039;geodirectory&#039; ),
							&#039;tab_icon&#039;      =&gt; $row-&gt;field_icon,
							&#039;tab_key&#039;       =&gt; $row-&gt;htmlvar_name,
							&#039;tab_content&#039;   =&gt; &#039;&#039;,
							&#039;sort_order&#039;    =&gt; $sort_order,
							&#039;tab_level&#039;     =&gt; &#039;0&#039;,
							&#039;tab_parent&#039;    =&gt; &#039;0&#039;
						);

						GeoDir_Settings_Cpt_Tabs::save_tab_item( $field );

						$sort_by = geodir_get_posts_default_sort( $row-&gt;post_type );
						if ( empty( $sort_by ) ) {
							$sort_by = &#039;latest&#039;;
						}

						$sort_order++;
						$field = array(
							&#039;post_type&#039;     =&gt; $row-&gt;htmlvar_name,
							&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
							&#039;tab_type&#039;      =&gt; &#039;shortcode&#039;,
							&#039;tab_name&#039;      =&gt; $post_types[ $row-&gt;post_type ][&#039;labels&#039;][&#039;name&#039;],
							&#039;tab_icon&#039;      =&gt; $row-&gt;field_icon,
							&#039;tab_key&#039;       =&gt; $post_types[ $row-&gt;post_type ][&#039;has_archive&#039;],
							&#039;tab_content&#039;   =&gt; &#039;[gd_listings post_type=&quot;&#039; . $row-&gt;post_type . &#039;&quot; linked_posts=&quot;from&quot; sort_by=&quot;&#039; . esc_attr( $sort_by ) . &#039;&quot; post_limit=5 layout=2 mb=3]&#039;,
							&#039;sort_order&#039;    =&gt; $sort_order,
							&#039;tab_level&#039;     =&gt; &#039;0&#039;,
							&#039;tab_parent&#039;    =&gt; &#039;0&#039;
						);

						GeoDir_Settings_Cpt_Tabs::save_tab_item( $field );
					}
				}
			}

			if ( self::needs_upgrade( &#039;franchise_manager&#039; ) ) {
				$results = $wpdb-&gt;get_results( &quot;SELECT post_type, field_icon FROM `{$custom_fields_table}` WHERE htmlvar_name = &#039;franchise&#039; AND is_active = &#039;1&#039; ORDER BY id ASC&quot; );
				if ( ! empty( $results ) ) {
					$sort_order = (int) $wpdb-&gt;get_var( &quot;SELECT MAX( sort_order ) FROM {$tabs_layout_table} LIMIT 1&quot; );
					foreach ( $results as $key =&gt; $row ) {
						$sort_order++;
						$field = array(
							&#039;post_type&#039;     =&gt; $row-&gt;post_type,
							&#039;tab_layout&#039;    =&gt; &#039;post&#039;,
							&#039;tab_type&#039;      =&gt; &#039;shortcode&#039;,
							&#039;tab_name&#039;      =&gt; &#039;Franchises&#039;,
							&#039;tab_icon&#039;      =&gt; $row-&gt;field_icon,
							&#039;tab_key&#039;       =&gt; &#039;franchises&#039;,
							&#039;tab_content&#039;   =&gt; &#039;[gd_listings post_type=&quot;&#039; . $row-&gt;post_type . &#039;&quot; sort_by=&quot;latest&quot; title_tag=&quot;h3&quot; layout=&quot;list&quot; post_limit=&quot;5&quot; franchise_of=&quot;auto&quot;]&#039;,
							&#039;sort_order&#039;    =&gt; $sort_order,
							&#039;tab_level&#039;     =&gt; &#039;0&#039;,
							&#039;tab_parent&#039;    =&gt; &#039;0&#039;
						);
						
						GeoDir_Settings_Cpt_Tabs::save_tab_item( $field );
					}
				}
			}

			self::update_log( &#039;insert_default_tabs_plugins_data&#039; );
		}

		// update detail tabs sort order
		self::update_200_post_tabs_sort_order();
	}

	private static function create_pages() {
		global $wpdb;
		
		if ( self::is_done( &#039;create_pages&#039; ) ) {
			return;
		}

		$page_location = geodir_get_option( &#039;page_location&#039; );
		if ( $page_location &amp;&amp; ( $row = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT ID, post_content FROM {$wpdb-&gt;posts} WHERE ID = %d&quot;, array( (int)$page_location ) ) ) ) ) {
			$default_content = GeoDir_Defaults::page_location_content();
			if (strpos($row-&gt;post_content, $default_content) !== false) {}
			else{// only add the default content if it is not already there.
				$post_content = $row-&gt;post_content . &#039; &#039; . $default_content;
				$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;posts} SET post_content = %s WHERE ID = %d&quot;, array( trim( $post_content ), (int)$page_location ) ) );
			}

		}
		$page_add = geodir_get_option( &#039;page_add&#039; );
		if ( $page_add &amp;&amp; ( $row = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT ID, post_content FROM {$wpdb-&gt;posts} WHERE ID = %d&quot;, array( (int)$page_add ) ) ) ) ) {
			$default_content = GeoDir_Defaults::page_add_content();
			if (strpos($row-&gt;post_content, $default_content) !== false) {}
			else{// only add the default content if it is not already there.
				$post_content = $row-&gt;post_content . &#039; &#039; . $default_content;
				$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;posts} SET post_content = %s WHERE ID = %d&quot;, array( trim( $post_content ), (int)$page_add ) ) );
			}

		}

		GeoDir_Admin_Install::create_pages();

		self::update_log( &#039;create_pages&#039; );
	}

	/**
	 * Create cron jobs (clear them first).
     *
     * @since 2.0.0
	 */
	private static function create_cron_jobs() {
		//@todo add crons here
		if ( self::is_done( &#039;create_cron_jobs&#039; ) ) {
			return;
		}

		wp_clear_scheduled_hook( &#039;geodirectory_tracker_send_event&#039; );
		wp_schedule_event( time(), apply_filters( &#039;geodirectory_tracker_event_recurrence&#039;, &#039;daily&#039; ), &#039;geodirectory_tracker_send_event&#039; );

		self::update_log( &#039;create_cron_jobs&#039; );
	}

	/**
	 * See if we need the wizard or not.
	 *
	 * @since 2.0.0
	 */
	private static function maybe_enable_setup_wizard() {
		GeoDir_Admin_Notices::add_notice( &#039;install&#039; );
	}

	/**
	 * Update GeoDirectory version to current.
     *
     * @since 2.0.0
	 */
	private static function update_gd_version() {
		delete_option( &#039;geodirectory_version&#039; );
		add_option( &#039;geodirectory_version&#039;, GEODIRECTORY_VERSION );

		do_action( &#039;geodir_update_200_update_gd_version&#039; );
	}

	

	public static function filter_custom_fields_saved( $fields ) {
		global $wpdb;

		$filter_fields = array();
		foreach( $fields as $key =&gt; $field ) {
			if ( $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT id FROM &quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot; WHERE post_type = %s AND htmlvar_name = %s&quot;, array( $field[&#039;post_type&#039;], $field[&#039;htmlvar_name&#039;] ) ) ) ) {
				continue;
			}
			if ( empty( $field[&#039;sort_order&#039;] ) ) {
				if ( $field[&#039;htmlvar_name&#039;] == &#039;post_title&#039; ) {
					$field[&#039;sort_order&#039;] = 1;
				} else if ( $field[&#039;htmlvar_name&#039;] == &#039;post_content&#039; ) {
					$field[&#039;sort_order&#039;] = 2;
				} else if ( $field[&#039;htmlvar_name&#039;] == &#039;post_category&#039; ) {
					$field[&#039;sort_order&#039;] = 3;
				} else if ( $field[&#039;htmlvar_name&#039;] == &#039;post_tags&#039; ) {
					$field[&#039;sort_order&#039;] = 4;
				} else if ( $field[&#039;htmlvar_name&#039;] == &#039;address&#039; ) {
					$field[&#039;sort_order&#039;] = 5;
				}
			}
			$filter_fields[] = $field;
		}

		return $filter_fields;
	}

	public static function update_200_fields_sort_order( $post_type ) {
		global $wpdb;

		if ( ! empty( $post_type ) ) {
			$results = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id, htmlvar_name, sort_order FROM `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` WHERE post_type = %s ORDER BY sort_order ASC&quot;, array( $post_type ) ) );

			if ( ! empty( $results ) ) {
				$save_order = array();
				$sort_order = 5;
				foreach ( $results as $key =&gt; $row ) {
					if ( in_array( $row-&gt;htmlvar_name, array( &#039;post_title&#039;, &#039;post_content&#039;, &#039;post_category&#039;, &#039;post_tags&#039;, &#039;address&#039; ) ) ) {
						if ( $row-&gt;htmlvar_name == &#039;post_title&#039; ) {
							$row-&gt;sort_order = 1;
						} else if ( $row-&gt;htmlvar_name == &#039;post_content&#039; ) {
							$row-&gt;sort_order = 2;
						} else if ( $row-&gt;htmlvar_name == &#039;post_category&#039; ) {
							$row-&gt;sort_order = 3;
						} else if ( $row-&gt;htmlvar_name == &#039;post_tags&#039; ) {
							$row-&gt;sort_order = 4;
						} else {
							$row-&gt;sort_order = 5;
						}
					} else {
						$sort_order++;
						$row-&gt;sort_order = $sort_order;
					}
					$save_order[] = $row;
				}

				foreach ( $save_order as $key =&gt; $save ) {
					$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` SET `sort_order` = %d WHERE id = %d&quot;, array( $save-&gt;sort_order, $save-&gt;id ) ) );
				}
			}
		}
	}

	public static function update_200_sort_fields_sort_order() {
		global $wpdb;

		$post_types = self::v2_post_types( true );

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $k =&gt; $post_type ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				$results = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id FROM `&quot; . GEODIR_CUSTOM_SORT_FIELDS_TABLE . &quot;` WHERE post_type = %s ORDER BY sort_order ASC, id ASC&quot;, array( $post_type ) ) );

				if ( ! empty( $results ) ) {
					$sort_order = 0;
					foreach ( $results as $key =&gt; $row ) {
						$sort_order++;
						$wpdb-&gt;update( GEODIR_CUSTOM_SORT_FIELDS_TABLE, array( &#039;sort_order&#039; =&gt; $sort_order ), array( &#039;id&#039; =&gt; $row-&gt;id ) );
					}
				}
			}
		}
	}

	public static function update_200_post_tabs_sort_order() {
		global $wpdb;

		$post_types = self::v2_post_types( true );

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $key =&gt; $post_type ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				$results = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id FROM `&quot; . GEODIR_TABS_LAYOUT_TABLE . &quot;` WHERE post_type = %s ORDER BY sort_order ASC, id ASC&quot;, array( $post_type ) ) );

				if ( ! empty( $results ) ) {
					$sort_order = 0;
					foreach ( $results as $key =&gt; $row ) {
						$sort_order++;
						$wpdb-&gt;update( GEODIR_TABS_LAYOUT_TABLE, array( &#039;sort_order&#039; =&gt; $sort_order ), array( &#039;id&#039; =&gt; $row-&gt;id ) );
					}
				}
			}
		}
	}

	// Payment Manager
	public static function update_200_pm_get_options( $options = array() ) {
		$merge_options = array(
			&#039;pm_listing_expiry&#039; =&gt; get_option( &#039;geodir_listing_expiry&#039; ),
			&#039;pm_listing_ex_status&#039; =&gt; get_option( &#039;geodir_listing_ex_status&#039; ),
			&#039;pm_paid_listing_status&#039; =&gt; get_option( &#039;geodir_paid_listing_status&#039; ),
			&#039;pm_free_package_renew&#039; =&gt; get_option( &#039;geodir_payment_free_package_renew&#039; ),
			&#039;pm_cart&#039; =&gt; defined( &#039;WPINV_VERSION&#039; ) ? &#039;invoicing&#039; : &#039;&#039;,
			&#039;email_user_renew_success&#039; =&gt; &#039;1&#039;,
			&#039;email_user_renew_success_subject&#039; =&gt; get_option( &#039;geodir_post_renew_success_email_subject&#039; ),
			&#039;email_user_renew_success_body&#039; =&gt; get_option( &#039;geodir_post_renew_success_email_content&#039; ),
			&#039;email_user_upgrade_success&#039; =&gt; &#039;1&#039;,
			&#039;email_user_upgrade_success_subject&#039; =&gt; get_option( &#039;geodir_post_upgrade_success_email_subject&#039; ),
			&#039;email_user_upgrade_success_body&#039; =&gt; get_option( &#039;geodir_post_upgrade_success_email_content&#039; ),
			&#039;email_user_pre_expiry_reminder&#039; =&gt; get_option( &#039;geodir_listing_preexpiry_notice_disable&#039; ),
			&#039;email_user_pre_expiry_reminder_subject&#039; =&gt; get_option( &#039;geodir_renew_email_subject&#039; ),
			&#039;email_user_pre_expiry_reminder_body&#039; =&gt; get_option( &#039;geodir_renew_email_content&#039; ),
			&#039;email_admin_renew_success&#039; =&gt; &#039;1&#039;,
			&#039;email_admin_renew_success_subject&#039; =&gt; get_option( &#039;geodir_post_renew_success_email_subject_admin&#039; ),
			&#039;email_admin_renew_success_body&#039; =&gt; get_option( &#039;geodir_post_renew_success_email_content_admin&#039; ),
			&#039;email_admin_upgrade_success&#039; =&gt; &#039;1&#039;,
			&#039;email_admin_upgrade_success_subject&#039; =&gt; get_option( &#039;geodir_post_upgrade_success_email_subject_admin&#039; ),
			&#039;email_admin_upgrade_success_body&#039; =&gt; get_option( &#039;geodir_post_upgrade_success_email_content_admin&#039; ),
			&#039;email_user_post_expire&#039; =&gt; &#039;1&#039;,
			&#039;email_user_post_downgrade&#039; =&gt; &#039;1&#039;,
		);
		$notice_days = array();
		if ( get_option( &#039;geodir_listing_preexpiry_notice_days&#039; ) !== false ) {
			$notice_days[] = absint( get_option( &#039;geodir_listing_preexpiry_notice_days&#039; ) );
		}
		if ( get_option( &#039;geodir_listing_preexpiry_notice_days2&#039; ) !== false ) {
			$notice_days[] = absint( get_option( &#039;geodir_listing_preexpiry_notice_days2&#039; ) );
		}
		if ( get_option( &#039;geodir_listing_preexpiry_notice_days3&#039; ) !== false ) {
			$notice_days[] = absint( get_option( &#039;geodir_listing_preexpiry_notice_days3&#039; ) );
		}
		$merge_options[&#039;email_user_pre_expiry_reminder_days&#039;] = ! empty( $notice_days ) ? array_unique( $notice_days ) : &#039;&#039;;

		return array_merge( $options, $merge_options );
	}

	public static function update_200_pm_create_default_options() {
		if ( ! ( defined( &#039;GEODIRPAYMENT_VERSION&#039; ) &amp;&amp; version_compare( GEODIRPAYMENT_VERSION, &#039;2.5.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;pm_listing_expiry&#039; =&gt; &#039;1&#039;,
				&#039;pm_listing_ex_status&#039; =&gt; &#039;gd-expired&#039;,
				&#039;pm_paid_listing_status&#039; =&gt; &#039;publish&#039;,
				&#039;pm_free_package_renew&#039; =&gt; &#039;0&#039;,
				&#039;email_user_renew_success&#039; =&gt; &#039;1&#039;,
				&#039;email_user_upgrade_success&#039; =&gt; &#039;1&#039;,
				&#039;email_admin_renew_success&#039; =&gt; &#039;1&#039;,
				&#039;email_admin_upgrade_success&#039; =&gt; &#039;1&#039;,
				&#039;email_user_post_expire&#039; =&gt; &#039;1&#039;,
				&#039;email_user_post_downgrade&#039; =&gt; &#039;1&#039;,
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_pm_create_tables() {
		global $wpdb, $plugin_prefix;

		$collate = &#039;&#039;;
		if ( $wpdb-&gt;has_cap( &#039;collation&#039; ) ) {
			$collate = $wpdb-&gt;get_charset_collate();
		}

		// Tables
		$packages_table = $plugin_prefix . &#039;price&#039;;
		$package_meta_table = $plugin_prefix . &#039;pricemeta&#039;;
		$post_packages_table = $plugin_prefix . &#039;post_packages&#039;;
		$invoice_table = $plugin_prefix . &#039;invoice&#039;;
		$custom_fields_table = GEODIR_CUSTOM_FIELDS_TABLE;

		if ( ! self::is_done( &#039;update_200_pm_create_tables&#039; ) ) {
			// Package meta table
			$schema = &quot;CREATE TABLE {$package_meta_table} (
			  `meta_id` int(11) unsigned NOT NULL AUTO_INCREMENT,
			  `package_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;,
			  `meta_key` varchar(255) DEFAULT NULL,
			  `meta_value` text,
			  PRIMARY KEY (`meta_id`),
			  KEY `package_id` (`package_id`),
			  KEY `meta_key` (`meta_key`(191))
			) $collate; &quot;;

			// Post package relationship table
			$schema .= &quot;CREATE TABLE {$post_packages_table} (
			  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
			  `post_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;,
			  `package_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;,
			  `cart` varchar(50) NOT NULL,
			  `invoice_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;,
			  `product_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;,
			  `task` varchar(50) NOT NULL,
			  `meta` text NOT NULL,
			  `date` datetime NOT NULL,
			  `status` varchar(20) NOT NULL,
			  PRIMARY KEY (`id`)
			) $collate; &quot;;

			dbDelta( $schema );

			// Change
			$wpdb-&gt;query( &quot;ALTER TABLE `{$packages_table}` CHANGE `pid` `id` int(11) unsigned NOT NULL AUTO_INCREMENT;&quot; );
			$wpdb-&gt;query( &quot;ALTER TABLE `{$packages_table}` 
				CHANGE `title` `name` varchar(255) NOT NULL, 
				CHANGE `amount` `amount` varchar(50) NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `sub_units` `time_unit` varchar(1) NOT NULL DEFAULT &#039;M&#039;, 
				CHANGE `sub_active` `recurring` tinyint(1) NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `sub_units_num_times` `recurring_limit` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `sub_num_trial_days` `trial_interval` int(11) unsigned NOT NULL DEFAULT &#039;1&#039;, 
				CHANGE `sub_num_trial_units` `trial_unit` varchar(1) NOT NULL DEFAULT &#039;M&#039;, 
				CHANGE `downgrade_pkg` `downgrade_pkg` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;, 
				CHANGE `is_default` `is_default` tinyint(1) NOT NULL DEFAULT &#039;0&#039;;&quot; 
			);
			$wpdb-&gt;query( &quot;ALTER TABLE `{$packages_table}` CHANGE `title_desc` `title` text NOT NULL;&quot; );

			// Add
			$wpdb-&gt;query( &quot;ALTER TABLE `{$packages_table}` 
				ADD `time_interval` int(11) unsigned NOT NULL DEFAULT &#039;1&#039; AFTER `days`, 
				ADD `description` text NOT NULL AFTER `title`, 
				ADD `post_status` varchar(20) NOT NULL AFTER `status`, 
				ADD `trial` tinyint(1) NOT NULL DEFAULT &#039;0&#039; AFTER `sub_units_num`;&quot; 
			);
			$wpdb-&gt;query( &quot;ALTER TABLE `{$packages_table}` 
				ADD `fa_icon` varchar(50) NOT NULL AFTER `description`, 
				ADD `trial_amount` varchar(50) NOT NULL DEFAULT &#039;0&#039; AFTER `trial_interval`;&quot; 
			);

			// Update
			$wpdb-&gt;query( &quot;UPDATE `{$packages_table}` SET `time_interval` = days, time_unit = &#039;D&#039;, post_status= &#039;&quot; . get_option( &#039;geodir_paid_listing_status&#039; ) . &quot;&#039; WHERE recurring != &#039;1&#039;&quot; );
			$wpdb-&gt;query( &quot;UPDATE `{$packages_table}` SET `time_interval` = sub_units_num, post_status= &#039;&quot; . get_option( &#039;geodir_paid_listing_status&#039; ) . &quot;&#039; WHERE recurring = &#039;1&#039;&quot; );
			$wpdb-&gt;query( &quot;UPDATE `{$packages_table}` SET `trial` = &#039;1&#039; WHERE trial_interval &gt; 0&quot; );

			self::update_log( &#039;update_200_pm_create_tables&#039; );
		}

		// packages data
		if ( ! self::is_done( &#039;update_200_pm_create_tables_packages_data&#039; ) ) {
			$results = $wpdb-&gt;get_results( &quot;SELECT * FROM `{$packages_table}` ORDER BY id ASC&quot; );
			if ( ! empty( $results ) ) {
				$metas = array( &#039;cat&#039;, &#039;is_featured&#039;, &#039;image_limit&#039;, &#039;cat_limit&#039;, &#039;recurring_pkg&#039;, &#039;google_analytics&#039;, &#039;use_desc_limit&#039;, &#039;desc_limit&#039;, &#039;tag_limit&#039;, &#039;has_upgrades&#039;, &#039;enable_franchise&#039;, &#039;franchise_cost&#039;, &#039;franchise_limit&#039;, &#039;disable_editor&#039; );

				foreach ( $results as $row ) {
					$row = (array)$row;
					$package_id = $row[&#039;id&#039;];

					$rows = array();
					// exclude_field
					$fields = $wpdb-&gt;get_col( &quot;SELECT htmlvar_name FROM `{$custom_fields_table}` WHERE post_type = &#039;&quot; . $row[&#039;post_type&#039;] . &quot;&#039; AND is_default != &#039;1&#039; AND htmlvar_name != &#039;&#039; AND htmlvar_name != &#039;post_images&#039; AND htmlvar_name != &#039;franchise&#039; AND NOT FIND_IN_SET( {$package_id}, packages )&quot; );
					if ( isset( $row[&#039;enable_franchise&#039;] ) &amp;&amp; empty( $row[&#039;enable_franchise&#039;] ) ) {
						$fields[] = &#039;franchise&#039;;
					}
					$meta_value = ! empty( $fields ) ? implode( &quot;,&quot;, $fields ) : &#039;&#039;;
					$rows[] = &quot;( {$package_id}, &#039;exclude_field&#039;, &#039;{$meta_value}&#039; )&quot;;

					foreach ( $metas as $key ) {
						if ( isset( $row[ $key ] ) ) {
							$meta_value = $row[ $key ];

							if ( $key == &#039;cat&#039; ) {
								$meta_key = &#039;exclude_category&#039;;
							} else if ( $key == &#039;cat_limit&#039; ) {
								$meta_key = &#039;category_limit&#039;;
							} else if ( $key == &#039;tag_limit&#039; ) {
								$meta_value = ! empty( $row[ &#039;use_tag_limit&#039; ] ) ? $row[ &#039;use_tag_limit&#039; ] : 0;
							} else if ( $key == &#039;recurring_pkg&#039; ) {
								$meta_key = &#039;no_recurring&#039;;
							} else {
								$meta_key = $key;
							}

							$rows[] = &quot;( {$package_id}, &#039;{$meta_key}&#039;, &#039;{$meta_value}&#039; )&quot;;
						}
					}

					// invoicing_product_id
					$args = array(
						&#039;post_type&#039;      =&gt; &#039;wpi_item&#039;,
						&#039;posts_per_page&#039; =&gt; 1,
						&#039;post_status&#039;    =&gt; &#039;any&#039;,
						&#039;orderby&#039;        =&gt; &#039;ID&#039;,
						&#039;order&#039;          =&gt; &#039;ASC&#039;,
						&#039;meta_query&#039;     =&gt; array( 
							array(
								&#039;key&#039;   =&gt; &#039;_wpinv_type&#039;,
								&#039;value&#039; =&gt; &#039;package&#039;,
							),
							array(
								&#039;key&#039;   =&gt; &#039;_wpinv_custom_id&#039;,
								&#039;value&#039; =&gt; $package_id,
							)
						)
					);
					$posts = get_posts( $args );
					if ( ! empty( $posts[0] ) ) {
						$meta_value = $posts[0]-&gt;ID;
						$rows[] = &quot;({$package_id}, &#039;invoicing_product_id&#039;, &#039;{$meta_value}&#039;)&quot;;
					}

					$wpdb-&gt;query( &quot;INSERT INTO `{$package_meta_table}` (`package_id`, `meta_key`, `meta_value`) VALUES &quot; . implode( &quot;, &quot;, $rows ) . &quot;;&quot; );
				}
			}

			self::update_log( &#039;update_200_pm_create_tables_packages_data&#039; );
		}

		// invoice to post_packages data
		if ( ! self::is_done( &#039;update_200_pm_create_tables_invoices_data&#039; ) ) {
			$results = $wpdb-&gt;get_results( &quot;SELECT * FROM `{$invoice_table}` ORDER BY id ASC&quot; );
			if ( ! empty( $results ) ) {
				$geodir_package_product = array();
				$geodir_package_exists = array();

				foreach ( $results as $row ) {
					if ( ! isset( $geodir_package_exists[ $row-&gt;package_id ] ) ) {
						if ( $wpdb-&gt;get_var( &quot;SELECT id FROM `{$packages_table}` WHERE id = &#039;&quot; . $row-&gt;package_id . &quot;&#039; LIMIT 1&quot; ) ) {
							$geodir_package_exists[ $row-&gt;package_id ] = true;
						} else {
							$geodir_package_exists[ $row-&gt;package_id ] = false;
						}
					}
					if ( empty( $row-&gt;invoice_id ) || empty( $geodir_package_exists[ $row-&gt;package_id ] ) ) {
						continue;
					}

					$invoice_post = $wpdb-&gt;get_row( &quot;SELECT post_date, post_status FROM `{$wpdb-&gt;posts}` WHERE ID = &#039;&quot; . $row-&gt;invoice_id . &quot;&#039; LIMIT 1&quot; );
					if ( empty( $invoice_post ) ) {
						continue;
					}
					if ( ! empty( $geodir_package_product[ $row-&gt;package_id ] ) ) {
						$product_id = $geodir_package_product[ $row-&gt;package_id ];
					} else {
						$product_id = $wpdb-&gt;get_var( &quot;SELECT meta_value FROM `{$package_meta_table}` WHERE package_id = &#039;&quot; . $row-&gt;package_id . &quot;&#039; AND meta_key = &#039;invoicing_product_id&#039; ORDER BY meta_id ASC LIMIT 1&quot; );
						$geodir_package_product[ $row-&gt;package_id ] = $product_id;
					}
					$task = str_replace( &#039;_listing&#039;, &#039;&#039;, $row-&gt;invoice_type );
					if ( $task == &#039;add&#039; ) {
						$task = &#039;new&#039;;
					}
					$meta = (array) maybe_unserialize( $row-&gt;invoice_data );
					$meta[&#039;task&#039;] = $task;
					$data = array(
						&#039;id&#039; =&gt; $row-&gt;id,
						&#039;post_id&#039; =&gt; $row-&gt;post_id,
						&#039;package_id&#039; =&gt; $row-&gt;package_id,
						&#039;cart&#039; =&gt; &#039;invoicing&#039;,
						&#039;invoice_id&#039; =&gt; $row-&gt;invoice_id,
						&#039;product_id&#039; =&gt; $product_id,
						&#039;task&#039; =&gt; $task,
						&#039;meta&#039; =&gt; maybe_serialize( $meta ),
						&#039;date&#039; =&gt; $invoice_post-&gt;post_date,
						&#039;status&#039; =&gt; $invoice_post-&gt;post_status,
					);
					$wpdb-&gt;insert( $post_packages_table, $data, array( &#039;%d&#039;, &#039;%d&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039; ) );
				}
			}

			self::update_log( &#039;update_200_pm_create_tables_invoices_data&#039; );
		}
	}

	public static function update_200_pm_update_version() {
		$version = defined( &#039;GEODIR_PRICING_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_PRICING_VERSION, &#039;2.5.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_PRICING_VERSION : &#039;2.5.0.0&#039;;

		delete_option( &#039;geodir_pricing_version&#039; );
		add_option( &#039;geodir_pricing_version&#039;, $version );

		delete_option( &#039;geodir_pricing_db_version&#039; );
		add_option( &#039;geodir_pricing_db_version&#039;, $version );
	}

	// Custom post types
	public static function update_200_cp_get_options( $options = array() ) {
		$merge_options = array(
			&#039;linked_post_types&#039; =&gt; get_option( &#039;geodir_linked_post_types&#039; ),
			&#039;uninstall_geodir_custom_posts&#039; =&gt; get_option( &#039;geodir_un_geodir_custom_posts&#039; ),
		);

		return array_merge( $options, $merge_options );
	}

	public static function update_200_cp_create_default_options() {
		if ( ! ( defined( &#039;GEODIR_CP_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_CP_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;linked_post_types&#039; =&gt; &#039;&#039;,
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_cp_custom_fields() {
		global $wpdb, $plugin_prefix;

		if ( self::is_done( &#039;update_200_cp_custom_fields&#039; ) ) {
			return;
		}

		// Tables
		$custom_fields_table = GEODIR_CUSTOM_FIELDS_TABLE;
		$packages_table = $plugin_prefix . &#039;price&#039;;

		$post_types = self::v1_post_types();

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $post_type =&gt; $data ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				if ( $post_type == &#039;gd_event&#039; ) {
					$data[&#039;link_business&#039;] = 1;
					$data[&#039;linkable_to&#039;] = &#039;gd_place&#039;;
				}

				if ( ! empty( $data[&#039;link_business&#039;] ) &amp;&amp; ! empty( $data[&#039;linkable_to&#039;] ) &amp;&amp; ! empty( $post_types[ $data[&#039;linkable_to&#039;] ] ) ) {
					$linked_to_name = $post_types[ $data[&#039;linkable_to&#039;] ][&#039;labels&#039;][&#039;singular_name&#039;];

					$packages = &#039;&#039;;
					if ( self::needs_upgrade( &#039;payment_manager&#039; ) ) {
						$results = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT pid FROM {$packages_table} WHERE post_type = %s&quot;, $post_type ) );
						if ( ! empty( $results ) ) {
							$packages = implode( &#039;,&#039;, $results );
						}
					}

					$link_data = array(
						&#039;post_type&#039; =&gt; $post_type,
						&#039;data_type&#039; =&gt; &#039;TEXT&#039;, 
						&#039;field_type&#039; =&gt; &#039;link_posts&#039;, 
						&#039;field_type_key&#039; =&gt; $data[&#039;linkable_to&#039;], 
						&#039;admin_title&#039; =&gt; &#039;Link Posts: &#039; . $linked_to_name, 
						&#039;frontend_desc&#039; =&gt; wp_sprintf( &#039;Select your %s to link with this %s.&#039;, $linked_to_name, $data[&#039;labels&#039;][&#039;singular_name&#039;] ), 
						&#039;frontend_title&#039; =&gt; $linked_to_name, 
						&#039;htmlvar_name&#039; =&gt; $data[&#039;linkable_to&#039;], 
						&#039;sort_order&#039; =&gt; &#039;-1&#039;, 
						&#039;is_active&#039; =&gt; &#039;1&#039;, 
						&#039;show_in&#039; =&gt; &#039;[detail]&#039;,  
						&#039;packages&#039; =&gt; $packages, 
						&#039;extra_fields&#039; =&gt; maybe_serialize( array( &#039;max_posts&#039; =&gt; 1, &#039;all_posts&#039; =&gt; 0 ) ), 
						&#039;field_icon&#039; =&gt; &#039;fas fa-link&#039;
					);

					$wpdb-&gt;insert( $custom_fields_table, $link_data, array( &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039; ) );
				}
			}
		}

		self::update_log( &#039;update_200_cp_custom_fields&#039; );
	}

	public static function update_200_cp_post_fields( $post_types ) {
		global $wpdb;

	}

	public static function update_200_cp_create_tables() {
		global $wpdb, $plugin_prefix;

		$collate = &#039;&#039;;
		if ( $wpdb-&gt;has_cap( &#039;collation&#039; ) ) {
			$collate = $wpdb-&gt;get_charset_collate();
		}

		// Tables
		$cp_link_posts_table = $plugin_prefix . &#039;cp_link_posts&#039;;

		if ( ! self::is_done( &#039;update_200_cp_create_tables&#039; ) ) {
			// Link posts table
			$schema = &quot;CREATE TABLE {$cp_link_posts_table} (
				post_type varchar(50) NOT NULL,
				post_id int(11) NOT NULL DEFAULT 0,
				linked_id int(11) NOT NULL DEFAULT 0,
				linked_post_type varchar(50) NOT NULL,
				PRIMARY KEY (post_id,linked_id),
				KEY post_id (post_id)
			) $collate;&quot;;
			$wpdb-&gt;query( $schema );

			self::update_log( &#039;update_200_cp_create_tables&#039; );
		}

		$post_types = self::v2_post_types( true );

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $key =&gt; $post_type ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				if ( self::is_done( &#039;update_200_cp_link_posts_data_&#039; . $post_type ) ) {
					continue;
				}

				$table = $wpdb-&gt;prefix . &#039;geodir_&#039; . $post_type . &#039;_detail&#039;;

				$results = @$wpdb-&gt;get_results(&quot;DESC {$table}&quot;);

				if ( empty( $results ) ) {
					continue;
				}

				$columns = array();
				foreach ( $results as $key =&gt; $row ) {
					$columns[] = $row-&gt;Field;
				}

				if ( ! in_array( &#039;link_business&#039;, $columns ) ) {
					continue;
				}

				$results = $wpdb-&gt;get_results( &quot;SELECT post_id, link_business FROM {$table} WHERE link_business &gt; 0&quot; );
				if ( empty( $results ) ) {
					continue;
				}

				foreach ( $results as $row ) {
					$linked_post_type = get_post_type( (int) $row-&gt;link_business );

					if ( $linked_post_type ) {
						$link_data = array(
							&#039;post_type&#039; =&gt; $post_type,
							&#039;post_id&#039; =&gt; $row-&gt;post_id,
							&#039;linked_id&#039; =&gt; (int) $row-&gt;link_business,
							&#039;linked_post_type&#039; =&gt; $linked_post_type
						);
						$wpdb-&gt;insert( $cp_link_posts_table, $link_data, array( &#039;%s&#039;, &#039;%d&#039;, &#039;%d&#039;, &#039;%s&#039; ) );
					}
				}

				self::update_log( &#039;update_200_cp_link_posts_data_&#039; . $post_type );
			}
		}
	}

	public static function update_200_cp_update_version() {
		$version = defined( &#039;GEODIR_CP_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_CP_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_CP_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_cp_version&#039; );
		add_option( &#039;geodir_cp_version&#039;, $version );

		delete_option( &#039;geodir_cp_db_version&#039; );
		add_option( &#039;geodir_cp_db_version&#039;, $version );
	}

	// Location Manager
	public static function update_200_lm_create_default_options() {
		if ( ! ( defined( &#039;GEODIRLOCATION_VERSION&#039; ) &amp;&amp; version_compare( GEODIRLOCATION_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;lm_home_go_to&#039; =&gt; &#039;root&#039;,
				&#039;lm_default_country&#039; =&gt; &#039;multi&#039;,
				&#039;lm_selected_countries&#039; =&gt; &#039;&#039;,
				&#039;lm_hide_country_part&#039; =&gt; &#039;0&#039;,
				&#039;lm_default_region&#039; =&gt; &#039;multi&#039;,
				&#039;lm_selected_regions&#039; =&gt; &#039;&#039;,
				&#039;lm_hide_region_part&#039; =&gt; &#039;0&#039;,
				&#039;lm_default_city&#039; =&gt; &#039;multi&#039;,
				&#039;lm_selected_cities&#039; =&gt; &#039;0&#039;,
				&#039;lm_enable_neighbourhoods&#039; =&gt; &#039;0&#039;,
				&#039;lm_location_address_fill&#039; =&gt; &#039;0&#039;,
				&#039;lm_location_dropdown_all&#039; =&gt; &#039;0&#039;,
				&#039;lm_set_address_disable&#039; =&gt; &#039;0&#039;,
				&#039;lm_set_pin_disable&#039; =&gt; &#039;0&#039;,
				&#039;lm_location_no_of_records&#039; =&gt; &#039;50&#039;,
				&#039;lm_disable_term_auto_count&#039; =&gt; &#039;0&#039;,
				&#039;lm_sitemap_exclude_location&#039; =&gt; &#039;0&#039;,
				&#039;lm_sitemap_exclude_cats&#039; =&gt; &#039;0&#039;,
				&#039;lm_sitemap_exclude_tags&#039; =&gt; &#039;1&#039;
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_lm_get_options( $options = array() ) {
		$lm_options = array(
			&#039;lm_home_go_to&#039; =&gt; get_option( &#039;geodir_home_go_to&#039; ),
			&#039;lm_default_country&#039; =&gt; get_option( &#039;geodir_enable_country&#039; ),
			&#039;lm_hide_country_part&#039; =&gt; get_option( &#039;geodir_location_hide_country_part&#039; ),
			&#039;lm_selected_countries&#039; =&gt; get_option( &#039;geodir_selected_countries&#039; ),
			&#039;lm_default_region&#039; =&gt; get_option( &#039;geodir_enable_region&#039; ),
			&#039;lm_hide_region_part&#039; =&gt; get_option( &#039;geodir_location_hide_region_part&#039; ),
			&#039;lm_selected_regions&#039; =&gt; get_option( &#039;geodir_selected_regions&#039; ),
			&#039;lm_default_city&#039; =&gt; get_option( &#039;geodir_enable_city&#039; ),
			&#039;lm_selected_cities&#039; =&gt; get_option( &#039;geodir_selected_cities&#039; ),
			&#039;lm_enable_neighbourhoods&#039; =&gt; get_option( &#039;location_neighbourhoods&#039; ),
			&#039;lm_location_address_fill&#039; =&gt; get_option( &#039;location_address_fill&#039; ),
			&#039;lm_location_dropdown_all&#039; =&gt; get_option( &#039;location_dropdown_all&#039; ),
			&#039;lm_set_address_disable&#039; =&gt; get_option( &#039;location_set_address_disable&#039; ),
			&#039;lm_set_pin_disable&#039; =&gt; get_option( &#039;location_set_pin_disable&#039; ),
			&#039;lm_location_no_of_records&#039; =&gt; get_option( &#039;geodir_location_no_of_records&#039; ),
			&#039;lm_disable_term_auto_count&#039; =&gt; get_option( &#039;geodir_location_disable_term_auto_count&#039; ),
			&#039;lm_sitemap_exclude_location&#039; =&gt; get_option( &#039;gd_location_sitemap_exclude_location&#039;, &#039;0&#039; ),
			&#039;lm_sitemap_exclude_cats&#039; =&gt; get_option( &#039;gd_location_sitemap_exclude_cats&#039;, &#039;0&#039; ),
			&#039;lm_sitemap_exclude_tags&#039; =&gt; get_option( &#039;gd_location_sitemap_exclude_tags&#039;, &#039;1&#039; ),
			&#039;uninstall_geodir_location_manager&#039; =&gt; get_option( &#039;geodir_un_geodir_location_manager&#039; ),
		);

		return array_merge( $options, $lm_options );
	}

	public static function update_200_lm_post_fields( $post_types ) {
		global $wpdb;

		if ( ! empty( $post_types ) &amp;&amp; ! self::is_done( &#039;update_200_lm_post_fields&#039; ) ) {
			foreach ( $post_types as $key =&gt; $post_type ) {
				$table = $wpdb-&gt;prefix . &#039;geodir_&#039; . $post_type . &#039;_detail&#039;;

				if ( geodir_column_exist( $table, &#039;neighbourhood&#039; ) ) {
					continue;
				}

				if ( geodir_column_exist( $table, &#039;post_neighbourhood&#039; ) ) {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` CHANGE post_neighbourhood neighbourhood VARCHAR(50) NULL&quot; );
				} else {
					$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` ADD `neighbourhood` VARCHAR(50) NULL AFTER longitude&quot; );
				}
			}

			self::update_log( &#039;update_200_lm_post_fields&#039; );
		}
	}

	public static function update_200_lm_term_metas() {
		global $wpdb;

		if ( self::is_done( &#039;update_200_lm_term_metas&#039; ) ) {
			return;
		}

		// Migrate tax meta.
		$term_meta_options = $wpdb-&gt;get_results( &quot;SELECT option_name, option_value FROM &quot; . $wpdb-&gt;options . &quot; WHERE option_name LIKE &#039;geodir_cat_loc_gd_%&#039;&quot; );

		if ( ! empty( $term_meta_options ) ) {
			$update_meta = array();
			foreach ( $term_meta_options as $key =&gt; $option ) {
				$name = str_replace( &#039;geodir_cat_loc_&#039;, &#039;&#039;, $option-&gt;option_name );
				$value = strpos( $option-&gt;option_value, &#039;a:&#039; ) === 0 ? maybe_unserialize( $option-&gt;option_value ) : $option-&gt;option_value;

				if ( is_array( $value ) ) { // city
					if ( empty( $value[&#039;gd_cat_loc_cat_id&#039;] ) ) {
						continue;
					}
					$term_id = (int) $value[&#039;gd_cat_loc_cat_id&#039;];

					if ( isset( $value[&#039;gd_cat_loc_default&#039;] ) ) {
						$update_meta[ $term_id ][&#039;gd_desc_custom&#039;] = empty( $value[&#039;gd_cat_loc_default&#039;] ) ? true : false;
					}

					if ( ! empty( $value[&#039;gd_cat_loc_loc_id&#039;] ) &amp;&amp; isset( $value[&#039;gd_cat_loc_desc&#039;] ) ) {
						$update_meta[ $term_id ][&#039;gd_desc_id_&#039; . $value[&#039;gd_cat_loc_loc_id&#039;] ] = $value[&#039;gd_cat_loc_desc&#039;];
					}
				} else { // country, region
					$term_id = 0;
					$type = &#039;&#039;;

					if ( strpos( $name, &#039;_co_&#039; ) &gt; 0 ) {
						$type = &#039;co&#039;;
						$names = explode( &#039;_co_&#039;, $name, 2 );
						if ( ! empty( $names ) ) {
							$names_id = explode( &#039;_&#039;, $names[0] );
							if ( ! empty( $names_id ) &amp;&amp; (int) $names_id[ count( $names_id ) - 1 ] &gt; 0 ) {
								$term_id = (int) $names_id[ count( $names_id ) - 1 ];
							}
						}
					} else if ( strpos( $name, &#039;_re_&#039; ) &gt; 0 ) {
						$type = &#039;re&#039;;
						$names = explode( &#039;_re_&#039;, $name, 2 );
						if ( ! empty( $names ) ) {
							$names_id = explode( &#039;_&#039;, $names[0] );
							if ( ! empty( $names_id ) &amp;&amp; (int) $names_id[ count( $names_id ) - 1 ] &gt; 0 ) {
								$term_id = (int) $names_id[ count( $names_id ) - 1 ];
							}
						}
					}

					if ( $term_id &gt; 0 ) {
						$update_meta[ $term_id ][&#039;gd_desc_&#039; . $type . &#039;_&#039; . $names[1] ] = $value;
					}
				}
			}

			if ( ! empty( $update_meta ) ) {
				foreach ( $update_meta as $term_id =&gt; $metas ) {
					if ( ! empty( $metas ) ) {
						foreach ( $metas as $meta_key =&gt; $meta_value ) {
							update_term_meta( $term_id, $meta_key, $meta_value );
						}
					}
				}
			}
		}

		self::update_log( &#039;update_200_lm_term_metas&#039; );
	}

	public static function update_200_lm_create_tables() {
		global $wpdb, $plugin_prefix;
		
		if ( self::is_done( &#039;update_200_lm_create_tables&#039; ) ) {
			return;
		}

		// Locations table
		$locations_table = $plugin_prefix . &#039;post_locations&#039;;

		$wpdb-&gt;query( &quot;ALTER TABLE `{$locations_table}` 
			DROP `city_meta`, 
			DROP `city_desc`, 
			CHANGE city_latitude latitude varchar(22) NOT NULL, 
			CHANGE city_longitude longitude varchar(22) NOT NULL, 
			CHANGE is_default is_default CHAR(1) NOT NULL DEFAULT &#039;0&#039;&quot; 
		);
		$wpdb-&gt;query( &quot;ALTER TABLE `{$locations_table}` CHANGE is_default is_default TINYINT(1) NOT NULL DEFAULT &#039;0&#039;&quot; );

		// Neighbourhoods table
		$neighbourhoods_table = $plugin_prefix . &#039;post_neighbourhood&#039;;

		$wpdb-&gt;query( &quot;ALTER TABLE `{$neighbourhoods_table}` ADD image int(11) NOT NULL&quot; );

		// Location seo table
		$seo_table = $plugin_prefix . &#039;location_seo&#039;;

		$wpdb-&gt;query( &quot;ALTER TABLE `{$seo_table}` 
			DROP `date_created`, 
			DROP `date_updated`, 
			DROP `seo_title`, 
			CHANGE seo_meta_title meta_title varchar(254) NOT NULL, 
			CHANGE seo_meta_desc meta_desc text NOT NULL, 
			CHANGE seo_desc location_desc text NOT NULL, 
			CHANGE seo_image image varchar(254) NOT NULL, 
			CHANGE seo_image_tagline image_tagline varchar(140) NOT NULL;&quot; 
		);

		self::update_log( &#039;update_200_lm_create_tables&#039; );
	}

	public static function update_200_lm_update_version() {
		$version = defined( &#039;GEODIRLOCATION_VERSION&#039; ) &amp;&amp; version_compare( GEODIRLOCATION_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIRLOCATION_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_location_version&#039; );
		add_option( &#039;geodir_location_version&#039;, $version );

		delete_option( &#039;geodir_location_db_version&#039; );
		add_option( &#039;geodir_location_db_version&#039;, $version );
	}

	// Advance search
	public static function update_200_search_get_options( $options = array() ) {
		$merge_options = array(
			&#039;advs_enable_autocompleter&#039; =&gt; get_option( &#039;geodir_enable_autocompleter&#039; ),
			&#039;advs_autocompleter_autosubmit&#039; =&gt; get_option( &#039;geodir_autocompleter_autosubmit&#039; ),
			&#039;advs_autocompleter_min_chars&#039; =&gt; get_option( &#039;geodir_autocompleter_min_chars&#039; ),
			&#039;advs_autocompleter_max_results&#039; =&gt; get_option( &#039;geodir_autocompleter_max_results&#039; ),
			&#039;advs_autocompleter_filter_location&#039; =&gt; get_option( &#039;geodir_autocompleter_filter_location&#039; ),
			&#039;advs_enable_autocompleter_near&#039; =&gt; get_option( &#039;geodir_enable_autocompleter_near&#039; ),
			&#039;advs_autocompleter_autosubmit_near&#039; =&gt; get_option( &#039;geodir_autocompleter_autosubmit_near&#039; ),
			&#039;advs_first_load_redirect&#039; =&gt; get_option( &#039;geodir_first_load_redirect&#039; ),
			&#039;advs_autolocate_ask&#039; =&gt; get_option( &#039;geodir_autolocate_ask&#039; ),
			&#039;advs_near_me_dist&#039; =&gt; get_option( &#039;geodir_near_me_dist&#039; ),
			&#039;advs_search_display_searched_params&#039; =&gt; get_option( &#039;geodir_search_display_searched_params&#039; ),
			&#039;uninstall_geodir_advance_search_filters&#039; =&gt; get_option( &#039;geodir_un_geodir_advance_search_filters&#039; ),
		);

		return array_merge( $options, $merge_options );
	}

	public static function update_200_search_create_default_options() {
		if ( ! ( defined( &#039;GEODIRADVANCESEARCH_VERSION&#039; ) &amp;&amp; version_compare( GEODIRADVANCESEARCH_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;advs_enable_autocompleter&#039; =&gt; &#039;1&#039;,
				&#039;advs_autocompleter_autosubmit&#039; =&gt; &#039;1&#039;,
				&#039;advs_autocompleter_min_chars&#039; =&gt; &#039;3&#039;,
				&#039;advs_autocompleter_max_results&#039; =&gt; &#039;10&#039;,
				&#039;advs_autocompleter_filter_location&#039; =&gt; &#039;&#039;,
				&#039;advs_enable_autocompleter_near&#039; =&gt; &#039;1&#039;,
				&#039;advs_autocompleter_autosubmit_near&#039; =&gt; &#039;0&#039;,
				&#039;advs_first_load_redirect&#039; =&gt; &#039;no&#039;,
				&#039;advs_autolocate_ask&#039; =&gt; &#039;0&#039;,
				&#039;advs_near_me_dist&#039; =&gt; &#039;40&#039;,
				&#039;advs_search_display_searched_params&#039; =&gt; &#039;0&#039;
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_search_custom_fields() {
		global $wpdb, $plugin_prefix;

		if ( self::is_done( &#039;update_200_search_custom_fields&#039; ) ) {
			return;
		}

		// Advance search fields table
		$table = $plugin_prefix . &#039;custom_advance_search_fields&#039;;

		$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` 
			CHANGE site_htmlvar_name htmlvar_name varchar(255) NOT NULL, 
			CHANGE field_site_name admin_title varchar(255) NULL DEFAULT NULL, 
			CHANGE front_search_title frontend_title varchar(255) NULL DEFAULT NULL, 
			CHANGE field_site_type field_type varchar(100) NOT NULL, 
			CHANGE first_search_value range_start int(11) NOT NULL, 
			CHANGE search_min_value range_min int(11) NOT NULL, 
			CHANGE search_max_value range_max int(11) NOT NULL, 
			CHANGE expand_custom_value range_expand int(11) NOT NULL, 
			CHANGE searching_range_mode range_mode tinyint(1) NOT NULL DEFAULT &#039;0&#039;, 
			CHANGE search_diff_value range_step int(11) NOT NULL, 
			CHANGE field_input_type input_type varchar(100) NULL DEFAULT NULL, 
			CHANGE field_data_type data_type varchar(100) NULL DEFAULT NULL, 
			CHANGE first_search_text range_from_title varchar(255) NULL DEFAULT NULL, 
			CHANGE last_search_text range_to_title varchar(255) NULL DEFAULT NULL, 
			CHANGE field_desc description text NULL DEFAULT NULL;&quot; 
		);

		// Update fields data
		$results = $wpdb-&gt;get_results( &quot;SELECT id, htmlvar_name, field_type, post_type FROM `{$table}`&quot; );

		if ( ! empty( $results ) ) {
			foreach ( $results as $row ) {
				$data = array();

				$htmlvar_name = $row-&gt;htmlvar_name;

				if ( $htmlvar_name == &#039;dist&#039; ) {
					$htmlvar_name = &#039;distance&#039;;
				} else if ( $htmlvar_name == &#039;geodir_contact&#039; ) {
					$htmlvar_name = &#039;phone&#039;;
				} else if ( $htmlvar_name == &#039;is_featured&#039; ) {
					$htmlvar_name = &#039;featured&#039;;
				} else if ( $htmlvar_name == &#039;fieldset&#039; &amp;&amp; $row-&gt;field_type == &#039;fieldset&#039; ) {
					$htmlvar_name = &#039;fieldset_&#039; . $row-&gt;id; // Fix duplicate htmlvar name
				} else if ( $htmlvar_name == &#039;event&#039; ) {
					$htmlvar_name = &#039;event_dates&#039;;
				}

				if ( $row-&gt;field_type == &#039;taxonomy&#039; ) {
					$htmlvar_name = &#039;post_category&#039;;
					$data[&#039;field_type&#039;] = &#039;categories&#039;;
				}

				if ( strpos( $htmlvar_name, &#039;geodir_&#039; ) === 0 ) {
					$htmlvar_name = strtolower( substr( $htmlvar_name, 7 ) );
				}

				if ( $htmlvar_name === $row-&gt;htmlvar_name ) {
					continue;
				}

				$data[&#039;htmlvar_name&#039;] = $htmlvar_name;

				$wpdb-&gt;update( $table, $data, array( &#039;id&#039; =&gt; $row-&gt;id ) );
			}
		}

		self::update_log( &#039;update_200_search_custom_fields&#039; );
	}

	public static function update_200_search_update_version() {
		$version = defined( &#039;GEODIR_ADV_SEARCH_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_ADV_SEARCH_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_ADV_SEARCH_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_advance_search_version&#039; );
		add_option( &#039;geodir_advance_search_version&#039;, $version );

		delete_option( &#039;geodir_advance_search_db_version&#039; );
		add_option( &#039;geodir_advance_search_db_version&#039;, $version );
	}

	// Event Manager
	public static function update_200_event_get_options( $options = array() ) {
		$merge_options = array(
			&#039;event_default_filter&#039; =&gt; get_option( &#039;geodir_event_defalt_filter&#039; ),
			&#039;event_disable_recurring&#039; =&gt; get_option( &#039;geodir_event_disable_recurring&#039; ),
			&#039;event_hide_past_dates&#039; =&gt; get_option( &#039;geodir_event_hide_past_dates&#039; ),
			&#039;event_map_popup_count&#039; =&gt; get_option( &#039;geodir_event_infowindow_dates_count&#039; ),
			&#039;event_map_popup_dates&#039; =&gt; get_option( &#039;geodir_event_infowindow_dates_filter&#039; ),
			&#039;event_field_date_format&#039; =&gt; get_option( &#039;geodir_event_date_format_feild&#039; ),
			&#039;event_display_date_format&#039; =&gt; get_option( &#039;geodir_event_date_format&#039; ),
			&#039;event_use_custom_format&#039; =&gt; get_option( &#039;geodir_event_date_use_custom&#039; ),
			&#039;event_custom_date_format&#039; =&gt; get_option( &#039;geodir_event_date_format_custom&#039; ),
			&#039;event_link_any_user&#039; =&gt; get_option( &#039;geodir_event_link_any&#039; )
		);

		return array_merge( $options, $merge_options );
	}

	public static function update_200_event_create_default_options() {
		if ( ! ( defined( &#039;GDEVENTS_VERSION&#039; ) &amp;&amp; version_compare( GDEVENTS_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;event_default_filter&#039; =&gt; &#039;upcoming&#039;,
				&#039;event_disable_recurring&#039; =&gt; &#039;0&#039;,
				&#039;event_hide_past_dates&#039; =&gt; &#039;0&#039;,
				&#039;event_map_popup_count&#039; =&gt; &#039;1&#039;,
				&#039;event_map_popup_dates&#039; =&gt; &#039;upcoming&#039;,
				&#039;event_field_date_format&#039; =&gt; &#039;Y-m-d&#039;,
				&#039;event_display_date_format&#039; =&gt; get_option( &#039;date_format&#039; ),
				&#039;event_use_custom_format&#039; =&gt; &#039;0&#039;,
				&#039;event_custom_date_format&#039; =&gt; &#039;&#039;,
				&#039;event_link_any_user&#039; =&gt; &#039;0&#039;,
				&#039;event_linked_count&#039; =&gt; &#039;5&#039;,
				&#039;event_linked_event_type&#039; =&gt; &#039;upcoming&#039;,
				&#039;event_linked_single_event&#039; =&gt; &#039;0&#039;,
				&#039;event_linked_sortby&#039; =&gt; &#039;latest&#039;,
				&#039;event_linked_listing_view&#039; =&gt; &#039;gridview_onehalf&#039;,
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_event_create_tables() {
		global $wpdb, $plugin_prefix;
		
		if ( self::is_done( &#039;update_200_event_create_tables&#039; ) ) {
			return;
		}
		
		// Event schedule table
		$table = $plugin_prefix . &#039;event_schedule&#039;;

		$wpdb-&gt;query( &quot;ALTER TABLE `{$table}` 
			CHANGE event_date start_date date NOT NULL DEFAULT &#039;0000-00-00&#039;, 
			CHANGE event_enddate end_date date NOT NULL DEFAULT &#039;0000-00-00&#039;, 
			CHANGE event_starttime start_time time NOT NULL DEFAULT &#039;00:00:00&#039;, 
			CHANGE event_endtime end_time time NOT NULL DEFAULT &#039;00:00:00&#039;;&quot; 
		);

		self::update_log( &#039;update_200_event_create_tables&#039; );
	}

	public static function update_200_event_update_version() {
		$version = defined( &#039;GEODIR_EVENT_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_EVENT_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_EVENT_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_event_version&#039; );
		add_option( &#039;geodir_event_version&#039;, $version );

		delete_option( &#039;geodir_event_db_version&#039; );
		add_option( &#039;geodir_event_db_version&#039;, $version );
	}

	// Review Rating
	public static function update_200_rr_get_options( $options = array() ) {
		$merge_options = array(
			&#039;rr_enable_rating&#039; =&gt; get_option( &#039;geodir_reviewrating_enable_rating&#039; ),
			&#039;rr_enable_images&#039; =&gt; get_option( &#039;geodir_reviewrating_enable_images&#039; ),
			&#039;rr_enable_rate_comment&#039; =&gt; get_option( &#039;geodir_reviewrating_enable_review&#039; ),
			&#039;rr_enable_sorting&#039; =&gt; get_option( &#039;geodir_reviewrating_enable_sorting&#039; ),
			&#039;uninstall_geodir_review_rating_manager&#039; =&gt; get_option( &#039;geodir_un_geodir_review_rating_manager&#039; ),
		);

		return array_merge( $options, $merge_options );
	}

	public static function update_200_rr_create_default_options() {
		if ( ! ( defined( &#039;GEODIRREVIEWRATING_VERSION&#039; ) &amp;&amp; version_compare( GEODIRREVIEWRATING_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;rr_enable_rating&#039; =&gt; &#039;0&#039;,
				&#039;rr_enable_images&#039; =&gt; &#039;0&#039;,
				&#039;rr_enable_rate_comment&#039; =&gt; &#039;0&#039;,
				&#039;rr_enable_sorting&#039; =&gt; &#039;0&#039;,
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_rr_create_tables() {
		global $wpdb, $plugin_prefix;
		
		if ( self::is_done( &#039;update_200_rr_create_tables&#039; ) ) {
			return;
		}

		$collate = &#039;&#039;;
		if ( $wpdb-&gt;has_cap( &#039;collation&#039; ) ) {
			$collate = $wpdb-&gt;get_charset_collate();
		}

		// Tables
		$reviews_table = GEODIR_REVIEW_TABLE;
		$rating_style_table = $plugin_prefix . &#039;rating_style&#039;;
		$attachments_table = GEODIR_ATTACHMENT_TABLE;

		if ( ! function_exists( &#039;wp_generate_attachment_metadata&#039; ) ) {
			include_once( ABSPATH . &#039;wp-admin/includes/image.php&#039; );
		}

		$results = $wpdb-&gt;get_results( &quot;SELECT post_id, comment_id, attachments FROM {$reviews_table} WHERE attachments != &#039;&#039; ORDER BY comment_id ASC&quot; );
		if ( ! empty( $results ) ) {
			$last_orders = array();

			foreach ( $results as $row ) {
				$images = explode( &#039;::&#039;, $row-&gt;attachments );
				if ( ! empty( $images ) ) {
					if ( empty( $last_orders[ $row-&gt;post_id ] ) ) {
						$last_order = (int) $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT MAX( menu_order ) FROM {$attachments_table} WHERE post_id = %d&quot;, array( $row-&gt;post_id ) ) );
					} else {
						$last_order = $last_orders[ $row-&gt;post_id ];
					}
					$attachments = array();

					foreach ( $images as $image_src ) {
						$image_src = trim( $image_src );

						if ( ! empty( $image_src ) ) {
							$last_order++;
							$attachment = GeoDir_Media::insert_attachment( $row-&gt;post_id, &#039;comment_images&#039;, $image_src, &#039;&#039;, &#039;&#039;, $last_order, 1, false, $row-&gt;comment_id );
							if ( ! is_wp_error( $attachment ) &amp;&amp; ! empty( $attachment[&#039;ID&#039;] ) ) {
								$attachments[] = $attachment[&#039;ID&#039;];
							}
							$last_orders[ $row-&gt;post_id ] = $last_order;
						}
					}
					$comment_images = ! empty( $attachments ) ? implode( &#039;,&#039;, $attachments ) : &#039;&#039;;

					$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE `{$reviews_table}` SET `attachments` = %s, total_images = %d WHERE comment_id = %d&quot;, array( $comment_images, count( $attachments ), $row-&gt;comment_id ) ) );
				}
			}
		}

		// Rating style
		$wpdb-&gt;query( &quot;ALTER TABLE `{$rating_style_table}` 
			ADD s_rating_icon varchar(100) NOT NULL AFTER `name`, 
			ADD s_rating_type varchar(25) NOT NULL AFTER `name`, 
			ADD star_color_off text NOT NULL AFTER `star_color`;&quot; 
		);

		$results = $wpdb-&gt;get_results( &quot;SELECT id, s_img_off FROM {$rating_style_table} WHERE s_img_off != &#039;&#039; ORDER BY id ASC&quot; );
		if ( ! empty( $results ) ) {
			foreach ( $results as $i =&gt; $row ) {
				$icon = $row-&gt;s_img_off;
				if ( strpos( $icon, &#039;plugins/geodir_review_rating_manager/icons/stars.png&#039; ) !== false ) {
					$icon = GEODIRECTORY_PLUGIN_URL . &#039;/assets/images/stars.png&#039;;
				}
				$attachment_id = self::update_200_generate_attachment_id( $icon );

				if ( ! empty( $attachment_id ) &amp;&amp; ! is_wp_error( $attachment_id ) ) {
					$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE `{$rating_style_table}` SET s_rating_type = &#039;image&#039;, `s_img_off` = %s, `star_color_off` = &#039;#afafaf&#039; WHERE id = %d&quot;, array( $attachment_id, $row-&gt;id ) ) );
				}
			}
		}

		self::update_log( &#039;update_200_rr_create_tables&#039; );
	}

	public static function update_200_rr_update_version() {
		$version = defined( &#039;GEODIR_REVIEWRATING_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_REVIEWRATING_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_REVIEWRATING_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_reviewrating_version&#039; );
		add_option( &#039;geodir_reviewrating_version&#039;, $version );

		delete_option( &#039;geodir_reviewrating_db_version&#039; );
		add_option( &#039;geodir_reviewrating_db_version&#039;, $version );
	}

	// Claim Manager
	public static function update_200_claim_get_options( $options = array() ) {
		$merge_options = array(
			&#039;claim_auto_approve&#039; =&gt; get_option( &#039;geodir_reviewrating_enable_rating&#039; ),
			&#039;claim_show_author_link&#039; =&gt; get_option( &#039;geodir_reviewrating_enable_images&#039; ),
			&#039;claim_force_upgrade&#039; =&gt; get_option( &#039;geodir_claim_force_upgrade&#039; ),
			&#039;uninstall_geodir_claim_listing&#039; =&gt; get_option( &#039;geodir_un_geodir_claim_listing&#039; ),
		);

		return array_merge( $options, $merge_options );
	}

	public static function update_200_claim_create_default_options() {
		if ( ! ( defined( &#039;GEODIRCLAIM_VERSION&#039; ) &amp;&amp; version_compare( GEODIRCLAIM_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;claim_auto_approve&#039; =&gt; &#039;0&#039;,
				&#039;claim_show_author_link&#039; =&gt; &#039;0&#039;,
				&#039;claim_force_upgrade&#039; =&gt; &#039;0&#039;,
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_claim_create_tables() {
		global $wpdb, $plugin_prefix;
		
		if ( self::is_done( &#039;update_200_claim_create_tables&#039; ) ) {
			return;
		}

		$collate = &#039;&#039;;
		if ( $wpdb-&gt;has_cap( &#039;collation&#039; ) ) {
			$collate = $wpdb-&gt;get_charset_collate();
		}

		// Tables
		$claim_table = $plugin_prefix . &#039;claim&#039;;
		$custom_fields_table = GEODIR_CUSTOM_FIELDS_TABLE;

		// Change
		$wpdb-&gt;query( &quot;ALTER TABLE `{$claim_table}` CHANGE `pid` `id` int(11) unsigned NOT NULL AUTO_INCREMENT;&quot; );
		$wpdb-&gt;query( &quot;ALTER TABLE `{$claim_table}`  
			CHANGE `list_id` `post_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;, 
			CHANGE `org_authorid` `author_id` int(11) unsigned NOT NULL DEFAULT &#039;0&#039;, 
			CHANGE `claim_date` `claim_date` datetime NOT NULL,
			ADD `meta` text NOT NULL;&quot; 
		);

		self::update_log( &#039;update_200_claim_create_tables&#039; );
	}

	public static function update_200_claim_update_version() {
		$version = defined( &#039;GEODIR_CLAIM_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_CLAIM_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_CLAIM_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_claim_version&#039; );
		add_option( &#039;geodir_claim_version&#039;, $version );

		delete_option( &#039;geodir_claim_db_version&#039; );
		add_option( &#039;geodir_claim_db_version&#039;, $version );
	}

	// Franchise Manager
	public static function update_200_franchise_get_options( $options = array() ) {
		$merge_options = array(
			&#039;franchise_show_main&#039; =&gt; ! get_option( &#039;geodir_franchise_hide_main_all&#039; ),
			&#039;franchise_show_viewing&#039; =&gt; ! get_option( &#039;geodir_franchise_hide_viewing&#039; ),
			&#039;email_user_franchise_approved&#039; =&gt; 1,
			&#039;email_user_franchise_approved_subject&#039; =&gt; get_option( &#039;geodir_franchise_client_email_subject_payment_franchises&#039; ),
			&#039;email_user_franchise_approved_body&#039; =&gt; get_option( &#039;geodir_franchise_client_email_message_payment_franchises&#039; ),
			&#039;email_bcc_user_franchise_approved&#039; =&gt; get_option( &#039;geodir_franchise_bcc_admin_payment_franchises&#039; ),
			&#039;uninstall_geodir_franchise&#039; =&gt; get_option( &#039;uninstall_geodir_franchise&#039; ),
		);

		return array_merge( $options, $merge_options );
	}

	public static function update_200_franchise_create_default_options() {
		if ( ! ( defined( &#039;GEODIR_FRANCHISE_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_FRANCHISE_VERSION, &#039;2.0.0.0&#039;, &#039;&lt;=&#039; ) ) ) {
			$default_options = array(
				&#039;franchise_show_main&#039; =&gt; 1,
				&#039;franchise_show_viewing&#039; =&gt; 1,
				&#039;email_user_franchise_approved&#039; =&gt; 1,
			);

			foreach ( $default_options as $key =&gt; $value ) {
				geodir_update_option( $key, $value );
			}
		}
	}

	public static function update_200_franchise_custom_fields() {
		global $wpdb, $plugin_prefix;

		if ( self::is_done( &#039;update_200_franchise_custom_fields&#039; ) ) {
			return;
		}

		// Tables
		$custom_fields_table = GEODIR_CUSTOM_FIELDS_TABLE;
		$packages_table = $plugin_prefix . &#039;price&#039;;

		$post_types = (array) get_option( &#039;geodir_franchise_posttypes&#039; );

		if ( ! empty( $post_types ) ) {
			foreach ( $post_types as $post_type ) {
				if ( empty( $post_type ) ) {
					continue;
				}

				$packages = &#039;&#039;;
				if ( self::needs_upgrade( &#039;payment_manager&#039; ) ) {
					$results = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT pid FROM {$packages_table} WHERE post_type = %s&quot;, $post_type ) );
					if ( ! empty( $results ) ) {
						$packages = implode( &#039;,&#039;, $results );
					}
				}

				$fields = array(
					array(
						&#039;post_type&#039; =&gt; $post_type,
						&#039;data_type&#039; =&gt; &#039;TINYINT&#039;, 
						&#039;field_type&#039; =&gt; &#039;radio&#039;, 
						&#039;field_type_key&#039; =&gt; &#039;franchise&#039;, 
						&#039;admin_title&#039; =&gt; &#039;Has Franchise?&#039;, 
						&#039;frontend_desc&#039; =&gt; &#039;Tick &quot;Yes&quot; if listing has franchises.&#039;, 
						&#039;frontend_title&#039; =&gt; &#039;Has Franchise?&#039;, 
						&#039;htmlvar_name&#039; =&gt; &#039;franchise&#039;, 
						&#039;sort_order&#039; =&gt; &#039;0&#039;,
						&#039;option_values&#039; =&gt; &#039;Yes/1,No/0&#039;,
						&#039;clabels&#039; =&gt; &#039;Has Franchise?&#039;,
						&#039;is_active&#039; =&gt; &#039;1&#039;,
						&#039;show_in&#039; =&gt; &#039;&#039;,  
						&#039;packages&#039; =&gt; $packages, 
						&#039;for_admin_use&#039; =&gt; &#039;0&#039;,
						&#039;field_icon&#039; =&gt; &#039;fas fa-sitemap&#039;
					),
					array(
						&#039;post_type&#039; =&gt; $post_type,
						&#039;data_type&#039; =&gt; &#039;TEXT&#039;, 
						&#039;field_type&#039; =&gt; &#039;multiselect&#039;, 
						&#039;field_type_key&#039; =&gt; &#039;franchise_fields&#039;, 
						&#039;admin_title&#039; =&gt; &#039;Lock franchise fields&#039;, 
						&#039;frontend_desc&#039; =&gt; &#039;Select fields to lock from franchise edit.&#039;, 
						&#039;frontend_title&#039; =&gt; &#039;Lock franchise fields&#039;, 
						&#039;htmlvar_name&#039; =&gt; &#039;franchise_fields&#039;, 
						&#039;sort_order&#039; =&gt; &#039;0&#039;,
						&#039;option_values&#039; =&gt; &#039;&#039;,
						&#039;clabels&#039; =&gt; &#039;Lock franchise fields&#039;,
						&#039;is_active&#039; =&gt; &#039;1&#039;, 
						&#039;show_in&#039; =&gt; &#039;&#039;,  
						&#039;packages&#039; =&gt; $packages, 
						&#039;for_admin_use&#039; =&gt; &#039;0&#039;,
						&#039;field_icon&#039; =&gt; &#039;fas fa-sitemap&#039;
					),
					array(
						&#039;post_type&#039; =&gt; $post_type,
						&#039;data_type&#039; =&gt; &#039;INT&#039;, 
						&#039;field_type&#039; =&gt; &#039;text&#039;, 
						&#039;field_type_key&#039; =&gt; &#039;franchise_of&#039;, 
						&#039;admin_title&#039; =&gt; &#039;Main Listing&#039;, 
						&#039;frontend_desc&#039; =&gt; &#039;Enter main listing ID.&#039;, 
						&#039;frontend_title&#039; =&gt; &#039;Main Listing&#039;, 
						&#039;htmlvar_name&#039; =&gt; &#039;franchise_of&#039;, 
						&#039;sort_order&#039; =&gt; &#039;0&#039;,
						&#039;option_values&#039; =&gt; &#039;&#039;,
						&#039;clabels&#039; =&gt; &#039;Main Listing&#039;,
						&#039;is_active&#039; =&gt; &#039;1&#039;, 
						&#039;show_in&#039; =&gt; &#039;[detail]&#039;,  
						&#039;packages&#039; =&gt; $packages, 
						&#039;for_admin_use&#039; =&gt; &#039;1&#039;,
						&#039;field_icon&#039; =&gt; &#039;fas fa-sitemap&#039;
					)
				);

				foreach ( $fields as $field ) {
					$wpdb-&gt;insert( $custom_fields_table, $field, array( &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%d&#039;, &#039;%s&#039; ) );
				}
			}
		}

		self::update_log( &#039;update_200_franchise_custom_fields&#039; );
	}

	public static function update_200_franchise_update_version() {
		$version = defined( &#039;GEODIR_FRANCHISE_VERSION&#039; ) &amp;&amp; version_compare( GEODIR_FRANCHISE_VERSION, &#039;2.0.0.0&#039;, &#039;&gt;=&#039; ) ? GEODIR_FRANCHISE_VERSION : &#039;2.0.0.0&#039;;

		delete_option( &#039;geodir_franchise_version&#039; );
		add_option( &#039;geodir_franchise_version&#039;, $version );

		delete_option( &#039;geodir_franchise_db_version&#039; );
		add_option( &#039;geodir_franchise_db_version&#039;, $version );
	}

	public static function v2_updated() {
		global $wpdb, $plugin_prefix;

		if ( ! self::is_done( &#039;v2_updated_pricemeta_fix_post_images&#039; ) &amp;&amp; get_option( &#039;geodir_pricing_version&#039; ) &amp;&amp; get_option( &#039;geodir_payments_db_version&#039; ) ) {
			$package_meta_table = $plugin_prefix . &#039;pricemeta&#039;;

			$wpdb-&gt;query( &quot;UPDATE `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` SET `sort_order` = &#039;-3&#039; WHERE htmlvar_name = &#039;package_id&#039;&quot; );
			$wpdb-&gt;query( &quot;UPDATE `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` SET `sort_order` = &#039;-2&#039; WHERE htmlvar_name = &#039;expire_date&#039;&quot; );

			$results = $wpdb-&gt;get_results( &quot;SELECT * FROM {$package_meta_table} WHERE meta_key = &#039;exclude_field&#039; AND meta_value LIKE &#039;%post_images%&#039;&quot; );
			if ( ! empty( $results ) ) {
				foreach ( $results as $row ) {
					$meta_value = explode( &quot;::&quot;, $row-&gt;meta_value );
					$index = array_search( &#039;post_images&#039;, $meta_value );
					if ( $index !== false ) {
						unset( $meta_value[ $index ] );
					}
					$meta_value = implode( &quot;::&quot;, $meta_value );

					$wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE `{$package_meta_table}` SET `meta_value` = %s WHERE meta_id = %d&quot;, array( $meta_value, $row-&gt;meta_id ) ) );
				}
			}

			if ( get_option( &#039;geodir_cp_version&#039; ) &amp;&amp; get_option( &#039;geodir_cp_db_version&#039; ) ) {
				$wpdb-&gt;query( &quot;UPDATE `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` SET `sort_order` = &#039;-1&#039; WHERE field_type = &#039;link_posts&#039;&quot; );
			}

			self::update_log( &#039;v2_updated_pricemeta_fix_post_images&#039; );
		}

		if ( get_option( &#039;geodir_franchise_version&#039; ) &amp;&amp; get_option( &#039;geodir_franchise_db_version&#039; ) ) {
			$post_types = get_option( &#039;geodir_franchise_posttypes&#039; );

			if ( ! empty( $post_types ) ) {
				foreach ( $post_types as $post_type ) {
					if ( ! empty( $post_type ) &amp;&amp; ! self::is_done( &#039;v2_updated_franchise_data_&#039; . $post_type ) ) {
						$table = $plugin_prefix . $post_type . &#039;_detail&#039;;
						$results = $wpdb-&gt;get_results( &quot;SELECT p.ID FROM {$wpdb-&gt;posts} AS p LEFT JOIN {$wpdb-&gt;postmeta} AS pm ON pm.post_id = p.ID WHERE p.post_type = &#039;{$post_type}&#039; AND pm.meta_key = &#039;gd_is_franchise&#039; AND pm.meta_value = &#039;1&#039;&quot; );

						if ( ! empty( $results ) ) {
							foreach ( $results as $row ) {
								$data = array();
								$data[&#039;franchise&#039;] = 1;
								$locked_fields = get_post_meta( $row-&gt;ID, &#039;gd_franchise_lock&#039;, true );
								if ( ! empty( $locked_fields ) ) {
									$fields = array();
									foreach ( $locked_fields as $locked_field ) {
										if ( in_array( $locked_field, array( &#039;geodir_contact&#039;, &#039;is_featured&#039; ) ) ) {
											if ( $locked_field == &#039;geodir_contact&#039; ) {
												$locked_field = &#039;phone&#039;;
											}
											if ( $locked_field == &#039;is_featured&#039; ) {
												$locked_field = &#039;featured&#039;;
											}
										}
										if ( strpos( $locked_field, &#039;geodir_&#039; ) === 0 ) {
											$locked_field = strtolower( substr( $locked_field, 7 ) );
										}
										if ( $locked_field == &#039;post&#039; ) {
											$locked_field = &#039;address&#039;;
										} else if ( $locked_field == $post_type . &#039;category&#039; ) {
											$locked_field = &#039;post_category&#039;;
										} else if ( $locked_field == &#039;post_desc&#039; ) {
											$locked_field = &#039;post_content&#039;;
										} else if ( $locked_field == &#039;title&#039; ) {
											$locked_field = &#039;post_title&#039;;
										}
										$fields[] = $locked_field;
									}
									if ( ! empty( $fields ) ) {
										$data[&#039;franchise_fields&#039;] = implode( &#039;,&#039;, $fields );
									}
								}
								$wpdb-&gt;update( $table, $data, array( &#039;post_id&#039; =&gt; $row-&gt;ID ) );
							}
						}

						self::update_log( &#039;v2_updated_franchise_data_&#039; . $post_type );
					}
				}
			}

			delete_option( &#039;geodir_franchise_posttypes&#039; );
		}

		// Convert file fields data.
		self::convert_file_fields();
	}

	public static function convert_file_fields() {
		global $wpdb;

		$post_types = self::v2_post_types( true );

		foreach ( $post_types as $key =&gt; $post_type ) {
			if ( self::is_done( &#039;v2_updated_convert_file_fields_&#039; . $post_type ) ) {
				continue;
			}
	
			$file_fields = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT htmlvar_name FROM `&quot; . GEODIR_CUSTOM_FIELDS_TABLE . &quot;` WHERE post_type = %s AND field_type = %s AND htmlvar_name != %s ORDER BY id ASC&quot;, array( $post_type, &#039;file&#039;, &#039;post_images&#039; ) ) );
			if ( empty( $file_fields ) ) {
				continue;
			}

			$htmlvar_names = array();
			$fields = &#039;pd.post_id, p.post_author, p.post_date_gmt&#039;;
			$where = array();
			foreach ( $file_fields as $field ) {
				if ( ! empty( $field-&gt;htmlvar_name ) ) {
					$htmlvar_names[] = $field-&gt;htmlvar_name;
					$fields .= &#039;, pd.&#039; . $field-&gt;htmlvar_name;
					$where[] = &quot;pd.{$field-&gt;htmlvar_name} != &#039;&#039;&quot;;
				}
			}

			if ( empty( $htmlvar_names ) ) {
				continue;
			}

			$table = geodir_db_cpt_table( $post_type );

			$results = $wpdb-&gt;get_results( &quot;SELECT {$fields} FROM `{$table}` AS pd LEFT JOIN `{$wpdb-&gt;posts}` AS p ON p.ID = pd.post_id WHERE &quot; . implode( &quot; OR &quot;, $where ) . &quot; ORDER BY pd.post_id ASC&quot; );

			if ( empty( $results ) ) {
				continue;
			}

			foreach ( $results as $row ) {
				$save_fields = array();

				foreach ( $htmlvar_names as $htmlvar_name ) {
					$save_field = array();

					if ( ! empty( $row-&gt;{$htmlvar_name} ) &amp;&amp; strpos( $row-&gt;{$htmlvar_name}, &quot;|&quot; ) === false &amp;&amp; ( $items = explode( &quot;::&quot;, trim( $row-&gt;{$htmlvar_name} ) ) ) ) {
						$order = 0;

						foreach ( $items as $item_url ) {
							$item_url = trim( $item_url );

							if ( ! empty( $item_url ) ) {
								$order++;
								$relative_url = geodir_file_relative_url( $item_url );
								$full_relative_url = geodir_file_relative_url( $item_url, true );
								$filetype = wp_check_filetype( $full_relative_url );

								$insert_data = array(
									&#039;post_id&#039; =&gt; $row-&gt;post_id,
									&#039;date_gmt&#039; =&gt; $row-&gt;post_date_gmt,
									&#039;user_id&#039; =&gt; $row-&gt;post_author,
									&#039;title&#039; =&gt; &#039;&#039;,
									&#039;caption&#039; =&gt; &#039;&#039;,
									&#039;file&#039; =&gt; ( $relative_url != &#039;&#039; &amp;&amp; strpos( &quot;/&quot;, $relative_url ) !== 0 ? &quot;/&quot; . $relative_url : $relative_url ),
									&#039;mime_type&#039; =&gt; ( ! empty( $filetype ) &amp;&amp; ! empty( $filetype[&#039;type&#039;] ) ? $filetype[&#039;type&#039;] : &#039;&#039; ),
									&#039;menu_order&#039; =&gt; ( $order - 1 ),
									&#039;featured&#039; =&gt; 0,
									&#039;is_approved&#039; =&gt; 1,
									&#039;metadata&#039; =&gt; &#039;&#039;,
									&#039;type&#039; =&gt; $htmlvar_name,
									&#039;other_id&#039; =&gt; 0
								);

								$result = $wpdb-&gt;insert(
									GEODIR_ATTACHMENT_TABLE,
									$insert_data,
									array(
										&#039;%d&#039;,
										&#039;%s&#039;,
										&#039;%d&#039;,
										&#039;%s&#039;,
										&#039;%s&#039;,
										&#039;%s&#039;,
										&#039;%s&#039;,
										&#039;%d&#039;,
										&#039;%d&#039;,
										&#039;%d&#039;,
										&#039;%s&#039;,
										&#039;%s&#039;,
										&#039;%d&#039;
									)
								);
								$insert_id = $result &amp;&amp; ! empty( $wpdb-&gt;insert_id ) ? $wpdb-&gt;insert_id : 0;

								if ( $insert_id ) {
									$save_field[] = $full_relative_url . &#039;|&#039; . $insert_id . &#039;||&#039;;
								}
							}
						}
					}

					if ( ! empty( $save_field ) ) {
						$save_fields[ $htmlvar_name ] = implode( &quot;,&quot;, $save_field );
					}
				}

				if ( ! empty( $save_fields ) ) {
					$wpdb-&gt;update( $table, $save_fields, array( &#039;post_id&#039; =&gt; $row-&gt;post_id ) );
				}
			}

			self::update_log( &#039;v2_updated_convert_file_fields_&#039; . $post_type );
		}
	}

	public static function v1_post_types() {
		$post_types = array();

		// Post types from v1 option
		$v1_post_types = get_option( &#039;geodir_post_types&#039; );
		if ( ! empty( $v1_post_types ) ) {
			foreach ( $v1_post_types as $post_type =&gt; $data ) {
				if ( ! empty( $post_type ) ) {
					$post_types[ $post_type ] = $data;
				}
			}
		}

		// Post types from v2 option
		$v2_post_types = geodir_get_option( &#039;post_types&#039; );
		if ( ! empty( $v2_post_types ) ) {
			foreach ( $v2_post_types as $post_type =&gt; $data ) {
				if ( ! empty( $post_type ) &amp;&amp; empty( $post_types[ $post_type ] ) ) {
					$post_types[ $post_type ] = $data;
				}
			}
		}

		return $post_types;
	}

	public static function v1_taxonomies() {
		$taxonomies = array();

		// Taxonomies from v1 option
		$v1_taxonomies = get_option( &#039;geodir_taxonomies&#039; );
		if ( ! empty( $v1_taxonomies ) ) {
			foreach ( $v1_taxonomies as $taxonomy =&gt; $data ) {
				if ( ! empty( $taxonomy ) ) {
					$taxonomies[ $taxonomy ] = $data;
				}
			}
		}

		// Taxonomies from v2 option
		$v2_taxonomies = geodir_get_option( &#039;taxonomies&#039; );
		if ( ! empty( $v2_taxonomies ) ) {
			foreach ( $v2_taxonomies as $taxonomy =&gt; $data ) {
				if ( ! empty( $taxonomy ) &amp;&amp; empty( $taxonomies[ $taxonomy ] ) ) {
					$taxonomies[ $taxonomy ] = $data;
				}
			}
		}

		return $taxonomies;
	}

	public static function v2_post_types( $names = false ) {
		$post_types = geodir_get_option( &#039;post_types&#039; );

		if ( empty( $post_types ) ) {
			return array();
		}

		if ( $names ) {
			$post_types = array_keys( $post_types );
		}

		return $post_types;
	}

	public static function is_done( $task ) {
		if ( empty( $task ) ) {
			return false;
		}

		$log = get_option( &#039;geodir_v2_upgrade&#039; );

		if ( is_array( $log ) &amp;&amp; ! empty( $log[ $task ] ) ) {
			geodir_error_log( $task, &#039;Skip&#039;, __FILE__, __LINE__ );
			return true;
		}

		return false;
	}

	public static function update_log( $task ) {
		if ( empty( $task ) ) {
			return false;
		}

		$log = get_option( &#039;geodir_v2_upgrade&#039; );

		if ( ! is_array( $log ) ) {
			$log = array();
		}

		if ( ! empty( $log[ $task ] ) ) {
			return true;
		}

		$log[ $task ] = 1;

		update_option( &#039;geodir_v2_upgrade&#039;, $log );

		return true;
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>Geodirectory Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on May 12th, 2022 at 06:28 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1652336885"></script>
    <script src="../js/search.js?updated=1652336885"></script>
</body>
</html>
